<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上鋼琴 (專業版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            touch-action: manipulation;
            background-color: #111827; /* 深灰藍背景 */
        }
        /* 琴鍵的3D效果和按下動畫 */
        .key {
            transition: all 0.05s ease-in-out;
            cursor: pointer;
            position: relative; /* 為了讓鍵盤文字定位 */
        }
        .key.white {
            background: linear-gradient(to bottom, #f9fafb, #e5e7eb);
            border: 1px solid #9ca3af;
            border-top: none;
            box-shadow: inset 0 1px 0 white, 0 5px 3px -3px rgba(0,0,0,0.5), inset 0 -4px 5px rgba(0,0,0,0.1);
        }
        .key.black {
            background: linear-gradient(to bottom, #27272a, #18181b);
            border: 1px solid #000;
            box-shadow: inset 0 -1px 2px rgba(255,255,255,0.2), 0 3px 5px -2px rgba(0,0,0,0.8);
            z-index: 10;
        }
        .key.white.active {
            background: linear-gradient(to bottom, #e5e7eb, #d1d5db);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            transform: translateY(2px);
        }
        .key.black.active {
            background: linear-gradient(to bottom, #18181b, #111);
            box-shadow: inset 0 -1px 1px rgba(255,255,255,0.2), 0 1px 1px rgba(0,0,0,0.5);
            transform: translate(-50%, 2px); /* 按下時也要保持置中 */
        }
        
        /* 黑鍵定位的關鍵CSS */
        .key.black {
            position: absolute;
            top: 0;
            left: 100%; /* 定位到其父元素(白鍵)的右邊緣 */
            transform: translateX(-50%); /* 向左移動自身寬度的一半，實現置中 */
        }

        /* 控制面板樣式 */
        #control-panel {
            font-family: 'Orbitron', sans-serif; /* 使用科技感的字體 */
        }
        #note-display {
            background-color: #000;
            border: 2px solid #4b5563;
            box-shadow: inset 0 0 10px #000;
            text-shadow: 0 0 5px #fbbf24, 0 0 10px #fbbf24;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- 鋼琴主體容器 -->
    <div id="piano-body" class="w-full max-w-7xl bg-black rounded-xl shadow-2xl border-t-2 border-gray-700">
        
        <!-- 控制面板 -->
        <div id="control-panel" class="h-28 sm:h-32 bg-gradient-to-b from-gray-800 to-gray-900 p-4 flex items-center justify-between rounded-t-lg border-b-4 border-black">
            <div class="text-white text-2xl font-bold">
                <span class="text-yellow-400">VIRTUAL</span><span class="text-gray-400">PIANO</span>
            </div>
            <!-- 音符顯示幕 -->
            <div id="note-display" class="w-48 h-16 bg-black rounded-md flex items-center justify-center text-amber-400 text-4xl font-bold tracking-widest">
                - - -
            </div>
            <div class="text-gray-600 text-2xl font-bold">
                PRO
            </div>
        </div>

        <!-- 琴鍵容器 -->
        <main class="relative p-2 sm:p-4 md:p-6 bg-gray-900 rounded-b-xl">
            <!-- 音色載入提示 -->
            <div id="loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-20 rounded-b-xl transition-opacity duration-300">
                <div class="text-center">
                    <svg class="animate-spin h-8 w-8 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-white text-lg font-semibold">正在加載鋼琴音色...</p>
                </div>
            </div>

            <div id="piano" class="flex justify-center select-none h-48 sm:h-56">
                <!-- 琴鍵將由 JavaScript 動態生成 -->
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素 ---
            const pianoContainer = document.getElementById('piano');
            const loadingOverlay = document.getElementById('loading-overlay');
            const noteDisplay = document.getElementById('note-display');
            let sampler;

            // 36個琴鍵的資料
            const keysData = [
                { note: 'C3', key: '1', type: 'white' }, { note: 'Db3', key: '!', type: 'black' },
                { note: 'D3', key: '2', type: 'white' }, { note: 'Eb3', key: '@', type: 'black' },
                { note: 'E3', key: '3', type: 'white' }, { note: 'F3', key: '4', type: 'white' },
                { note: 'Gb3', key: '$', type: 'black' }, { note: 'G3', key: '5', type: 'white' },
                { note: 'Ab3', key: '%', type: 'black' }, { note: 'A3', key: '6', type: 'white' },
                { note: 'Bb3', key: '^', type: 'black' }, { note: 'B3', key: '7', type: 'white' },
                { note: 'C4', key: '8', type: 'white' }, { note: 'Db4', key: '*', type: 'black' },
                { note: 'D4', key: '9', type: 'white' }, { note: 'Eb4', key: '(', type: 'black' },
                { note: 'E4', key: '0', type: 'white' }, { note: 'F4', key: 'q', type: 'white' },
                { note: 'Gb4', key: 'w', type: 'black' }, { note: 'G4', key: 'e', type: 'white' },
                { note: 'Ab4', key: 'r', type: 'black' }, { note: 'A4', key: 't', type: 'white' },
                { note: 'Bb4', key: 'y', type: 'black' }, { note: 'B4', key: 'u', type: 'white' },
                { note: 'C5', key: 'i', type: 'white' }, { note: 'Db5', key: 'o', type: 'black' },
                { note: 'D5', key: 'p', type: 'white' }, { note: 'Eb5', key: 'g', type: 'black' },
                { note: 'E5', key: 'h', type: 'white' }, { note: 'F5', key: 'j', type: 'white' },
                { note: 'Gb5', key: 'l', type: 'black' }, { note: 'G5', key: 'z', type: 'white' },
                { note: 'Ab5', key: 'x', type: 'black' }, { note: 'A5', key: 'c', type: 'white' },
                { note: 'Bb5', key: 'v', type: 'black' }, { note: 'B5', key: 'b', type: 'white' },
            ];

            // --- 初始化函式 ---
            function createPianoKeys() {
                const whiteKeys = [];
                keysData.forEach(keyInfo => {
                    if (keyInfo.type === 'white') {
                        const keyElement = createKeyElement(keyInfo);
                        pianoContainer.appendChild(keyElement);
                        whiteKeys.push(keyElement);
                    }
                });
                let whiteKeyIndex = 0;
                keysData.forEach(keyInfo => {
                    if (keyInfo.type === 'white') {
                         const nextKey = keysData[keysData.indexOf(keyInfo) + 1];
                         if (nextKey && nextKey.type === 'white') {
                             whiteKeyIndex++;
                         }
                    } else if (keyInfo.type === 'black') {
                        const keyElement = createKeyElement(keyInfo);
                        if (whiteKeys[whiteKeyIndex]) {
                            whiteKeys[whiteKeyIndex].appendChild(keyElement);
                        }
                        whiteKeyIndex++;
                    }
                });
            }

            function createKeyElement(keyInfo) {
                const keyElement = document.createElement('div');
                keyElement.dataset.note = keyInfo.note;
                keyElement.dataset.key = keyInfo.key;
                keyElement.classList.add('key', keyInfo.type);
                if (keyInfo.type === 'white') {
                    keyElement.classList.add('h-full', 'w-8', 'sm:w-10', 'rounded-b-md');
                } else {
                    keyElement.classList.add('h-2/3', 'w-6', 'sm:w-7', 'rounded-b-md');
                }
                const keyText = document.createElement('span');
                keyText.textContent = keyInfo.key;
                keyText.classList.add('absolute', 'bottom-2', 'left-1/2', '-translate-x-1/2', 'font-semibold', 'pointer-events-none');
                if (keyInfo.type === 'white') {
                    keyText.classList.add('text-gray-500');
                } else {
                    keyText.classList.add('text-gray-300');
                }
                keyElement.appendChild(keyText);
                return keyElement;
            }

            function setupAudio() {
                sampler = new Tone.Sampler({
                    urls: {
                        'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3',
                        'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3', 'A4': 'A4.mp3',
                        'C5': 'C5.mp3', 'D#5': 'Ds5.mp3', 'F#5': 'Fs5.mp3', 'A5': 'A5.mp3',
                    },
                    baseUrl: 'https://tonejs.github.io/audio/salamander/',
                    onload: () => {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
                    }
                }).toDestination();
            }

            // --- 核心功能 ---
            function playNote(note) {
                if (!sampler || !sampler.loaded) return;
                sampler.triggerAttack(note);
                updateNoteDisplay(note);
                const keyElement = pianoContainer.querySelector(`[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.add('active');
                    setTimeout(() => { keyElement.classList.remove('active'); }, 150);
                }
            }

            function updateNoteDisplay(note) {
                const formattedNote = note.replace('b', '♭').replace('#', '♯');
                noteDisplay.textContent = formattedNote;
            }

            // --- 事件監聽 ---
            function addPointerListeners() {
                pianoContainer.addEventListener('pointerdown', (e) => {
                    if (!sampler || !sampler.loaded) return;
                    const keyElement = e.target.closest('.key');
                    if (keyElement) {
                        if (Tone.context.state !== 'running') { Tone.start(); }
                        const note = keyElement.dataset.note;
                        playNote(note);
                    }
                });
            }

            // [MODIFIED] 全新、更穩定的鍵盤監聽邏輯
            function addKeyboardListeners() {
                const noteMap = new Map(keysData.map(k => [k.key, k.note]));
                const pressedKeys = new Set(); // 使用 e.code 來追蹤物理按鍵

                window.addEventListener('keydown', (e) => {
                    if (!sampler || !sampler.loaded) return;
                    if (Tone.context.state !== 'running') { Tone.start(); }
                    
                    // 使用 e.code 來防止按住按鍵時重複觸發
                    if (pressedKeys.has(e.code)) return;

                    // 使用 e.key 來查找對應的音符 (e.key 會處理 Shift 和大小寫)
                    const note = noteMap.get(e.key);
                    
                    if (note) {
                        e.preventDefault();
                        pressedKeys.add(e.code); // 記錄被按下的物理按鍵
                        playNote(note);
                    }
                });

                window.addEventListener('keyup', (e) => {
                    // 釋放被按下的物理按鍵
                    pressedKeys.delete(e.code);
                });
            }

            // --- 啟動 ---
            function initialize() {
                createPianoKeys();
                setupAudio();
                addPointerListeners();
                addKeyboardListeners();
            }

            initialize();
        });
    </script>
</body>
</html>
