<div id="ppm-converter-app">
  
  <h3>PPM Converter</h3>
  
  <div class="ppmc-section">
    <h4>Aqueous Solutions (Dilute)</h4>
    <small class="ppmc-assumption">Assumes density ≈ 1 kg/L (like water)</small>
    <div class="ppmc-input-group">
      <label for="ppmc-ppm-aq">Parts Per Million (PPM)</label>
      <div class="ppmc-input-wrapper">
        <input type="text" class="ppmc-input" id="ppmc-ppm-aq" data-group="aq" data-type="ppm" placeholder="Enter PPM...">
         <span class="ppmc-unit-display">PPM</span>
      </div>
    </div>
    <div class="ppmc-input-group">
      <label for="ppmc-mgl-aq">Milligrams per Liter (mg/L)</label>
      <div class="ppmc-input-wrapper">
        <input type="text" class="ppmc-input" id="ppmc-mgl-aq" data-group="aq" data-type="mgl" placeholder="Enter mg/L...">
         <span class="ppmc-unit-display">mg/L</span>
      </div>
    </div>
  </div>
  
  <div class="ppmc-section">
     <h4>Solids / Mixtures (by mass)</h4>
      <small class="ppmc-assumption">Mass fraction based</small>
     <div class="ppmc-input-group">
      <label for="ppmc-ppm-solid">Parts Per Million (PPM)</label>
      <div class="ppmc-input-wrapper">
        <input type="text" class="ppmc-input" id="ppmc-ppm-solid" data-group="solid" data-type="ppm" placeholder="Enter PPM...">
         <span class="ppmc-unit-display">PPM</span>
      </div>
    </div>
    <div class="ppmc-input-group">
      <label for="ppmc-mgkg-solid">Milligrams per Kilogram (mg/kg)</label>
      <div class="ppmc-input-wrapper">
        <input type="text" class="ppmc-input" id="ppmc-mgkg-solid" data-group="solid" data-type="mgkg" placeholder="Enter mg/kg...">
         <span class="ppmc-unit-display">mg/kg</span>
      </div>
    </div>
  </div>

   <div id="ppmc-message-area" class="ppmc-message"></div>

</div>

<style>
/* --- 
   PPM Converter 樣式表 (V1.1)
   (CSS 樣式與 V1.0 完全相同)
--- */

#ppm-converter-app {
  background: #ffffff !important;
  border: 1px solid #e2e8f0 !important;
  border-radius: 10px !important;
  padding: 24px !important;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
  max-width: 500px !important; 
  margin: 25px auto !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif !important;
  box-sizing: border-box !important;
}

#ppm-converter-app *,
#ppm-converter-app *::before,
#ppm-converter-app *::after {
  box-sizing: inherit !important;
}

#ppm-converter-app h3 {
  color: #B45309 !important;
  font-size: 24px !important;
  font-weight: 700 !important;
  margin-top: 0 !important;
  margin-bottom: 24px !important;
  text-align: center !important;
  line-height: 1.3 !important;
}

#ppm-converter-app .ppmc-section {
  border: 1px solid #e2e8f0 !important;
  border-radius: 8px !important;
  padding: 16px !important;
  margin-bottom: 20px !important;
}
#ppm-converter-app .ppmc-section h4 {
  font-size: 16px !important;
  font-weight: 600 !important;
  color: #334155 !important;
  margin-top: 0 !important;
  margin-bottom: 4px !important; 
  text-align: center !important;
}
#ppm-converter-app .ppmc-assumption {
    display: block !important;
    text-align: center !important;
    font-size: 12px !important;
    color: #64748b !important;
    margin-bottom: 16px !important;
}


#ppm-converter-app .ppmc-input-group {
  margin-bottom: 12px !important;
}
#ppm-converter-app .ppmc-input-group:last-child {
  margin-bottom: 0 !important;
}

#ppm-converter-app label {
  display: block !important;
  font-size: 14px !important; 
  font-weight: 600 !important;
  color: #475569 !important;
  margin-bottom: 6px !important;
}

#ppm-converter-app .ppmc-input-wrapper {
  display: flex !important;
  align-items: center !important;
  border: 1px solid #cbd5e1 !important;
  border-radius: 8px !important;
  background-color: #f8fafc !important;
  transition: border-color 0.2s, box-shadow 0.2s !important;
}
#ppm-converter-app .ppmc-input-wrapper:focus-within {
  border-color: #0284c7 !important;
  box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15) !important;
}

#ppm-converter-app .ppmc-input {
  flex-grow: 1 !important;
  width: 100% !important; 
  padding: 10px 12px !important;
  font-size: 16px !important;
  font-family: 'Courier New', Courier, monospace !important; 
  font-weight: 600 !important;
  color: #0f172a !important;
  border: none !important;
  background: transparent !important;
  box-shadow: none !important;
  outline: none !important;
  margin: 0 !important;
  border-radius: 8px 0 0 8px !important; 
}

#ppm-converter-app .ppmc-unit-display {
  padding: 10px 12px !important;
  font-size: 14px !important;
  font-family: inherit !important;
  font-weight: 500 !important;
  color: #475569 !important;
  background-color: #eef2f6 !important; 
  border: none !important;
  border-left: 1px solid #cbd5e1 !important;
  border-radius: 0 7px 7px 0 !important; 
  margin: 0 !important;
  box-shadow: none !important;
  outline: none !important;
  display: flex !important; 
  align-items: center !important;
  justify-content: center !important;
  min-width: 65px; 
  text-align: center;
  white-space: nowrap;
}

#ppm-converter-app .ppmc-message {
  font-size: 14px !important;
  font-weight: 500 !important;
  padding: 6px 4px 0 4px !important;
  min-height: 1.4em !important; 
  color: #dc2626 !important; 
  text-align: center !important;
}

</style>

<script>
// Core Spec: IIFE
(function() {

  /**
   * App Main Execution
   */
  function initializePpmConverter() {
  
    // --- Get DOM Elements ---
    const appContainer = document.getElementById('ppm-converter-app');
    if (!appContainer) return;
    
    // Aqueous Group
    const ppmAqInput = appContainer.querySelector('#ppmc-ppm-aq');
    const mglAqInput = appContainer.querySelector('#ppmc-mgl-aq');
    // Solid Group
    const ppmSolidInput = appContainer.querySelector('#ppmc-ppm-solid');
    const mgkgSolidInput = appContainer.querySelector('#ppmc-mgkg-solid');
    
    const messageArea = appContainer.querySelector('#ppmc-message-area');
    
    // Failsafe check
    if (!ppmAqInput || !mglAqInput || !ppmSolidInput || !mgkgSolidInput || !messageArea) {
        console.error('PPM Converter: Missing UI elements.');
        return;
    }

    const allInputs = [ppmAqInput, mglAqInput, ppmSolidInput, mgkgSolidInput];
    let isCalculating = false; // Prevent infinite loops

    /**
     * Helper: Parse input string (allows scientific notation)
     */
    function parseValue(inputStr) {
        const cleanedStr = inputStr.trim().toLowerCase();
        if (cleanedStr === '') return NaN;
        const value = parseFloat(cleanedStr);
        return (isNaN(value) || !isFinite(value)) ? NaN : value; 
    }

    /**
     * Helper: Format output value
     */
    function formatValue(value) {
        if (isNaN(value)) return ''; 
        if (value === 0) return '0';
        if (Math.abs(value) >= 1e7 || (Math.abs(value) < 1e-4 && Math.abs(value) > 0)) {
            return value.toExponential(4); 
        } else {
             let decimals = 4;
             if (Math.abs(value) > 1000) decimals = 2;
             else if (Math.abs(value) > 10) decimals = 3;
            // Use toPrecision for better handling across magnitudes
            return value.toPrecision(5); 
        }
    }
    
    /**
     * Core Function V1.1: Calculate and update linked fields (Fixed isCalculating bug)
     * @param {HTMLInputElement} sourceInput - The input field that triggered the change
     */
    function calculate(sourceInput) {
        if (isCalculating) return; 
        isCalculating = true;
        messageArea.textContent = ''; // Clear errors

        try {
            const group = sourceInput.dataset.group; // 'aq' or 'solid'
            const type = sourceInput.dataset.type;   // 'ppm', 'mgl', 'mgkg'
            const value = parseValue(sourceInput.value);
            
            let targetInput = null;
            if (group === 'aq') {
                targetInput = (type === 'ppm' ? mglAqInput : ppmAqInput);
            } else { // solid
                targetInput = (type === 'ppm' ? mgkgSolidInput : ppmSolidInput);
            }

            // --- V1.1 Fix: Simplified Validation ---
            if (isNaN(value)) {
                 if (sourceInput.value.trim() !== '') {
                     messageArea.textContent = 'Invalid number format.';
                 }
                 if (targetInput) { targetInput.value = ''; } // Clear target if source invalid
                 // DO NOT return here, let finally execute
            } else if (value < 0) {
                 messageArea.textContent = 'Concentration cannot be negative.';
                 if (targetInput) { targetInput.value = ''; } // Clear target if source invalid
                 // DO NOT return here, let finally execute
            } else {
                // --- Core Logic (only execute if valid) ---
                if (group === 'aq') {
                    if (type === 'ppm') {
                        mglAqInput.value = formatValue(value); // mg/L = PPM
                    } else { // type === 'mgl'
                        ppmAqInput.value = formatValue(value); // PPM = mg/L
                    }
                } else { // group === 'solid'
                     if (type === 'ppm') {
                        mgkgSolidInput.value = formatValue(value); // mg/kg = PPM
                    } else { // type === 'mgkg'
                        ppmSolidInput.value = formatValue(value); // PPM = mg/kg
                    }
                }
            }

        } catch (e) {
            console.error("PPM Converter Error:", e);
            messageArea.textContent = "Calculation error.";
            // Clear all fields on major error
             ppmAqInput.value = ''; mglAqInput.value = '';
             ppmSolidInput.value = ''; mgkgSolidInput.value = '';
        } finally {
            isCalculating = false; // Release the lock **ALWAYS**
        }
    }

    // --- Attach Event Listeners ---
    allInputs.forEach(input => {
        // Use closure to capture the correct input element
        (function(el) {
             el.addEventListener('input', () => calculate(el)); 
        })(input);
    });
    
  } // End initializePpmConverter

  
  // --- Robust Startup Logic ---
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePpmConverter);
  } else {
    initializePpmConverter();
  }

})(); // End IIFE
</script>
