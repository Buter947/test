<div id="warikan-fixed-app-jp"> 
    <style>
        /* --- CSS (與 V10 相同) --- */
        #warikan-fixed-app-jp { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important; line-height: 1.6 !important; background-color: #ffffff !important; border: 1px solid #e5e7eb !important; border-radius: 0.75rem !important; padding: 2rem !important; margin: 2rem auto !important; max-width: 700px !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05) !important; overflow: hidden; }
        #warikan-fixed-app-jp *, #warikan-fixed-app-jp *::before, #warikan-fixed-app-jp *::after { box-sizing: border-box !important; margin: 0; padding: 0; }
        #warikan-fixed-app-jp h2 { color: #B45309 !important; text-align: center !important; font-size: 1.75rem !important; font-weight: 700 !important; margin-bottom: 0.5rem !important; }
        #warikan-fixed-app-jp .warikan-fx-subtitle { text-align: center !important; font-size: 1rem !important; color: #4b5563 !important; margin-bottom: 2rem !important; }
        #warikan-fixed-app-jp .warikan-fx-input-group label { display: block !important; font-weight: 600 !important; color: #374151 !important; margin-bottom: 0.5rem !important; font-size: 0.9rem !important; }
        #warikan-fixed-app-jp .warikan-fx-input, #warikan-fixed-app-jp .warikan-fx-select { width: 100% !important; padding: 0.75rem 1rem !important; border: 1px solid #d1d5db !important; border-radius: 0.5rem !important; font-size: 1rem !important; line-height: 1.5 !important; background-color: #fff !important; color: #1f2937 !important; -webkit-appearance: none !important; appearance: none !important; }
        #warikan-fixed-app-jp .warikan-fx-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important; background-position: right 0.5rem center !important; background-repeat: no-repeat !important; background-size: 1.5em 1.5em !important; padding-right: 2.5rem !important; }
        #warikan-fixed-app-jp h3 { font-size: 1.25rem !important; font-weight: 600 !important; color: #1f2937 !important; margin-top: 2rem !important; margin-bottom: 1rem !important; padding-bottom: 0.5rem !important; border-bottom: 1px solid #e5e7eb !important; }
        #warikan-fixed-app-jp .warikan-fx-group-row { display: grid !important; grid-template-columns: 1fr 80px 80px !important; gap: 0.75rem !important; align-items: center !important; margin-bottom: 1rem !important; padding-bottom: 1rem !important; border-bottom: 1px dotted #d1d5db !important; }
        #warikan-fixed-app-jp .warikan-fx-group-row:last-child { border-bottom: none !important; margin-bottom: 0 !important; }
        #warikan-fixed-app-jp .warikan-fx-group-row label { display: none !important; }
        #warikan-fixed-app-jp .warikan-fx-group-name { width: 100% !important; background-color: #f3f4f6 !important; border: 1px solid #e5e7eb !important; font-weight: 500 !important; color: #374151 !important; cursor: default !important; padding: 0.75rem 1rem !important; border-radius: 0.5rem !important; } 
        #warikan-fixed-app-jp .warikan-fx-group-people, #warikan-fixed-app-jp .warikan-fx-group-ratio { width: 100% !important; text-align: right !important; }
        #warikan-fixed-app-jp .warikan-fx-people-summary { font-size: 0.95rem !important; font-weight: 600 !important; text-align: right !important; color: #4b5563 !important; margin-top: 1rem !important; }
        #warikan-fixed-app-jp .warikan-fx-people-summary span { color: #1f2937 !important; } 
        #warikan-fixed-app-jp .warikan-fx-calculate-btn { display: block !important; width: 100% !important; max-width: 300px !important; margin: 2.5rem auto 0 auto !important; padding: 1rem !important; font-size: 1.25rem !important; font-weight: 700 !important; color: #ffffff !important; background-color: #B45309 !important; border: none !important; border-radius: 0.5rem !important; cursor: pointer !important; transition: background-color 0.2s, transform 0.1s !important; }
        #warikan-fixed-app-jp .warikan-fx-calculate-btn:hover { background-color: #92400e !important; }
        #warikan-fixed-app-jp .warikan-fx-calculate-btn:active { transform: scale(0.98) !important; }
        #warikan-fixed-app-jp .warikan-fx-error-message { color: #b91c1c !important; background-color: #fee2e2 !important; border: 1px solid #f87171 !important; padding: 1rem !important; border-radius: 0.5rem !important; text-align: center !important; margin-top: 1.5rem !important; display: none; animation: fadeInWarikanFxV1 0.3s ease-out !important; }
        #warikan-fixed-app-jp .warikan-fx-results-area { margin-top: 2.5rem !important; padding-top: 2rem !important; border-top: 2px solid #B45309 !important; display: none; animation: fadeInWarikanFxV1 0.3s ease-out !important; } 
        @keyframes fadeInWarikanFxV1 { from { opacity: 0; } to { opacity: 1; } }
        #warikan-fixed-app-jp .warikan-fx-results-area h3 { text-align: center !important; margin-bottom: 1.5rem !important; }
        #warikan-fixed-app-jp .warikan-fx-result-group { background-color: #f9fafb !important; border: 1px solid #e5e7eb !important; border-radius: 0.5rem !important; padding: 1.5rem !important; margin-bottom: 1rem !important; }
        #warikan-fixed-app-jp .warikan-fx-result-group-header { font-weight: 600 !important; color: #111827 !important; margin-bottom: 0.75rem !important; font-size: 1.1rem !important; }
        #warikan-fixed-app-jp .warikan-fx-result-details { display: flex !important; justify-content: space-between !important; align-items: baseline !important; font-size: 1rem !important; color: #374151 !important; margin-bottom: 0.5rem !important; }
        #warikan-fixed-app-jp .warikan-fx-result-details .amount { font-size: 1.25rem !important; font-weight: 600 !important; color: #B45309 !important; }
        #warikan-fixed-app-jp .warikan-fx-result-summary { margin-top: 2rem !important; padding-top: 1rem !important; border-top: 1px dashed #d1d5db !important; font-size: 1.1rem !important; font-weight: 600 !important; text-align: right !important; color: #1f2937 !important; }
        #warikan-fixed-app-jp .warikan-fx-result-summary div { margin-bottom: 0.5rem !important; }
        #warikan-fixed-app-jp .warikan-fx-result-summary .total-collected { color: #059669 !important; }
        #warikan-fixed-app-jp .warikan-fx-result-summary .difference { color: #ca8a04 !important; }
        @media (max-width: 640px) { #warikan-fixed-app-jp { padding: 1.5rem !important; } #warikan-fixed-app-jp h2 { font-size: 1.5rem !important; } #warikan-fixed-app-jp .warikan-fx-group-row { grid-template-columns: 1fr 65px 65px !important; gap: 0.5rem !important; } #warikan-fixed-app-jp .warikan-fx-group-people, #warikan-fixed-app-jp .warikan-fx-group-ratio { font-size: 0.9rem !important; padding: 0.6rem !important; } }
        @media (max-width: 420px) { #warikan-fixed-app-jp .warikan-fx-group-row { grid-template-columns: 1fr 55px 55px !important; } #warikan-fixed-app-jp .warikan-fx-group-people, #warikan-fixed-app-jp .warikan-fx-group-ratio { padding: 0.5rem 0.4rem !important; } }
    </style>

    <h2>飲み会 割り勘 計算機 <span style="font-size: 1rem; color: #6b7280;">(固定グループ版)</span></h2>
    <p class="warikan-fx-subtitle">人数と比率を調整して公平な割り勘計算を！</p>
    <div class="warikan-fx-input-group" style="margin-bottom: 2rem;"> <label for="warikan-fx-total-amount">支払総額 (円)</label> <input type="number" id="warikan-fx-total-amount" class="warikan-fx-input" placeholder="例: 30000" min="0" step="1"> </div>
    <h3>グループ分けと比率設定</h3>
    <div id="warikan-fx-groups-container">
        <div class="warikan-fx-group-row"> <input type="text" id="group-name-0" class="warikan-fx-input warikan-fx-group-name" value="上司" readonly> <input type="number" id="group-people-0" class="warikan-fx-input warikan-fx-group-people" placeholder="0" value="0" min="0" step="1"> <input type="number" id="group-ratio-0" class="warikan-fx-input warikan-fx-group-ratio" value="1.5" step="0.1" min="0"> </div>
        <div class="warikan-fx-group-row"> <input type="text" id="group-name-1" class="warikan-fx-input warikan-fx-group-name" value="先輩" readonly> <input type="number" id="group-people-1" class="warikan-fx-input warikan-fx-group-people" placeholder="0" value="0" min="0" step="1"> <input type="number" id="group-ratio-1" class="warikan-fx-input warikan-fx-group-ratio" value="1.2" step="0.1" min="0"> </div>
        <div class="warikan-fx-group-row"> <input type="text" id="group-name-2" class="warikan-fx-input warikan-fx-group-name" value="一般" readonly> <input type="number" id="group-people-2" class="warikan-fx-input warikan-fx-group-people" placeholder="人数" value="1" min="0" step="1"> <input type="number" id="group-ratio-2" class="warikan-fx-input warikan-fx-group-ratio" value="1.0" step="0.1" min="0"> </div>
        <div class="warikan-fx-group-row"> <input type="text" id="group-name-3" class="warikan-fx-input warikan-fx-group-name" value="後輩" readonly> <input type="number" id="group-people-3" class="warikan-fx-input warikan-fx-group-people" placeholder="0" value="0" min="0" step="1"> <input type="number" id="group-ratio-3" class="warikan-fx-input warikan-fx-group-ratio" value="0.8" step="0.1" min="0"> </div>
         <div class="warikan-fx-group-row"> <input type="text" id="group-name-5" class="warikan-fx-input warikan-fx-group-name" value="すごく飲む人" readonly> <input type="number" id="group-people-5" class="warikan-fx-input warikan-fx-group-people" placeholder="0" value="0" min="0" step="1"> <input type="number" id="group-ratio-5" class="warikan-fx-input warikan-fx-group-ratio" value="1.8" step="0.1" min="0"> </div>
         <div class="warikan-fx-group-row"> <input type="text" id="group-name-4" class="warikan-fx-input warikan-fx-group-name" value="飲まない人" readonly> <input type="number" id="group-people-4" class="warikan-fx-input warikan-fx-group-people" placeholder="0" value="0" min="0" step="1"> <input type="number" id="group-ratio-4" class="warikan-fx-input warikan-fx-group-ratio" value="0.5" step="0.1" min="0"> </div>
    </div>
    <div id="warikan-fx-people-summary" class="warikan-fx-people-summary">グループ合計人数: <span>1</span> 人</div>
    <div class="warikan-fx-input-group" style="margin-top: 2rem;"> <label for="warikan-fx-rounding-unit">一人あたりの金額を切り上げる単位</label> <select id="warikan-fx-rounding-unit" class="warikan-fx-select"> <option value="1">1円単位 (そのまま)</option> <option value="10">10円単位</option> <option value="100" selected>100円単位</option> <option value="1000">1000円単位</option> </select> </div>
    <button id="warikan-fx-calculate-btn" class="warikan-fx-calculate-btn">計算する</button>
    <div id="warikan-fx-error-message" class="warikan-fx-error-message"></div>
    <div id="warikan-fx-results-area" class="warikan-fx-results-area"> <h3>計算結果</h3> <div id="warikan-fx-results-list"></div> <div id="warikan-fx-results-summary" class="warikan-fx-result-summary"></div> </div>

</div>

<script>
// 規範 1.3 & 1.6：使用 DOMContentLoaded 和 IIFE
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Warikan V11] DOMContentLoaded fired.'); // **診斷**

    (function() {
        console.log('[Warikan V11] IIFE executed.'); // **診斷**

        const appId = 'warikan-fixed-app-jp'; 
        const app = document.getElementById(appId); 
        if (!app) { 
            console.error(`[Warikan V11] Fatal: Container #${appId} not found.`); 
            return; 
        }
        
        const calculateBtn = app.querySelector('#warikan-fx-calculate-btn');
        if (!calculateBtn) {
            console.error("[Warikan V11] Fatal: Calculate button #warikan-fx-calculate-btn not found during init.");
            app.innerHTML = '<p style="color: red; text-align: center;">エラー: 計算ボタンの読み込みに失敗しました。</p>';
            return;
        }

        console.log('[Warikan V11] Calculate button found. Adding event listener.'); // **診斷**

        // --- 顯示錯誤訊息 (輔助函數) ---
        const showError = (message) => {
            const errorMessage = app.querySelector('#warikan-fx-error-message');
            const resultsArea = app.querySelector('#warikan-fx-results-area');
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                console.warn('[Warikan V11] Error displayed -', message); 
            } else {
                 console.error("[Warikan V11] Error message element missing when trying to show:", message);
            }
             if (resultsArea) { 
                 resultsArea.style.display = 'none'; 
             }
        };
        
        // --- 更新總人數顯示 (輔助函數) ---
         const updatePeopleSummary = () => {
             let groupPeopleSum = 0;
             const groupsContainer = app.querySelector('#warikan-fx-groups-container');
             const peopleSummarySpan = app.querySelector('#warikan-fx-people-summary span');
             
             if (groupsContainer) {
                 groupsContainer.querySelectorAll('.warikan-fx-group-people').forEach(input => {
                     groupPeopleSum += parseInt(input.value, 10) || 0; 
                 });
             } else {
                  console.error("[Warikan V11] Groups container not found for summary update.");
             }

             if (peopleSummarySpan) { 
                  peopleSummarySpan.textContent = groupPeopleSum;
             } else {
                  console.error("[Warikan V11] People summary span not found for summary update.");
             }
             return groupPeopleSum; // 返回計算出的總數
         };


        // --- 核心計算與顯示邏輯 (放在事件監聽器內部) ---
        calculateBtn.addEventListener('click', function() {
            console.log('[Warikan V11] Calculate button clicked!'); // **診斷**

            // --- 在此處查找所有元素 ---
            const totalAmountInput = app.querySelector('#warikan-fx-total-amount');
            const groupsContainer = app.querySelector('#warikan-fx-groups-container');
            const roundingUnitSelect = app.querySelector('#warikan-fx-rounding-unit');
            const errorMessage = app.querySelector('#warikan-fx-error-message'); 
            const resultsArea = app.querySelector('#warikan-fx-results-area');
            const resultsList = app.querySelector('#warikan-fx-results-list');
            const resultsSummary = app.querySelector('#warikan-fx-results-summary');
            // 人數匯總 span 在 showError 和 updatePeopleSummary 內部查找

            // --- 健壯性檢查 ---
            // 減少檢查，只檢查最關鍵的
            if (!totalAmountInput || !groupsContainer || !roundingUnitSelect || !resultsArea || !resultsList || !resultsSummary) { 
                console.error("[Warikan V11] Critical elements not found inside click handler. Aborting calculation.");
                showError("エラー：画面要素が見つかりません。"); 
                return; 
            }
             console.log('[Warikan V11] All necessary calculation/display elements found.'); // **診斷**

            // 隱藏舊錯誤和結果
            if (errorMessage) errorMessage.style.display = 'none'; // 檢查 errorMessage 是否存在
            resultsArea.style.display = 'none'; // 先隱藏結果區

            // --- 獲取值並驗證 ---
            const totalAmount = parseFloat(totalAmountInput.value);
            const roundingUnit = parseInt(roundingUnitSelect.value, 10);
            
            if (isNaN(totalAmount) || totalAmount < 0) { showError('支払総額を正しく入力してください（0以上）。'); return; }

            const groups = [];
            let totalWeightedUnits = 0;
            let totalPeopleInGroups = 0; 
            let validGroups = true;

            groupsContainer.querySelectorAll('.warikan-fx-group-row').forEach((row, index) => {
                 const nameInput = row.querySelector('.warikan-fx-group-name'); 
                 const peopleInput = row.querySelector('.warikan-fx-group-people');
                 const ratioInput = row.querySelector('.warikan-fx-group-ratio');

                if(!nameInput || !peopleInput || !ratioInput || !validGroups) { 
                    if(validGroups) { 
                       console.error(`[Warikan V11] Row ${index} elements missing.`);
                       showError(`グループ ${index + 1} の入力欄が見つかりません。`);
                       validGroups = false; 
                    }
                    return; 
                }
                
                const name = nameInput.value.trim() || `グループ${index + 1}`; 
                const people = parseInt(peopleInput.value, 10) || 0; 
                const ratio = parseFloat(ratioInput.value) || 0; 

                if (people < 0) { showError(`「${name}」の人数は0以上で入力してください。`); validGroups = false; return; }
                if (ratio < 0) { showError(`「${name}」の比率は0以上で入力してください。`); validGroups = false; return; }
                
                groups.push({ name, people, ratio });
                if (people > 0) { totalWeightedUnits += people * ratio; }
                totalPeopleInGroups += people; 
            });

            if (!validGroups) { console.warn('[Warikan V11] Invalid group data.'); return; }

            // 更新總人數顯示 (現在可以安全調用)
            updatePeopleSummary(); 
            
             // 驗證總人數
             if (totalPeopleInGroups <= 0 && totalAmount > 0) { showError('参加人数が0人です。各グループの人数を入力してください。'); return; }
             if (totalPeopleInGroups <= 0 && totalAmount === 0) {
                   console.log('[Warikan V11] Zero amount and zero people.');
                   resultsList.innerHTML = ''; 
                   resultsSummary.innerHTML = `<div>支払総額: 0 円</div><div class="total-collected">集金合計: 0 円</div><div class="difference">差額: 0 円</div>`;
                   resultsArea.style.display = 'block';
                   return;
              }
             // 驗證總權重
             if (totalWeightedUnits <= 0 && totalAmount > 0) { showError('支払い比率の合計が0以下か、参加者の比率が全て0です。比率を正しく設定してください。'); return; }
             
             console.log(`[Warikan V11] Inputs validated: Amount=${totalAmount}, People=${totalPeopleInGroups}, Units=${totalWeightedUnits}, Round=${roundingUnit}`); 

            // --- 計算 ---
            let results = [];
            let totalCollected = 0;
            const costPerUnit = (totalWeightedUnits > 0) ? totalAmount / totalWeightedUnits : 0; 
             console.log(`[Warikan V11] Cost per unit: ${costPerUnit}`); 

            groups.forEach(group => {
                let perPersonIdeal = 0;
                let perPersonActual = 0;
                let groupTotal = 0;
                if (group.people > 0 && costPerUnit >= 0) { 
                     perPersonIdeal = costPerUnit * group.ratio;
                     perPersonActual = (perPersonIdeal > 0 && roundingUnit > 0) ? Math.ceil(perPersonIdeal / roundingUnit) * roundingUnit : Math.round(perPersonIdeal);
                     groupTotal = perPersonActual * group.people;
                     totalCollected += groupTotal;
                } 
                results.push({ name: group.name, people: group.people, ratio: group.ratio, perPersonAmount: perPersonActual, groupTotalAmount: groupTotal });
            });

            totalCollected = Math.round(totalCollected); 
            const difference = totalCollected - totalAmount;
             console.log(`[Warikan V11] Calculation done: Collected=${totalCollected}, Difference=${difference}`); 

            // --- 顯示結果 ---
            resultsList.innerHTML = ''; 
            results.forEach(group => {
                if (group.people > 0) { 
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'warikan-fx-result-group'; 
                    const header = document.createElement('div');
                    header.className = 'warikan-fx-result-group-header';
                     header.textContent = `${group.name} (${group.people}人, 比率: ${group.ratio})`; 
                    groupDiv.appendChild(header);
                    const perPersonDiv = document.createElement('div');
                    perPersonDiv.className = 'warikan-fx-result-details';
                    perPersonDiv.innerHTML = `<span>一人あたり:</span> <span class="amount">${group.perPersonAmount.toLocaleString()} 円</span>`;
                    groupDiv.appendChild(perPersonDiv);
                    const groupTotalDiv = document.createElement('div');
                    groupTotalDiv.className = 'warikan-fx-result-details';
                    groupTotalDiv.innerHTML = `<span>グループ合計:</span> <span>${group.groupTotalAmount.toLocaleString()} 円</span>`;
                    groupDiv.appendChild(groupTotalDiv);
                    resultsList.appendChild(groupDiv);
                }
            });

             if (totalPeopleInGroups === 0 && totalAmount > 0) {
                 resultsList.innerHTML = '<p style="text-align:center; color:#6b7280;">各グループの人数が0人のため、計算結果はありません。</p>';
             }

            resultsSummary.innerHTML = `
                <div>支払総額: ${totalAmount.toLocaleString()} 円</div>
                <div class="total-collected">集金合計 (${roundingUnit}円単位で切り上げ): ${totalCollected.toLocaleString()} 円</div>
                <div class="difference">差額 (集金 - 支払い): ${difference.toLocaleString()} 円</div>
            `;
            resultsArea.style.display = 'block'; 
            console.log('[Warikan V11] Results displayed.'); 

        }); // --- calculateBtn listener 結束 ---

        // --- 輸入時隱藏結果和錯誤 ---
        if (app) {
             app.querySelectorAll('input, select').forEach(el => {
                 el.addEventListener('input', () => { 
                     const errorMessage = app.querySelector('#warikan-fx-error-message');
                     const resultsArea = app.querySelector('#warikan-fx-results-area');
                     if (errorMessage) { errorMessage.style.display = 'none'; }
                     if (resultsArea) { resultsArea.style.display = 'none'; } 
                 });
             });
         }

        // --- 初始化時觸發一次人數計算和顯示 ---
         const initialPeopleSummarySpan = app.querySelector('#warikan-fx-people-summary span');
         if (initialPeopleSummarySpan) {
             let initialSum = 0;
             app.querySelectorAll('.warikan-fx-group-people').forEach(input => {
                 initialSum += parseInt(input.value, 10) || 0;
             });
             initialPeopleSummarySpan.textContent = initialSum;
             console.log('[Warikan V11] Initial people summary updated:', initialSum); 
         } else {
              console.warn('[Warikan V11] Initial people summary span not found during initial update.'); 
         }

    })(); // 結束 IIFE
}); // 結束 DOMContentLoaded
</script>
