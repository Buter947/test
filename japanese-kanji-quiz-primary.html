<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【小学生漢字クイズ】学年別（1年〜6年）読み方テスト - 教育漢字1026字</title>

    <style>
        /* [V2] 所有 Class 均使用 kgq-v2- (Kanji Grade Quiz V2) 前綴 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
            line-height: 1.6 !important;
            background-color: #f8fafc !important;
            margin: 0;
            padding: 1rem;
        }
        .kgq-v2-container {
            font-family: inherit !important;
            line-height: 1.6 !important;
            background-color: #f9fafb !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.75rem !important;
            padding: 2rem !important;
            margin: 2rem auto !important;
            max-width: 700px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05) !important;
            overflow: hidden;
        }
        .kgq-v2-container *, 
        .kgq-v2-container *::before, 
        .kgq-v2-container *::after {
            box-sizing: border-box !important;
        }
        .kgq-v2-container .kgq-v2-screen {
            display: none; 
            animation: fadeInKjqV2 0.3s ease-in-out !important;
        }
        .kgq-v2-container .kgq-v2-screen.active {
            display: block !important;
        }
         @keyframes fadeInKjqV2 {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
         }
        
        .kgq-v2-container h2 {
            color: #059669 !important; /* Green Title */
            text-align: center !important;
            font-size: 2rem !important;
            font-weight: 700 !important;
            margin-top: 0 !important;
            margin-bottom: 0.5rem !important;
        }
        .kgq-v2-container h3 {
            text-align: center !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
            margin-top: 0 !important;
            margin-bottom: 1.5rem !important;
            color: #1f2937 !important;
        }
        .kgq-v2-container .kgq-v2-subtitle {
            text-align: center !important;
            font-size: 1.1rem !important;
            color: #4b5563 !important;
            margin: 0 auto 2rem auto !important;
        }
        .kgq-v2-container .kgq-v2-main-btn {
            display: block !important;
            width: 100% !important;
            max-width: 300px !important;
            margin: 2rem auto 0 auto !important;
            padding: 1rem !important;
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: #ffffff !important;
            background-color: #059669 !important; /* Green */
            border: none !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            transition: background-color 0.2s, transform 0.1s !important;
        }
        .kgq-v2-container .kgq-v2-main-btn:hover { background-color: #047857 !important; }
        .kgq-v2-container .kgq-v2-main-btn:active { transform: scale(0.98) !important; }
        
        /* 學年選擇畫面 */
        .kgq-v2-container .kgq-v2-level-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr 1fr !important; /* 3 欄 */
            gap: 1rem !important;
        }
        .kgq-v2-container .kgq-v2-level-btn {
            width: 100% !important;
            padding: 1.5rem 0.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            text-align: center;
        }
        .kgq-v2-container .kgq-v2-level-btn:hover {
            border-color: #059669 !important;
            color: #059669 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
        }
        .kgq-v2-container .kgq-v2-level-btn small {
             font-size: 0.8rem;
             color: #6b7280;
             display: block;
             font-weight: 400;
             margin-top: 0.25rem;
        }

        /* 測驗畫面 */
        .kgq-v2-container .kgq-v2-header {
             display: flex; 
             justify-content: space-between; 
             align-items: center; 
             margin-bottom: 1rem; 
             color: #4a5568; 
             font-weight: 600;
        }
        .kgq-v2-container .kgq-v2-question-counter {
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
        }
        .kgq-v2-container .kgq-v2-score-counter {
             font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
        }
        
        .kgq-v2-container .kgq-v2-question-text {
            font-size: 4.5rem !important; 
            font-weight: 700 !important;
            color: #111827 !important;
            text-align: center;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 2.5rem 1.5rem;
            margin-bottom: 2rem;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Kyokasho', 'Yu Mincho', 'Hiragino Mincho ProN', serif !important; /* 使用教科書體或明體 */
        }
        .kgq-v2-container .kgq-v2-options-container {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 1rem !important;
        }
        .kgq-v2-container .kgq-v2-option-btn {
            width: 100% !important;
            padding: 1rem !important;
            font-size: 1.25rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            text-align: center;
            min-height: 80px; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .kgq-v2-container .kgq-v2-option-btn:not(:disabled):hover {
            border-color: #059669 !important;
            color: #059669 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
        }
        .kgq-v2-container .kgq-v2-option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .kgq-v2-container .kgq-v2-option-btn.correct {
            background-color: #dcfce7 !important;
            border-color: #16a34a !important;
            color: #15803d !important;
            font-weight: 700 !important;
        }
        .kgq-v2-container .kgq-v2-option-btn.wrong {
            background-color: #fee2e2 !important;
            border-color: #dc2626 !important;
            color: #b91c1c !important;
            opacity: 1 !important;
        }
        
        .kgq-v2-container .kgq-v2-feedback-container {
            display: none;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1.5rem; 
            text-align: center;
            animation: fadeInKjqV2 0.3s ease-in-out !important;
        }
        .kgq-v2-container .kgq-v2-feedback-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
        }
        .kgq-v2-container .kgq-v2-feedback-text.correct { color: #16a34a; }
        .kgq-v2-container .kgq-v2-feedback-text.wrong { color: #dc2626; }
        
        .kgq-v2-container .kgq-v2-answer-pair {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .kgq-v2-container .kgq-v2-next-btn {
            display: none; 
            width: 100%;
            background-color: #0284c7; /* Blue next button */
            margin: 1.5rem auto 0 auto;
            max-width: 300px;
        }
        .kgq-v2-container .kgq-v2-next-btn:hover {
            background-color: #0369a1;
        }
        
        /* 結果畫面 */
        .kgq-v2-container .kgq-v2-score-display {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        }
         .kgq-v2-container .kgq-v2-score-display .score {
             font-size: 3rem;
             font-weight: 700;
             color: #059669; /* Green score */
             display: block;
             margin: 0.5rem 0;
         }
         .kgq-v2-container .kgq-v2-score-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 300px;
            margin: 2rem auto 0 auto;
         }
         .kgq-v2-container .kgq-v2-score-controls .kgq-v2-main-btn {
             margin-top: 0 !important;
             background-color: #059669 !important; /* Green */
         }
          .kgq-v2-container .kgq-v2-score-controls .kgq-v2-main-btn:hover {
             background-color: #047857 !important;
         }
         .kgq-v2-container .kgq-v2-secondary-btn {
             background-color: #ffffff !important;
             color: #374151 !important;
             border: 1px solid #d1d5db !important;
         }
         .kgq-v2-container .kgq-v2-secondary-btn:hover {
             background-color: #f9fafb !important;
         }
         
         /* 響應式 */
         @media (max-width: 600px) {
            .kgq-v2-container {
                padding: 1.5rem !important;
                margin: 1rem auto !important;
            }
             .kgq-v2-container h2 {
                 font-size: 1.75rem !important;
             }
             .kgq-v2-container .kgq-v2-question-text {
                 font-size: 3.5rem !important;
             }
         }
         @media (max-width: 480px) {
             .kgq-v2-container .kgq-v2-options-container {
                 grid-template-columns: 1fr !important; /* Stack options */
             }
             .kgq-v2-container .kgq-v2-level-grid {
                 grid-template-columns: 1fr 1fr !important; /* 2 欄 */
             }
         }
    </style>
</head>
<body>

    <div id="kanji-grade-quiz-v2" class="kgq-v2-container">
        <div class="kgq-v2-card">
            
            <div id="kgq-v2-screen-level-select" class="kgq-v2-screen active">
                <h2>小学生漢字クイズ</h2>
                <p class="kgq-v2-subtitle">挑戦する学年を選んでください。</p>
                <div id="kgq-v2-level-grid" class="kgq-v2-level-grid"></div>
            </div>

            <div id="kgq-v2-screen-quiz" class="kgq-v2-screen">
                <div class="kgq-v2-header">
                     <span id="kgq-v2-question-counter" class="kgq-v2-question-counter"></span>
                     <span id="kgq-v2-score-counter" class="kgq-v2-score-counter"></span>
                </div>
                <div id="kgq-v2-question-text" class="kgq-v2-question-text"></div>
                <div id="kgq-v2-options-container" class="kgq-v2-options-container"></div>
                
                <button id="kgq-v2-next-btn" class="kgq-v2-main-btn kgq-v2-next-btn">次の問題へ</button>
                <div id="kgq-v2-feedback-container" class="kgq-v2-feedback-container">
                    <h3 id="kgq-v2-feedback-text" class="kgq-v2-feedback-text"></h3>
                    <div id="kgq-v2-answer-pair" class="kgq-v2-answer-pair"></div>
                </div>
            </div>

            <div id="kgq-v2-screen-score" class="kgq-v2-screen">
                <h3>お疲れ様でした！</h3>
                <div class="kgq-v2-score-display">
                    あなたのスコア:
                    <span id="kgq-v2-final-score" class="score">10問中 8問</span>
                    正解
                </div>
                <div class="kgq-v2-score-controls">
                    <button id="kgq-v2-restart-btn" class="kgq-v2-main-btn">もう一度挑戦する</button>
                    <button id="kgq-v2-back-to-menu-score" class="kgq-v2-main-btn kgq-v2-secondary-btn">学年選択に戻る</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 規範 1.6 (IIFE)
    (function() {
        
        // --- [V2 擴展] 核心資料庫 (1026 詞) ---
        const kgq_v2_quizData = {
            'g1': {
                name: '小学1年生<small>(全 80 字)</small>',
                data: [
                    {q:'一',a:'いち'}, {q:'二',a:'に'}, {q:'三',a:'さん'}, {q:'四',a:'よん'}, {q:'五',a:'ご'}, {q:'六',a:'ろく'}, {q:'七',a:'なな'}, {q:'八',a:'はち'}, {q:'九',a:'きゅう'}, {q:'十',a:'じゅう'}, 
                    {q:'百',a:'ひゃく'}, {q:'千',a:'せん'}, {q:'上',a:'うえ'}, {q:'下',a:'した'}, {q:'左',a:'ひだり'}, {q:'右',a:'みぎ'}, {q:'中',a:'なか'}, {q:'大',a:'おおきい'}, {q:'小',a:'ちいさい'}, {q:'月',a:'つき'}, 
                    {q:'日',a:'ひ'}, {q:'年',a:'とし'}, {q:'早',a:'はやい'}, {q:'木',a:'き'}, {q:'林',a:'はやし'}, {q:'山',a:'やま'}, {q:'川',a:'かわ'}, {q:'土',a:'つち'}, {q:'空',a:'そら'}, {q:'田',a:'た'}, 
                    {q:'天',a:'てん'}, {q:'生',a:'せい'}, {q:'花',a:'はな'}, {q:'草',a:'くさ'}, {q:'虫',a:'むし'}, {q:'犬',a:'いぬ'}, {q:'人',a:'ひと'}, {q:'名',a:'な'}, {q:'女',a:'おんな'}, {q:'男',a:'おとこ'}, 
                    {q:'子',a:'こ'}, {q:'目',a:'め'}, {q:'耳',a:'みみ'}, {q:'口',a:'くち'}, {q:'手',a:'て'}, {q:'足',a:'あし'}, {q:'見',a:'みる'}, {q:'音',a:'おと'}, {q:'力',a:'ちから'}, {q:'気',a:'き'}, 
                    {q:'円',a:'えん'}, {q:'入',a:'はいる'}, {q:'出',a:'でる'}, {q:'立',a:'たつ'}, {q:'休',a:'やすむ'}, {q:'先',a:'さき'}, {q:'夕',a:'ゆう'}, {q:'本',a:'ほん'}, {q:'文',a:'ぶん'}, {q:'字',a:'じ'}, 
                    {q:'学',a:'まなぶ'}, {q:'校',a:'こう'}, {q:'村',a:'むら'}, {q:'町',a:'まち'}, {q:'森',a:'もり'}, {q:'正',a:'ただしい'}, {q:'水',a:'みず'}, {q:'火',a:'ひ'}, {q:'玉',a:'たま'}, {q:'王',a:'おう'}, 
                    {q:'石',a:'いし'}, {q:'竹',a:'たけ'}, {q:'糸',a:'いと'}, {q:'貝',a:'かい'}, {q:'車',a:'くるま'}, {q:'金',a:'かね'}, {q:'雨',a:'あめ'}, {q:'赤',a:'あか'}, {q:'青',a:'あお'}, {q:'白',a:'しろ'}
                ]
            },
            'g2': {
                name: '小学2年生<small>(全 160 字)</small>',
                data: [
                    {q:'引',a:'ひく'}, {q:'羽',a:'はね'}, {q:'雲',a:'くも'}, {q:'園',a:'えん'}, {q:'遠',a:'とおい'}, {q:'何',a:'なに'}, {q:'科',a:'か'}, {q:'夏',a:'なつ'}, {q:'家',a:'いえ'}, {q:'歌',a:'うた'}, 
                    {q:'画',a:'が'}, {q:'回',a:'まわる'}, {q:'会',a:'あう'}, {q:'海',a:'うみ'}, {q:'絵',a:'え'}, {q:'外',a:'そと'}, {q:'角',a:'つの'}, {q:'楽',a:'たのしい'}, {q:'活',a:'かつ'}, {q:'間',a:'あいだ'}, 
                    {q:'丸',a:'まる'}, {q:'岩',a:'いわ'}, {q:'顔',a:'かお'}, {q:'汽',a:'き'}, {q:'記',a:'き'}, {q:'帰',a:'かえる'}, {q:'弓',a:'ゆみ'}, {q:'牛',a:'うし'}, {q:'魚',a:'さかな'}, {q:'京',a:'きょう'}, 
                    {q:'強',a:'つよい'}, {q:'教',a:'おしえる'}, {q:'近',a:'ちかい'}, {q:'兄',a:'あに'}, {q:'形',a:'かたち'}, {q:'計',a:'はかる'}, {q:'元',a:'げん'}, {q:'言',a:'いう'}, {q:'原',a:'はら'}, {q:'戸',a:'と'}, 
                    {q:'古',a:'ふるい'}, {q:'午',a:'ご'}, {q:'後',a:'うしろ'}, {q:'語',a:'ご'}, {q:'工',a:'こう'}, {q:'公',a:'こう'}, {q:'広',a:'ひろい'}, {q:'交',a:'まじわる'}, {q:'光',a:'ひかり'}, {q:'考',a:'かんがえる'}, 
                    {q:'行',a:'いく'}, {q:'高',a:'たかい'}, {q:'黄',a:'き'}, {q:'合',a:'あう'}, {q:'谷',a:'たに'}, {q:'国',a:'くに'}, {q:'黒',a:'くろ'}, {q:'今',a:'いま'}, {q:'才',a:'さい'}, {q:'細',a:'ほそい'}, 
                    {q:'作',a:'つくる'}, {q:'算',a:'さん'}, {q:'止',a:'とまる'}, {q:'市',a:'いち'}, {q:'矢',a:'や'}, {q:'姉',a:'あね'}, {q:'思',a:'おもう'}, {q:'紙',a:'かみ'}, {q:'寺',a:'てら'}, {q:'自',a:'じ'}, 
                    {q:'時',a:'とき'}, {q:'室',a:'しつ'}, {q:'社',a:'やしろ'}, {q:'弱',a:'よわい'}, {q:'首',a:'くび'}, {q:'秋',a:'あき'}, {q:'週',a:'しゅう'}, {q:'春',a:'はる'}, {q:'書',a:'かく'}, {q:'少',a:'すくない'}, 
                    {q:'場',a:'ば'}, {q:'色',a:'いろ'}, {q:'食',a:'たべる'}, {q:'心',a:'こころ'}, {q:'新',a:'あたらしい'}, {q:'親',a:'おや'}, {q:'図',a:'ず'}, {q:'数',a:'かず'}, {q:'西',a:'にし'}, {q:'声',a:'こえ'}, 
                    {q:'星',a:'ほし'}, {q:'晴',a:'はれる'}, {q:'切',a:'きる'}, {q:'雪',a:'ゆき'}, {q:'船',a:'ふね'}, {q:'線',a:'せん'}, {q:'前',a:'まえ'}, {q:'組',a:'くむ'}, {q:'走',a:'はしる'}, {q:'多',a:'おおい'}, 
                    {q:'太',a:'ふとい'}, {q:'体',a:'からだ'}, {q:'台',a:'だい'}, {q:'地',a:'ち'}, {q:'池',a:'いけ'}, {q:'知',a:'しる'}, {q:'茶',a:'ちゃ'}, {q:'昼',a:'ひる'}, {q:'長',a:'ながい'}, {q:'鳥',a:'とり'}, 
                    {q:'朝',a:'あさ'}, {q:'直',a:'なおす'}, {q:'通',a:'とおる'}, {q:'弟',a:'おとうと'}, {q:'店',a:'みせ'}, {q:'点',a:'てん'}, {q:'電',a:'でん'}, {q:'刀',a:'かたな'}, {q:'冬',a:'ふゆ'}, {q:'当',a:'あたる'}, 
                    {q:'東',a:'ひがし'}, {q:'答',a:'こたえる'}, {q:'頭',a:'あたま'}, {q:'同',a:'おなじ'}, {q:'道',a:'みち'}, {q:'読',a:'よむ'}, {q:'内',a:'うち'}, {q:'南',a:'みなみ'}, {q:'肉',a:'にく'}, {q:'馬',a:'うま'}, 
                    {q:'売',a:'うる'}, {q:'買',a:'かう'}, {q:'麦',a:'むぎ'}, {q:'半',a:'はん'}, {q:'番',a:'ばん'}, {q:'父',a:'ちち'}, {q:'風',a:'かぜ'}, {q:'分',a:'わける'}, {q:'聞',a:'きく'}, {q:'米',a:'こめ'}, 
                    {q:'歩',a:'あるく'}, {q:'母',a:'はは'}, {q:'方',a:'ほう'}, {q:'北',a:'きた'}, {q:'毎',a:'まい'}, {q:'妹',a:'いもうと'}, {q:'万',a:'まん'}, {q:'明',a:'あかるい'}, {q:'鳴',a:'なく'}, {q:'毛',a:'け'}, 
                    {q:'門',a:'もん'}, {q:'夜',a:'よる'}, {q:'野',a:'の'}, {q:'友',a:'とも'}, {q:'用',a:'よう'}, {q:'曜',a:'よう'}, {q:'来',a:'くる'}, {q:'里',a:'さと'}, {q:'理',a:'り'}, {q:'話',a:'はなす'}
                ]
            },
            'g3': {
                name: '小学3年生<small>(全 200 字)</small>',
                data: [
                    {q:'悪',a:'わるい'}, {q:'安',a:'やすい'}, {q:'暗',a:'くらい'}, {q:'医',a:'い'}, {q:'委',a:'い'}, {q:'意',a:'い'}, {q:'育',a:'そだてる'}, {q:'員',a:'いん'}, {q:'院',a:'いん'}, {q:'飲',a:'のむ'}, 
                    {q:'運',a:'はこぶ'}, {q:'泳',a:'およぐ'}, {q:'駅',a:'えき'}, {q:'央',a:'おう'}, {q:'横',a:'よこ'}, {q:'屋',a:'や'}, {q:'温',a:'あたたかい'}, {q:'化',a:'ばける'}, {q:'荷',a:'に'}, {q:'界',a:'かい'}, 
                    {q:'開',a:'ひらく'}, {q:'階',a:'かい'}, {q:'寒',a:'さむい'}, {q:'感',a:'かん'}, {q:'漢',a:'かん'}, {q:'館',a:'かん'}, {q:'岸',a:'きし'}, {q:'起',a:'おきる'}, {q:'期',a:'き'}, {q:'客',a:'きゃく'}, 
                    {q:'究',a:'きわめる'}, {q:'急',a:'いそぐ'}, {q:'級',a:'きゅう'}, {q:'宮',a:'みや'}, {q:'球',a:'たま'}, {q: '去',a:'さる'}, {q:'橋',a:'はし'}, {q:'業',a:'ぎょう'}, {q:'曲',a:'まがる'}, {q:'局',a:'きょく'}, 
                    {q:'銀',a:'ぎん'}, {q:'区',a:'く'}, {q:'苦',a:'くるしい'}, {q:'具',a:'ぐ'}, {q:'君',a:'きみ'}, {q:'係',a:'かかり'}, {q:'軽',a:'かるい'}, {q:'決',a:'きめる'}, {q:'研',a:'とぐ'}, {q:'県',a:'けん'}, 
                    {q:'庫',a:'くら'}, {q:'湖',a:'みずうみ'}, {q:'向',a:'むかう'}, {q:'幸',a:'しあわせ'}, {q:'港',a:'みなと'}, {q:'号',a:'ごう'}, {q:'根',a:'ね'}, {q:'祭',a:'まつり'}, {q:'皿',a:'さら'}, {q:'仕',a:'つかえる'}, 
                    {q:'死',a:'しぬ'}, {q:'使',a:'つかう'}, {q:'始',a:'はじめる'}, {q:'指',a:'ゆび'}, {q:'歯',a:'は'}, {q:'詩',a:'し'}, {q:'次',a:'つぎ'}, {q:'事',a:'こと'}, {q:'持',a:'もつ'}, {q:'式',a:'しき'}, 
                    {q:'実',a:'み'}, {q:'写',a:'うつす'}, {q:'者',a:'もの'}, {q:'主',a:'ぬし'}, {q:'守',a:'まもる'}, {q:'取',a:'とる'}, {q:'酒',a:'さけ'}, {q:'受',a:'うける'}, {q:'州',a:'しゅう'}, {q:'拾',a:'ひろう'}, 
                    {q:'終',a:'おわる'}, {q:'習',a:'ならう'}, {q:'集',a:'あつめる'}, {q:'住',a:'すむ'}, {q:'重',a:'おもい'}, {q:'宿',a:'やど'}, {q:'所',a:'ところ'}, {q:'暑',a:'あつい'}, {q:'助',a:'たすける'}, {q:'昭',a:'しょう'}, 
                    {q:'消',a:'きえる'}, {q:'商',a:'あきなう'}, {q:'章',a:'しょう'}, {q:'勝',a:'かつ'}, {q:'乗',a:'のる'}, {q:'植',a:'うえる'}, {q:'申',a:'もうす'}, {q:'身',a:'み'}, {q:'神',a:'かみ'}, {q:'真',a:'ま'}, 
                    {q:'深',a:'ふかい'}, {q:'進',a:'すすむ'}, {q:'世',a:'せ'}, {q:'整',a:'ととのえる'}, {q:'昔',a:'むかし'}, {q:'全',a:'すべて'}, {q:'相',a:'あい'}, {q:'送',a:'おくる'}, {q:'想',a:'そう'}, {q:'息',a:'いき'}, 
                    {q:'速',a:'はやい'}, {q:'族',a:'ぞく'}, {q:'他',a:'ほか'}, {q:'打',a:'うつ'}, {q:'対',a:'たい'}, {q:'待',a:'まつ'}, {q:'代',a:'かわり'}, {q:'第',a:'だい'}, {q:'題',a:'だい'}, {q:'炭',a:'すみ'}, 
                    {q:'短',a:'みじかい'}, {q:'談',a:'だん'}, {q:'地',a:'ち'}, {q:'置',a:'おく'}, {q:'登',a:'のぼる'}, {q:'等',a:'ひとしい'}, {q:'豆',a:'まめ'}, {q:'島',a:'しま'}, {q:'投',a:'なげる'}, {q:'湯',a:'ゆ'}, 
                    {q:'動',a:'うごく'}, {q:'童',a:'わらべ'}, {q:'農',a:'のう'}, {q:'波',a:'なみ'}, {q:'配',a:'くばる'}, {q:'倍',a:'ばい'}, {q:'箱',a:'はこ'}, {q:'畑',a:'はたけ'}, {q:'発',a:'はつ'}, {q:'反',a:'はん'}, 
                    {q:'坂',a:'さか'}, {q:'板',a:'いた'}, {q:'皮',a:'かわ'}, {q:'悲',a:'かなしい'}, {q:'美',a:'うつくしい'}, {q:'鼻',a:'はな'}, {q:'筆',a:'ふで'}, {q:'氷',a:'こおり'}, {q:'表',a:'おもて'}, {q:'秒',a:'びょう'}, 
                    {q:'病',a:'やまい'}, {q:'品',a:'しな'}, {q:'負',a:'まける'}, {q:'部',a:'ぶ'}, {q:'服',a:'ふく'}, {q:'福',a:'ふく'}, {q:'物',a:'もの'}, {q:'平',a:'たいら'}, {q:'返',a:'かえす'}, {q:'勉',a:'べん'}, 
                    {q:'歩',a:'あるく'}, {q:'命',a:'いのち'}, {q:'面',a:'めん'}, {q:'問',a:'とう'}, {q:'薬',a:'くすり'}, {q:'油',a:'あぶら'}, {q:'有',a:'ある'}, {q:'遊',a:'あそぶ'}, {q:'予',a:'よ'}, {q:'羊',a:'ひつじ'}, 
                    {q:'洋',a:'よう'}, {q:'葉',a:'は'}, {q:'陽',a:'よう'}, {q:'様',a:'さま'}, {q:'落',a:'おちる'}, {q:'流',a:'ながれる'}, {q:'旅',a:'たび'}, {q:'両',a:'りょう'}, {q:'緑',a:'みどり'}, {q:'礼',a:'れい'}, 
                    {q:'列',a:'れつ'}, {q:'練',a:'ねる'}, {q:'路',a:'みち'}, {q:'和',a:'わ'}
                ]
            },
            'g4': {
                name: '小学4年生<small>(全 202 字)</small>',
                data: [
                    {q:'愛',a:'あい'}, {q:'案',a:'あん'}, {q:'以',a:'い'}, {q:'衣',a:'ころも'}, {q:'位',a:'くらい'}, {q:'囲',a:'かこむ'}, {q:'胃',a:'い'}, {q:'印',a:'しるし'}, {q:'英',a:'えい'}, {q:'栄',a:'さかえる'}, 
                    {q:'塩',a:'しお'}, {q:'億',a:'おく'}, {q:'加',a:'くわえる'}, {q:'果',a:'くだもの'}, {q:'貨',a:'か'}, {q:'課',a:'か'}, {q:'芽',a:'め'}, {q:'改',a:'あらためる'}, {q:'械',a:'かい'}, {q:'害',a:'がい'}, 
                    {q:'街',a:'まち'}, {q:'各',a:'おのおの'}, {q:'覚',a:'おぼえる'}, {q:'完',a:'かん'}, {q:'官',a:'かん'}, {q:'管',a:'くだ'}, {q:'関',a:'せき'}, {q:'観',a:'みる'}, {q:'願',a:'ねがう'}, {q:'希',a:'まれ'}, 
                    {q:'季',a:'き'}, {q:'紀',a:'き'}, {q:'喜',a:'よろこぶ'}, {q:'旗',a:'はた'}, {q:'器',a:'うつわ'}, {q:'機',a:'はた'}, {q:'議',a:'ぎ'}, {q:'求',a:'もとめる'}, {q:'泣',a:'なく'}, {q:'救',a:'すくう'}, 
                    {q:'給',a:'きゅう'}, {q:'挙',a:'あげる'}, {q:'漁',a:'ぎょ'}, {q:'共',a:'とも'}, {q:'協',a:'きょう'}, {q:'鏡',a:'かがみ'}, {q:'競',a:'きそう'}, {q:'極',a:'きわめる'}, {q:'訓',a:'くん'}, {q:'軍',a:'ぐん'}, 
                    {q:'郡',a:'ぐん'}, {q:'径',a:'けい'}, {q:'型',a:'かた'}, {q:'景',a:'けい'}, {q:'芸',a:'げい'}, {q:'欠',a:'かける'}, {q:'結',a:'むすぶ'}, {q:'建',a:'たてる'}, {q:'健',a:'すこやか'}, {q:'験',a:'けん'}, 
                    {q:'固',a:'かたい'}, {q:'功',a:'こう'}, {q:'好',a:'このむ'}, {q:'候',a:'こう'}, {q:'航',a:'こう'}, {q:'康',a:'こう'}, {q:'告',a:'つげる'}, {q:'差',a:'さ'}, {q:'菜',a:'な'}, {q:'最',a:'もっとも'}, 
                    {q:'材',a:'ざい'}, {q:'昨',a:'さく'}, {q:'札',a:'ふだ'}, {q:'刷',a:'する'}, {q:'殺',a:'ころす'}, {q:'察',a:'さっする'}, {q:'参',a:'まいる'}, {q:'産',a:'うむ'}, {q:'散',a:'ちる'}, {q:'残',a:'のこる'}, 
                    {q:'士',a:'し'}, {q:'氏',a:'うじ'}, {q:'史',a:'し'}, {q:'司',a:'し'}, {q:'試',a:'ためす'}, {q:'児',a:'じ'}, {q:'治',a:'おさめる'}, {q:'辞',a:'やめる'}, {q:'失',a:'うしなう'}, {q:'借',a:'かりる'}, 
                    {q:'種',a:'たね'}, {q:'周',a:'まわり'}, {q:'祝',a:'いわう'}, {q:'順',a:'じゅん'}, {q:'初',a:'はじめ'}, {q:'松',a:'まつ'}, {q:'笑',a:'わらう'}, {q:'唱',a:'となえる'}, {q:'焼',a:'やく'}, {q:'象',a:'ぞう'}, 
                    {q:'照',a:'てる'}, {q:'賞',a:'しょう'}, {q:'臣',a:'しん'}, {q:'信',a:'しん'}, {q:'成',a:'なる'}, {q:'省',a:'はぶく'}, {q:'清',a:'きよい'}, {q:'静',a:'しずか'}, {q:'席',a:'せき'}, {q:'積',a:'つむ'}, 
                    {q:'折',a:'おる'}, {q:'節',a:'ふし'}, {q:'説',a:'とく'}, {q:'浅',a:'あさい'}, {q:'戦',a:'たたかう'}, {q:'選',a:'えらぶ'}, {q:'然',a:'ぜん'}, {q:'争',a:'あらそう'}, {q:'倉',a:'くら'}, {q:'巣',a:'す'}, 
                    {q:'束',a:'たば'}, {q:'側',a:'がわ'}, {q:'続',a:'つづく'}, {q:'卒',a:'そつ'}, {q:'孫',a:'まご'}, {q:'帯',a:'おび'}, {q:'隊',a:'たい'}, {q:'達',a:'たつ'}, {q:'単',a:'たん'}, {q:'置',a:'おく'}, 
                    {q:'仲',a:'なか'}, {q:'貯',a:'ちょ'}, {q:'兆',a:'ちょう'}, {q:'腸',a:'ちょう'}, {q:'低',a:'ひくい'}, {q:'底',a:'そこ'}, {q:'停',a:'てい'}, {q:'的',a:'まと'}, {q:'典',a:'てん'}, {q:'伝',a:'つたえる'}, 
                    {q:'徒',a:'と'}, {q:'努',a:'つとめる'}, {q:'灯',a:'ひ'}, {q:'堂',a:'どう'}, {q:'働',a:'はたらく'}, {q:'特',a:'とく'}, {q:'得',a:'える'}, {q:'毒',a:'どく'}, {q:'熱',a:'あつい'}, {q:'念',a:'ねん'}, 
                    {q:'敗',a:'やぶれる'}, {q:'梅',a:'うめ'}, {q:'博',a:'はく'}, {q:'飯',a:'めし'}, {q:'飛',a:'とぶ'}, {q:'費',a:'ひ'}, {q:'必',a:'かならず'}, {q:'標',a:'ひょう'}, {q:'票',a:'ひょう'}, {q:'不',a:'ふ'}, 
                    {q:'付',a:'つく'}, {q:'府',a:'ふ'}, {q:'副',a:'ふく'}, {q:'粉',a:'こな'}, {q:'兵',a:'へい'}, {q:'別',a:'わかれる'}, {q:'辺',a:'あたり'}, {q:'変',a:'かえる'}, {q:'便',a:'たより'}, {q:'包',a:'つつむ'}, 
                    {q:'法',a:'ほう'}, {q:'望',a:'のぞむ'}, {q:'牧',a:'まき'}, {q:'末',a:'すえ'}, {q:'満',a:'みちる'}, {q:'未',a:'み'}, {q:'脈',a:'みゃく'}, {q:'民',a:'たみ'}, {q:'無',a:'ない'}, {q:'約',a:'やく'}, 
                    {q:'勇',a:'いさむ'}, {q:'要',a:'いる'}, {q:'養',a:'やしなう'}, {q:'浴',a:'あびる'}, {q:'利',a:'り'}, {q:'陸',a:'りく'}, {q: '良',a:'よい'}, {q:'料',a:'りょう'}, {q:'量',a:'はかる'}, {q:'輪',a:'わ'}, 
                    {q:'類',a:'たぐい'}, {q:'令',a:'れい'}, {q:'冷',a:'つめたい'}, {q:'例',a:'れい'}, {q:'歴',a:'れき'}, {q:'連',a:'つれる'}, {q:'老',a:'おいる'}, {q:'労',a:'ろう'}, {q:'録',a:'ろく'}
                ]
            },
            'g5': {
                name: '小学5年生<small>(全 193 字)</small>',
                data: [
                    {q:'圧',a:'あつ'}, {q:'囲',a:'かこむ'}, {q:'移',a:'うつる'}, {q:'因',a:'ちなむ'}, {q:'永',a:'ながい'}, {q:'営',a:'いとなむ'}, {q:'衛',a:'まもる'}, {q:'易',a:'やさしい'}, {q:'益',a:'えき'}, {q:'液',a:'えき'}, 
                    {q:'演',a:'えん'}, {q:'応',a:'こたえる'}, {q:'往',a:'いく'}, {q:'桜',a:'さくら'}, {q:'恩',a:'おん'}, {q:'可',a:'か'}, {q:'仮',a:'かり'}, {q:'価',a:'あたい'}, {q:'河',a:'かわ'}, {q:'過',a:'すぎる'}, 
                    {q:'賀',a:'が'}, {q:'解',a:'とく'}, {q:'快',a:'こころよい'}, {q:'格',a:'かく'}, {q:'確',a:'たしか'}, {q:'額',a:'ひたい'}, {q:'刊',a:'かん'}, {q:'幹',a:'みき'}, {q:'慣',a:'なれる'}, {q:'眼',a:'まなこ'}, 
                    {q:'基',a:'もと'}, {q:'寄',a:'よる'}, {q:'規',a:'き'}, {q:'技',a:'わざ'}, {q:'義',a:'ぎ'}, {q:'逆',a:'さか'}, {q:'久',a:'ひさしい'}, {q:'旧',a:'ふるい'}, {q:'居',a:'いる'}, {q:'許',a:'ゆるす'}, 
                    {q:'境',a:'さかい'}, {q:'均',a:'きん'}, {q:'禁',a:'きん'}, {q:'句',a:'く'}, {q:'群',a:'むれ'}, {q:'経',a:'たつ'}, {q:'潔',a:'いさぎよい'}, {q:'件',a:'けん'}, {q:'券',a:'けん'}, {q:'険',a:'けわしい'}, 
                    {q:'検',a:'けん'}, {q:'限',a:'かぎる'}, {q:'現',a:'あらわれる'}, {q:'減',a:'へる'}, {q:'故',a:'ゆえ'}, {q:'個',a:'こ'}, {q:'護',a:'まもる'}, {q:'効',a:'きく'}, {q:'厚',a:'あつい'}, {q:'耕',a:'たがやす'}, 
                    {q:'鉱',a:'こう'}, {q:'構',a:'かまえる'}, {q:'興',a:'おこる'}, {q:'講',a:'こう'}, {q:'混',a:'まざる'}, {q:'査',a:'さ'}, {q:'再',a:'ふたたび'}, {q:'災',a:'わざわい'}, {q:'妻',a:'つま'}, {q:'採',a:'とる'}, 
                    {q:'際',a:'きわ'}, {q:'在',a:'ある'}, {q:'罪',a:'つみ'}, {q:'財',a:'ざい'}, {q:'殺',a:'ころす'}, {q:'雑',a:'ざつ'}, {q:'酸',a:'さん'}, {q:'賛',a:'さん'}, {q:'枝',a:'えだ'}, {q:'師',a:'し'}, 
                    {q:'志',a:'こころざし'}, {q:'支',a:'ささえる'}, {q:'資',a:'し'}, {q:'飼',a:'かう'}, {q:'示',a:'しめす'}, {q:'似',a:'にる'}, {q:'識',a:'しき'}, {q:'質',a:'しつ'}, {q:'舎',a:'しゃ'}, {q:'謝',a:'あやまる'}, 
                    {q:'授',a:'さずける'}, {q:'修',a:'おさめる'}, {q:'術',a:'じゅつ'}, {q:'述',a:'のべる'}, {q:'準',a:'じゅん'}, {q:'序',a:'じょ'}, {q:'招',a:'まねく'}, {q:'証',a:'しょう'}, {q:'条',a:'じょう'}, {q:'状',a:'じょう'}, 
                    {q:'常',a:'つね'}, {q:'情',a:'なさけ'}, {q: '織',a:'おる'}, {q:'職',a:'しょく'}, {q:'制',a:'せい'}, {q:'性',a:'せい'}, {q:'政',a:'まつりごと'}, {q:'勢',a:'いきおい'}, {q:'精',a:'せい'}, {q:'製',a:'せい'}, 
                    {q:'税',a:'ぜい'}, {q:'責',a:'せめる'}, {q:'績',a:'せき'}, {q:'接',a:'せっする'}, {q:'設',a:'もうける'}, {q:'舌',a:'した'}, {q:'絶',a:'たえる'}, {q:'銭',a:'ぜに'}, {q:'祖',a:'そ'}, {q:'素',a:'もと'}, 
                    {q:'総',a:'そう'}, {q:'造',a:'つくる'}, {q:'増',a:'ふえる'}, {q:'則',a:'のり'}, {q:'測',a:'はかる'}, {q:'属',a:'ぞく'}, {q:'率',a:'ひきいる'}, {q:'損',a:'そん'}, {q:'退',a:'しりぞく'}, {q:'貸',a:'かす'}, 
                    {q:'態',a:'たい'}, {q:'団',a:'だん'}, {q:'断',a:'たつ'}, {q:'築',a:'きずく'}, {q:'張',a:'はる'}, {q:'提',a:'さげる'}, {q:'程',a:'ほど'}, {q:'敵',a:'てき'}, {q:'適',a:'てき'}, {q:'統',a:'すべる'}, 
                    {q:'導',a:'みちびく'}, {q:'銅',a:'どう'}, {q:'徳',a:'とく'}, {q:'独',a:'ひとり'}, {q:'任',a:'まかせる'}, {q:'認',a:'みとめる'}, {q:'熱',a:'あつい'}, {q:'貿',a:'ぼう'}, {q:'備',a:'そなえる'}, {q:'俵',a:'たわら'}, 
                    {q:'評',a:'ひょう'}, {q:'貧',a:'まずしい'}, {q:'布',a:'ぬの'}, {q:'婦',a:'ふ'}, {q:'武',a:'ぶ'}, {q:'複',a:'ふく'}, {q:'仏',a:'ほとけ'}, {q:'編',a:'あむ'}, {q:'弁',a:'べん'}, {q:'保',a:'たもつ'}, 
                    {q:'墓',a:'はか'}, {q:'報',a:'むくいる'}, {q:'豊',a:'ゆたか'}, {q:'防',a:'ふせぐ'}, {q:'脈',a:'みゃく'}, {q:'務',a:'つとめる'}, {q:'無',a:'ない'}, {q:'迷',a:'まよう'}, {q:'綿',a:'わた'}, {q:'輸',a:'ゆ'}, 
                    {q:'余',a:'あまる'}, {q:'容',a:'よう'}, {q:'溶',a:'とける'}, {q:'腰',a:'こし'}, {q:'預',a:'あずける'}, {q:'覧',a:'らん'}, {q:'略',a:'りゃく'}, {q:'留',a:'とめる'}, {q:'領',a:'りょう'}
                ]
            },
            'g6': {
                name: '小学6年生<small>(全 191 字)</small>',
                data: [
                    {q:'異',a:'こと'}, {q:'遺',a:'のこす'}, {q:'域',a:'いき'}, {q:'宇',a:'う'}, {q:'映',a:'うつる'}, {q:'延',a:'のびる'}, {q:'沿',a:'そう'}, {q:'我',a:'われ'}, {q:'灰',a:'はい'}, {q:'拡',a:'ひろげる'}, 
                    {q:'革',a:'かわ'}, {q:'閣',a:'かく'}, {q:'割',a:'わる'}, {q:'株',a:'かぶ'}, {q:'干',a:'ほす'}, {q:'巻',a:'まく'}, {q:'看',a:'かん'}, {q:'簡',a:'かん'}, {q:'危',a:'あぶない'}, {q:'机',a:'つくえ'}, 
                    {q:'揮',a:'ふるう'}, {q:'貴',a:'たっとい'}, {q:'疑',a:'うたがう'}, {q:'吸',a:'すう'}, {q:'供',a:'そなえる'}, {q:'胸',a:'むね'}, {q:'郷',a:'きょう'}, {q:'勤',a:'つとめる'}, {q:'筋',a:'すじ'}, {q:'系',a:'けい'}, 
                    {q:'敬',a:'うやまう'}, {q:'警',a:'けい'}, {q:'劇',a:'げき'}, {q:'激',a:'はげしい'}, {q:'憲',a:'けん'}, {q:'懸',a:'かける'}, {q: '絹',a:'きぬ'}, {q:'源',a:'みなもと'}, {q:'厳',a:'きびしい'}, {q:'己',a:'おのれ'}, 
                    {q:'呼',a:'よぶ'}, {q:'誤',a:'あやまる'}, {q:'后',a:'こう'}, {q:'孝',a:'こう'}, {q:'皇',a:'こう'}, {q:'紅',a:'べに'}, {q:'穀',a:'こく'}, {q:'骨',a:'ほね'}, {q:'困',a:'こまる'}, {q:'砂',a:'すな'}, 
                    {q:'座',a:'すわる'}, {q:'済',a:'すむ'}, {q:'裁',a:'たつ'}, {q:'策',a:'さく'}, {q:'冊',a:'さつ'}, {q:'至',a:'いたる'}, {q:'私',a:'わたし'}, {q:'姿',a:'すがた'}, {q:'視',a:'し'}, {q:'詞',a:'し'}, 
                    {q:'誌',a:'し'}, {q:'磁',a:'じ'}, {q:'射',a:'いる'}, {q:'捨',a:'すてる'}, {q:'諸',a:'しょ'}, {q:'除',a:'のぞく'}, {q:'承',a:'うけたまわる'}, {q:'将',a:'しょう'}, {q:'傷',a:'きず'}, {q:'障',a:'しょう'}, 
                    {q:'城',a:'しろ'}, {q:'蒸',a:'むす'}, {q:'針',a:'はり'}, {q:'仁',a:'じん'}, {q:'垂',a:'たれる'}, {q:'推',a:'おす'}, {q:' 寸',a:'すん'}, {q:'盛',a:'さかん'}, {q:'聖',a:'せい'}, {q:'誠',a:'まこと'}, 
                    {q:'舌',a:'した'}, {q:'宣',a:'せん'}, {q:'専',a:'もっぱら'}, {q:'泉',a:'いずみ'}, {q:'洗',a:'あらう'}, {q:'染',a:'そめる'}, {q:'善',a:'よい'}, {q:'奏',a:'かなえる'}, {q:'窓',a:'まど'}, {q:'創',a:'つくる'}, 
                    {q:'層',a:'そう'}, {q:'操',a:'あやつる'}, {q:'蔵',a:'くら'}, {q:'臓',a:'ぞう'}, {q:'存',a:'ぞん'}, {q:'尊',a:'たっとい'}, {q:'退',a:'しりぞく'}, {q:'宅',a:'たく'}, {q:'担',a:'になう'}, {q:'誕',a:'たん'}, 
                    {q:'段',a:'だん'}, {q:'暖',a:'あたたかい'}, {q:'値',a:'ね'}, {q:'宙',a:'ちゅう'}, {q:'忠',a:'ちゅう'}, {q:'著',a:'あらわす'}, {q:'庁',a:'ちょう'}, {q:'頂',a:'いただく'}, {q:'腸',a:'ちょう'}, {q:'潮',a:'しお'}, 
                    {q:'賃',a:'ちん'}, {q:'痛',a:'いたい'}, {q:'敵',a:'てき'}, {q:'展',a:'てん'}, {q:'討',a:'うつ'}, {q:'党',a:'とう'}, {q: '糖',a:'とう'}, {q:'届',a:'とどける'}, {q:'難',a:'むずかしい'}, {q:'乳',a:'ちち'}, 
                    {q:'認',a:'みとめる'}, {q:'納',a:'おさめる'}, {q:'脳',a:'のう'}, {q:'派',a:'は'}, {q:'拝',a:'おがむ'}, {q:'肺',a:'はい'}, {q:'背',a:'せ'}, {q:'班',a:'はん'}, {q:'貿',a:'ぼう'}, {q:'寄',a:'よる'}, 
                    {q:'氷',a:'こおり'}, {q:'俵',a:'たわら'}, {q:'秒',a:'びょう'}, {q:'貧',a:'まずしい'}, {q:'捨',a:'すてる'}, {q:'Budget',a:'よさん'}, {q:'Typical',a:'てんけいてき'}, {q:'Attitude',a:'たいど'}, {q:'Propose',a:'ていあん'}, {q:'Found',a:'みつかる'}, 
                    {q: 'Fulfill',a:'はたす'}, {q:'Stage',a:'ぶたい'}, {q:'Setting',a:'せってい'}, {q:'Rain',a:'あめ'}, {q:'Column',a:'コラム'}, {q:'Stomach',a:'い'}, {q:'Deny',a:'ひてい'}, {q:'Normal',a:'ふつう'}, {q:'Wish',a:'ねがい'}, {q:'Return',a:'かえす'}
                ]
            }
        };
        // --- 資料庫結束 (共 1026 詞) ---

        // [V2.1 修正] 採用您範例中的穩定載入邏輯
        function kgq_v2_initializeQuiz() {
            const app = document.getElementById('kanji-grade-quiz-v2'); 
            if (!app) {
                console.error("KGQ V2: Container #kanji-grade-quiz-v2 not found.");
                return;
            }

            // --- 元素獲取 (使用 ID) ---
            const screens = {
                levelSelect: app.querySelector('#kgq-v2-screen-level-select'),
                quiz: app.querySelector('#kgq-v2-screen-quiz'),
                score: app.querySelector('#kgq-v2-screen-score')
            };
            
            const elements = {
                categoryBtnContainer: app.querySelector('#kgq-v2-level-grid'),
                restartBtn: app.querySelector('#kgq-v2-restart-btn'),
                backToMenuBtnScore: app.querySelector('#kgq-v2-back-to-menu-score'),
                nextBtn: app.querySelector('#kgq-v2-next-btn'),
                questionCounter: app.querySelector('#kgq-v2-question-counter'),
                scoreCounter: app.querySelector('#kgq-v2-score-counter'),
                questionText: app.querySelector('#kgq-v2-question-text'),
                optionsContainer: app.querySelector('#kgq-v2-options-container'),
                feedbackContainer: app.querySelector('#kgq-v2-feedback-container'),
                feedbackText: app.querySelector('#kgq-v2-feedback-text'),
                answerPair: app.querySelector('#kgq-v2-answer-pair')
            };
            
            const scoreDisplay = app.querySelector('#kgq-v2-final-score'); 
            
            // --- 遊戲狀態 ---
            let currentQuizData = []; 
            let currentQuestions = [];
            let score = 0;
            let currentQuestionIndex = 0;
            const QUESTIONS_PER_GAME = 10; 
            let currentCategory = 'g1'; 

            // --- 函數定義 ---
            
            function kgq_v2_shuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function kgq_v2_showScreen(screenId) {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                const screenEl = app.querySelector(`#${screenId}`);
                if (screenEl) screenEl.classList.add('active');
            }

            // 動態生成 6 個學年按鈕
            function kgq_v2_populateCategories() {
                elements.categoryBtnContainer.innerHTML = '';
                for (const [key, value] of Object.entries(kgq_v2_quizData)) {
                    const btn = document.createElement('button');
                    btn.className = 'kgq-v2-level-btn';
                    btn.dataset.category = key;
                    btn.innerHTML = value.name; // Use innerHTML to render <small> tag
                    elements.categoryBtnContainer.appendChild(btn);
                }
            }

            function kgq_v2_startGame(category) {
                if (!kgq_v2_quizData[category]) {
                     console.error(`KGQ V2: Category "${category}" not found.`);
                     return;
                }
                currentCategory = category;
                currentQuizData = kgq_v2_quizData[category].data;
                score = 0;
                currentQuestionIndex = 0;
                
                currentQuestions = kgq_v2_shuffle([...currentQuizData]).slice(0, QUESTIONS_PER_GAME); 
                
                kgq_v2_showScreen('kgq-v2-screen-quiz');
                kgq_v2_showQuestion();
            }

            function kgq_v2_showQuestion() {
                elements.feedbackContainer.style.display = 'none';
                elements.nextBtn.style.display = 'none';
                elements.optionsContainer.innerHTML = '';
                
                const q = currentQuestions[currentQuestionIndex];
                
                elements.questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${QUESTIONS_PER_GAME}`;
                elements.scoreCounter.textContent = `スコア: ${score}`;
                elements.questionText.textContent = q.q; // 顯示漢字
                
                const correctAnswer = q.a; // 日文讀音
                const fakes = [];
                // 從當前分類的題庫中過濾掉正確答案
                const pool = currentQuizData.filter(word => word.a !== correctAnswer);
                kgq_v2_shuffle(pool); 
                
                // 添加 3 個 Fakes
                for (let i = 0; i < 3; i++) {
                    if (pool[i] && pool[i].a) {
                         fakes.push(pool[i].a);
                    } else {
                         // 備用，防止題庫太小
                         const randomFake = kgq_v2_quizData.g1.data[Math.floor(Math.random() * kgq_v2_quizData.g1.data.length)].a;
                         if(randomFake !== correctAnswer) fakes.push(randomFake);
                    }
                }
                
                const options = kgq_v2_shuffle([correctAnswer, ...fakes]);
                
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'kgq-v2-option-btn';
                    btn.textContent = option; // 顯示日文選項
                    btn.dataset.answer = option;
                    elements.optionsContainer.appendChild(btn);
                });
            }

            function kgq_v2_checkAnswer(selectedBtn, selectedAnswer) {
                elements.optionsContainer.querySelectorAll('.kgq-v2-option-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                const q = currentQuestions[currentQuestionIndex];
                const correctAnswer = q.a; 

                // 顯示解說
                elements.answerPair.textContent = `正解： ${q.q} ( ${q.a} )`;
                elements.feedbackContainer.style.display = 'block';

                if (selectedAnswer === correctAnswer) {
                    score++;
                    selectedBtn.classList.add('correct');
                    elements.feedbackText.textContent = '正解！';
                    elements.feedbackText.className = 'kgq-v2-feedback-text correct';
                } else {
                    selectedBtn.classList.add('wrong');
                    const correctBtn = elements.optionsContainer.querySelector(`[data-answer="${correctAnswer}"]`);
                    if (correctBtn) {
                        correctBtn.classList.add('correct');
                    }
                    elements.feedbackText.textContent = '不正解...';
                    elements.feedbackText.className = 'kgq-v2-feedback-text wrong';
                }

                elements.scoreCounter.textContent = `スコア: ${score}`;

                if (currentQuestionIndex < QUESTIONS_PER_GAME - 1) {
                    elements.nextBtn.textContent = '次の問題へ';
                } else {
                    elements.nextBtn.textContent = '結果を見る';
                }
                elements.nextBtn.style.display = 'block'; 
            }
            
            function kgq_v2_nextQuestion() {
                currentQuestionIndex++;
                if (currentQuestionIndex < QUESTIONS_PER_GAME) {
                    kgq_v2_showQuestion();
                } else {
                    kgq_v2_showScore();
                }
            }

            function kgq_v2_showScore() {
                kgq_v2_showScreen('kgq-v2-screen-score');
                scoreDisplay.textContent = `${QUESTIONS_PER_GAME}問中 ${score}問`;
            }

            // --- 事件綁定 ---
            if (elements.categoryBtnContainer) {
                 elements.categoryBtnContainer.addEventListener('click', function(e) {
                     const targetBtn = e.target.closest('.kgq-v2-level-btn');
                     if (targetBtn && targetBtn.dataset.category) {
                         kgq_v2_startGame(targetBtn.dataset.category);
                     }
                 });
            }

            if (elements.restartBtn) {
                 elements.restartBtn.addEventListener('click', function() {
                      kgq_v2_startGame(currentCategory); 
                 });
            }
            
            if (elements.backToMenuBtnScore) {
                 elements.backToMenuBtnScore.addEventListener('click', function() {
                     kgq_v2_showScreen('kgq-v2-screen-level-select');
                 });
            }
            
            if (elements.nextBtn) {
                 elements.nextBtn.addEventListener('click', kgq_v2_nextQuestion);
            }
            
            if (elements.optionsContainer) {
                elements.optionsContainer.addEventListener('click', function(e) {
                    const targetBtn = e.target.closest('.kgq-v2-option-btn');
                    if (targetBtn && !targetBtn.disabled) {
                        kgq_v2_checkAnswer(targetBtn, targetBtn.dataset.answer);
                    }
                });
            }
            
            // --- 初始化 ---
            kgq_v2_populateCategories(); // 載入 6 個學年按鈕

        } // --- End of kgq_v2_initializeQuiz ---

        // [V2.1 修正] 檢查頁面載入狀態
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', kgq_v2_initializeQuiz);
        } else {
            // DOM 已載入，立即執行
            kgq_v2_initializeQuiz();
        }

    })();
    </script>
</body>
</html>
