<div id="warikan-fixed-app-jp"> <style>
        /* --- 核心重置與隔離 (使用 .warikan-fx- 前綴) --- */
        #warikan-fixed-app-jp {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
            line-height: 1.6 !important;
            background-color: #ffffff !important; 
            border: 1px solid #e5e7eb !important;
            border-radius: 0.75rem !important;
            padding: 2rem !important;
            margin: 2rem auto !important;
            max-width: 700px !important; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05) !important;
            overflow: hidden;
        }
        #warikan-fixed-app-jp *, 
        #warikan-fixed-app-jp *::before, 
        #warikan-fixed-app-jp *::after {
            box-sizing: border-box !important;
            margin: 0;
            padding: 0;
        }

        /* --- 標題 --- */
        #warikan-fixed-app-jp h2 {
            color: #B45309 !important; 
            text-align: center !important;
            font-size: 1.75rem !important;
            font-weight: 700 !important;
            margin-bottom: 0.5rem !important;
        }
        #warikan-fixed-app-jp .warikan-fx-subtitle {
            text-align: center !important;
            font-size: 1rem !important;
            color: #4b5563 !important;
            margin-bottom: 2rem !important;
        }

        /* --- 輸入區域布局 --- */
        #warikan-fixed-app-jp .warikan-fx-input-group label {
            display: block !important;
            font-weight: 600 !important;
            color: #374151 !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.9rem !important;
        }
        #warikan-fixed-app-jp .warikan-fx-input,
        #warikan-fixed-app-jp .warikan-fx-select {
            width: 100% !important;
            padding: 0.75rem 1rem !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            background-color: #fff !important;
            color: #1f2937 !important;
             -webkit-appearance: none !important; 
             appearance: none !important;
        }
         #warikan-fixed-app-jp .warikan-fx-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
             background-position: right 0.5rem center !important;
             background-repeat: no-repeat !important;
             background-size: 1.5em 1.5em !important;
             padding-right: 2.5rem !important; 
         }

        /* --- 群組設定區域 --- */
         #warikan-fixed-app-jp h3 {
             font-size: 1.25rem !important;
             font-weight: 600 !important;
             color: #1f2937 !important;
             margin-top: 2rem !important;
             margin-bottom: 1rem !important;
             padding-bottom: 0.5rem !important;
             border-bottom: 1px solid #e5e7eb !important;
         }
        #warikan-fixed-app-jp .warikan-fx-group-row {
            display: grid !important;
             /* [V2.1 調整] 固定組別，移除刪除按鈕空間 */
            grid-template-columns: 1fr 80px 80px !important; /* 名稱 人數 比率 */
            gap: 0.75rem !important;
            align-items: center !important;
            margin-bottom: 1rem !important;
            padding-bottom: 1rem !important;
            border-bottom: 1px dotted #d1d5db !important;
        }
         #warikan-fixed-app-jp .warikan-fx-group-row:last-child {
             border-bottom: none !important;
             margin-bottom: 0 !important;
         }
         #warikan-fixed-app-jp .warikan-fx-group-row label { display: none !important; }
         #warikan-fixed-app-jp .warikan-fx-group-name { 
             width: 100% !important; 
             /* [V2.1] 使名稱欄位不可編輯 */
             background-color: #f3f4f6 !important; 
             border: 1px solid #e5e7eb !important;
             font-weight: 500 !important;
             color: #374151 !important;
             cursor: default !important;
         } 
         #warikan-fixed-app-jp .warikan-fx-group-people,
         #warikan-fixed-app-jp .warikan-fx-group-ratio { width: 100% !important; text-align: right !important; }
        
        /* [V2.1 移除] 刪除按鈕樣式 */
        /* [V2.1 移除] 添加按鈕樣式 */

        /* --- 人數匯總 --- */
        #warikan-fixed-app-jp .warikan-fx-people-summary {
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            text-align: right !important;
            color: #4b5563 !important;
            margin-top: 1rem !important;
        }
         #warikan-fixed-app-jp .warikan-fx-people-summary span { color: #1f2937 !important; } 

        /* --- 計算按鈕 --- */
        #warikan-fixed-app-jp .warikan-fx-calculate-btn { /* (樣式不變) */
            display: block !important; width: 100% !important; max-width: 300px !important; margin: 2.5rem auto 0 auto !important; padding: 1rem !important; font-size: 1.25rem !important; font-weight: 700 !important; color: #ffffff !important; background-color: #B45309 !important; border: none !important; border-radius: 0.5rem !important; cursor: pointer !important; transition: background-color 0.2s, transform 0.1s !important; 
        }
        #warikan-fixed-app-jp .warikan-fx-calculate-btn:hover { background-color: #92400e !important; }
        #warikan-fixed-app-jp .warikan-fx-calculate-btn:active { transform: scale(0.98) !important; }

        /* --- 錯誤訊息 --- */
         #warikan-fixed-app-jp .warikan-fx-error-message { /* (樣式不變) */
             color: #b91c1c !important; background-color: #fee2e2 !important; border: 1px solid #f87171 !important; padding: 1rem !important; border-radius: 0.5rem !important; text-align: center !important; margin-top: 1.5rem !important; display: none; 
         }

        /* --- 結果區域 --- */
        #warikan-fixed-app-jp .warikan-fx-results-area { /* (樣式不變) */
            margin-top: 2.5rem !important; padding-top: 2rem !important; border-top: 2px solid #B45309 !important; display: none; animation: fadeInJhsKqV1 0.5s ease-in-out !important; 
        }
         #warikan-fixed-app-jp .warikan-fx-results-area h3 { text-align: center !important; margin-bottom: 1.5rem !important; }
        #warikan-fixed-app-jp .warikan-fx-result-group { background-color: #f9fafb !important; border: 1px solid #e5e7eb !important; border-radius: 0.5rem !important; padding: 1.5rem !important; margin-bottom: 1rem !important; }
         #warikan-fixed-app-jp .warikan-fx-result-group-header { font-weight: 600 !important; color: #111827 !important; margin-bottom: 0.75rem !important; font-size: 1.1rem !important; }
         #warikan-fixed-app-jp .warikan-fx-result-details { display: flex !important; justify-content: space-between !important; align-items: baseline !important; font-size: 1rem !important; color: #374151 !important; margin-bottom: 0.5rem !important; }
         #warikan-fixed-app-jp .warikan-fx-result-details .amount { font-size: 1.25rem !important; font-weight: 600 !important; color: #B45309 !important; }
         #warikan-fixed-app-jp .warikan-fx-result-summary { margin-top: 2rem !important; padding-top: 1rem !important; border-top: 1px dashed #d1d5db !important; font-size: 1.1rem !important; font-weight: 600 !important; text-align: right !important; color: #1f2937 !important; }
         #warikan-fixed-app-jp .warikan-fx-result-summary div { margin-bottom: 0.5rem !important; }
         #warikan-fixed-app-jp .warikan-fx-result-summary .total-collected { color: #059669 !important; }
         #warikan-fixed-app-jp .warikan-fx-result-summary .difference { color: #ca8a04 !important; }

        /* --- 響應式調整 --- */
        @media (max-width: 640px) { /* (樣式不變) */
            #warikan-fixed-app-jp { padding: 1.5rem !important; } #warikan-fixed-app-jp h2 { font-size: 1.5rem !important; } 
             #warikan-fixed-app-jp .warikan-fx-group-row { grid-template-columns: 1fr 65px 65px !important; gap: 0.5rem !important; }
             #warikan-fixed-app-jp .warikan-fx-group-people, #warikan-fixed-app-jp .warikan-fx-group-ratio { font-size: 0.9rem !important; padding: 0.6rem !important; }
        }
         @media (max-width: 420px) { /* (樣式不變) */
              #warikan-fixed-app-jp .warikan-fx-group-row { grid-template-columns: 1fr 55px 55px !important; }
               #warikan-fixed-app-jp .warikan-fx-group-people, #warikan-fixed-app-jp .warikan-fx-group-ratio { padding: 0.5rem 0.4rem !important; }
         }
    </style>

    <h2>飲み会 割り勘 計算機 <span style="font-size: 1rem; color: #6b7280;">(固定グループ版)</span></h2>
    <p class="warikan-fx-subtitle">人数と比率を調整して公平な割り勘計算を！</p>

    <div class="warikan-fx-input-group" style="margin-bottom: 2rem;">
        <label for="warikan-fx-total-amount">支払総額 (円)</label>
        <input type="number" id="warikan-fx-total-amount" class="warikan-fx-input" placeholder="例: 30000" min="0" step="1">
    </div>
    
    <h3>グループ分けと比率設定</h3>
    <div id="warikan-fx-groups-container">
        <div class="warikan-fx-group-row">
            <div class="warikan-fx-input-group">
                <label for="group-name-0">グループ名</label>
                <input type="text" id="group-name-0" class="warikan-fx-input warikan-fx-group-name" value="上司" readonly>
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-people-0">人数</label>
                <input type="number" id="group-people-0" class="warikan-fx-input warikan-fx-group-people" placeholder="人数" min="0" step="1">
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-ratio-0">比率</label>
                <input type="number" id="group-ratio-0" class="warikan-fx-input warikan-fx-group-ratio" placeholder="比率" value="1.5" step="0.1" min="0">
            </div>
        </div>
         <div class="warikan-fx-group-row">
            <div class="warikan-fx-input-group">
                <label for="group-name-1">グループ名</label>
                <input type="text" id="group-name-1" class="warikan-fx-input warikan-fx-group-name" value="先輩" readonly>
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-people-1">人数</label>
                <input type="number" id="group-people-1" class="warikan-fx-input warikan-fx-group-people" placeholder="人数" min="0" step="1">
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-ratio-1">比率</label>
                <input type="number" id="group-ratio-1" class="warikan-fx-input warikan-fx-group-ratio" placeholder="比率" value="1.2" step="0.1" min="0">
            </div>
        </div>
        <div class="warikan-fx-group-row">
            <div class="warikan-fx-input-group">
                <label for="group-name-2">グループ名</label>
                <input type="text" id="group-name-2" class="warikan-fx-input warikan-fx-group-name" value="一般" readonly>
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-people-2">人数</label>
                <input type="number" id="group-people-2" class="warikan-fx-input warikan-fx-group-people" placeholder="人数" min="0" step="1">
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-ratio-2">比率</label>
                <input type="number" id="group-ratio-2" class="warikan-fx-input warikan-fx-group-ratio" placeholder="比率" value="1.0" step="0.1" min="0">
            </div>
        </div>
         <div class="warikan-fx-group-row">
            <div class="warikan-fx-input-group">
                <label for="group-name-3">グループ名</label>
                <input type="text" id="group-name-3" class="warikan-fx-input warikan-fx-group-name" value="後輩" readonly>
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-people-3">人数</label>
                <input type="number" id="group-people-3" class="warikan-fx-input warikan-fx-group-people" placeholder="人数" min="0" step="1">
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-ratio-3">比率</label>
                <input type="number" id="group-ratio-3" class="warikan-fx-input warikan-fx-group-ratio" placeholder="比率" value="0.8" step="0.1" min="0">
            </div>
        </div>
         <div class="warikan-fx-group-row">
            <div class="warikan-fx-input-group">
                <label for="group-name-4">グループ名</label>
                <input type="text" id="group-name-4" class="warikan-fx-input warikan-fx-group-name" value="飲まない人" readonly>
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-people-4">人数</label>
                <input type="number" id="group-people-4" class="warikan-fx-input warikan-fx-group-people" placeholder="人数" min="0" step="1">
            </div>
            <div class="warikan-fx-input-group">
                <label for="group-ratio-4">比率</label>
                <input type="number" id="group-ratio-4" class="warikan-fx-input warikan-fx-group-ratio" placeholder="比率" value="0.5" step="0.1" min="0">
            </div>
        </div>
    </div>
    <div id="warikan-fx-people-summary" class="warikan-fx-people-summary">グループ合計人数: <span>0</span> 人</div>

    <div class="warikan-fx-input-group" style="margin-top: 2rem;">
        <label for="warikan-fx-rounding-unit">一人あたりの金額を切り上げる単位</label>
        <select id="warikan-fx-rounding-unit" class="warikan-fx-select">
            <option value="1">1円単位 (そのまま)</option>
            <option value="10">10円単位</option>
            <option value="100" selected>100円単位</option>
            <option value="1000">1000円単位</option>
        </select>
    </div>

    <button id="warikan-fx-calculate-btn" class="warikan-fx-calculate-btn">計算する</button>

     <div id="warikan-fx-error-message" class="warikan-fx-error-message"></div>

    <div id="warikan-fx-results-area" class="warikan-fx-results-area">
        <h3>計算結果</h3>
        <div id="warikan-fx-results-list">
            </div>
        <div id="warikan-fx-results-summary" class="warikan-fx-result-summary">
             </div>
    </div>

</div>

<script>
// 規範 1.3 & 1.6：使用 DOMContentLoaded 和 IIFE
document.addEventListener('DOMContentLoaded', function() {
    (function() {

        /**
         * WarikanFixedGroupCalculator (飲み会 割り勘 V2.1 - 固定組別版)
         */
        const WarikanFixedGroupCalculator = {
            elements: {},

            // --- 初始化 ---
            init: function() {
                const app = document.getElementById('warikan-fixed-app-jp'); // 使用新 ID
                if (!app) { console.error("WarikanFixed: Container not found."); return; }

                this.elements = {
                    app: app,
                    totalAmountInput: app.querySelector('#warikan-fx-total-amount'),
                    groupsContainer: app.querySelector('#warikan-fx-groups-container'),
                    // [V2.1 移除] addGroupBtn
                    peopleSummary: app.querySelector('#warikan-fx-people-summary span'),
                    roundingUnitSelect: app.querySelector('#warikan-fx-rounding-unit'),
                    calculateBtn: app.querySelector('#warikan-fx-calculate-btn'),
                    errorMessage: app.querySelector('#warikan-fx-error-message'),
                    resultsArea: app.querySelector('#warikan-fx-results-area'),
                    resultsList: app.querySelector('#warikan-fx-results-list'),
                    resultsSummary: app.querySelector('#warikan-fx-results-summary')
                };

                if (!this.elements.totalAmountInput || !this.elements.groupsContainer || !this.elements.calculateBtn || !this.elements.resultsArea || !this.elements.peopleSummary) {
                    console.error("WarikanFixed: Core UI elements missing.");
                    app.innerHTML = '<p style="color: red; text-align: center;">エラー: 計算ツールの読み込みに失敗しました。</p>';
                    return;
                }
                
                this.bindEvents();
                this.updatePeopleSummary(); // 初始化總人數
            },

            // --- 事件綁定 ---
            bindEvents: function() {
                // [V2.1 移除] addGroupBtn 事件
                // [V2.1 移除] removeGroupBtn 事件

                // 人數變化時更新總數
                this.elements.groupsContainer.addEventListener('input', (e) => {
                    // 監聽所有人數輸入框的 input 事件
                    if (e.target.classList.contains('warikan-fx-group-people')) {
                        this.updatePeopleSummary();
                    }
                });
                this.elements.calculateBtn.addEventListener('click', () => this.calculateWarikan());
                 // 輸入時隱藏錯誤
                 this.elements.app.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('input', () => { this.elements.errorMessage.style.display = 'none'; });
                 });
            },

            // [V2.1 移除] addGroupRow
            // [V2.1 移除] removeGroupRow
            // [V2.1 移除] updateRemoveButtonStates

            // --- 驗證與計算 ---
             updatePeopleSummary: function() {
                 let groupPeopleSum = 0;
                 // 直接查詢所有固定的人數輸入框
                 this.elements.groupsContainer.querySelectorAll('.warikan-fx-group-people').forEach(input => {
                     groupPeopleSum += parseInt(input.value, 10) || 0;
                 });
                 if(this.elements.peopleSummary){
                     this.elements.peopleSummary.textContent = groupPeopleSum;
                 }
                 return groupPeopleSum; // 返回總數，方便計算時使用
             },

            showError: function(message) {
                 this.elements.errorMessage.textContent = message;
                 this.elements.errorMessage.style.display = 'block';
                 this.elements.resultsArea.style.display = 'none'; 
            },

            calculateWarikan: function() {
                this.elements.errorMessage.style.display = 'none'; 

                // 1. 獲取總金額
                const totalAmount = parseFloat(this.elements.totalAmountInput.value);
                if (isNaN(totalAmount) || totalAmount < 0) { 
                    this.showError('支払総額を正しく入力してください（0以上）。');
                    return;
                }
                
                // 2. 獲取群組數據並驗證
                const groups = [];
                let totalWeightedUnits = 0;
                let totalPeopleInGroups = 0; // 從 updatePeopleSummary 獲取或重新計算
                let validGroups = true;
                
                // 直接遍歷固定的群組行
                this.elements.groupsContainer.querySelectorAll('.warikan-fx-group-row').forEach((row, index) => {
                    const nameInput = row.querySelector('.warikan-fx-group-name'); // 雖然 readonly，但還是獲取一下名字
                    const peopleInput = row.querySelector('.warikan-fx-group-people');
                    const ratioInput = row.querySelector('.warikan-fx-group-ratio');

                    if(!nameInput || !peopleInput || !ratioInput) {
                        console.error(`WarikanFixed: Row ${index} elements missing.`);
                        this.showError(`グループ ${index + 1} の入力欄が見つかりません。`);
                        validGroups = false;
                        return; // 跳過此行處理
                    }

                    const name = nameInput.value.trim() || `グループ${index + 1}`; // 獲取預設名稱
                    const people = parseInt(peopleInput.value, 10);
                    const ratio = parseFloat(ratioInput.value);

                    // 允許人數為 0
                    if (isNaN(people) || people < 0) { 
                         this.showError(`「${name}」の人数を正しく入力してください（0以上）。`);
                         validGroups = false;
                         return; 
                    }
                    if (isNaN(ratio) || ratio < 0) {
                        this.showError(`「${name}」の比率を正しく入力してください（0以上）。`);
                        validGroups = false;
                        return; 
                    }
                    
                    groups.push({ name, people, ratio });
                    if (people > 0) { 
                         totalWeightedUnits += people * ratio;
                    }
                    totalPeopleInGroups += people; 
                });

                if (!validGroups) return; 

                 // 重新驗證總人數，確保與匯總一致
                 if (totalPeopleInGroups !== this.updatePeopleSummary()) {
                      console.warn("WarikanFixed: 人數匯總與計算時不一致，重新更新");
                      totalPeopleInGroups = this.updatePeopleSummary();
                 }

                if (totalPeopleInGroups <= 0) {
                    this.showError('参加人数が0人です。各グループの人数を入力してください。');
                    return;
                }
                 if (totalWeightedUnits <= 0 && totalAmount > 0) {
                     this.showError('支払い比率の合計が0以下か、参加者の比率が全て0です。比率を正しく設定してください。');
                     return;
                 }


                // 3. 計算
                const roundingUnit = parseInt(this.elements.roundingUnitSelect.value, 10);
                let results = [];
                let totalCollected = 0;
                const costPerUnit = (totalWeightedUnits > 0) ? totalAmount / totalWeightedUnits : 0; 

                groups.forEach(group => {
                    let perPersonIdeal = 0;
                    let perPersonActual = 0;
                    let groupTotal = 0;
                    
                    if (group.people > 0 && totalWeightedUnits > 0) { 
                         perPersonIdeal = costPerUnit * group.ratio;
                         perPersonActual = Math.ceil(perPersonIdeal / roundingUnit) * roundingUnit;
                         groupTotal = perPersonActual * group.people;
                         totalCollected += groupTotal;
                    } 

                    results.push({
                        name: group.name,
                        people: group.people,
                        ratio: group.ratio,
                        perPersonAmount: perPersonActual, 
                        groupTotalAmount: groupTotal
                    });
                });

                const difference = totalCollected - totalAmount;

                // 4. 顯示結果
                this.displayResults(results, totalCollected, totalAmount, difference, roundingUnit);
            },

            // --- 結果顯示 --- (與 V2 相同)
            displayResults: function(results, totalCollected, totalAmount, difference, unit) {
                 if (!this.elements.resultsList || !this.elements.resultsSummary || !this.elements.resultsArea) {
                     console.error("WarikanFixed: displayResults - results elements missing.");
                     return;
                 }
                this.elements.resultsList.innerHTML = ''; 

                results.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'warikan-fx-result-group'; // 使用 fx class

                    const header = document.createElement('div');
                    header.className = 'warikan-fx-result-group-header';
                     header.textContent = `${group.name} (${group.people}人, 比率: ${group.ratio})${group.people === 0 ? ' - 金額なし' : ''}`;
                    groupDiv.appendChild(header);

                    if (group.people > 0) {
                        const perPersonDiv = document.createElement('div');
                        perPersonDiv.className = 'warikan-fx-result-details';
                        perPersonDiv.innerHTML = `
                            <span>一人あたり:</span>
                            <span class="amount">${group.perPersonAmount.toLocaleString()} 円</span> 
                        `;
                        groupDiv.appendChild(perPersonDiv);
                        
                        const groupTotalDiv = document.createElement('div');
                        groupTotalDiv.className = 'warikan-fx-result-details';
                        groupTotalDiv.innerHTML = `
                             <span>グループ合計:</span>
                             <span>${group.groupTotalAmount.toLocaleString()} 円</span>
                        `;
                        groupDiv.appendChild(groupTotalDiv);
                    }
                    this.elements.resultsList.appendChild(groupDiv);
                });

                this.elements.resultsSummary.innerHTML = `
                    <div>支払総額: ${totalAmount.toLocaleString()} 円</div>
                    <div class="total-collected">集金合計 (${unit}円単位で切り上げ): ${totalCollected.toLocaleString()} 円</div>
                    <div class="difference">差額 (集金 - 支払い): ${difference.toLocaleString()} 円</div>
                `;

                this.elements.resultsArea.style.display = 'block'; 
            }
        };

        // --- 初始化 ---
        WarikanFixedGroupCalculator.init();

    })(); // 結束 IIFE
}); // 結束 DOMContentLoaded
</script>


