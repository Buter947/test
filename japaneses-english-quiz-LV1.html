<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【英単語クイズ V3】（日→英）5レベル対応フラッシュカード</title>

    <style>
        /* [V3] 所有 Class 均使用 ejq-v3- (English-Japanese Quiz V3) 前綴 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
            line-height: 1.6 !important;
            background-color: #f8fafc !important;
            margin: 0;
            padding: 1rem;
        }
        .ejq-v3-container {
            font-family: inherit !important;
            line-height: 1.6 !important;
            background-color: #f9fafb !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.75rem !important;
            padding: 2rem !important;
            margin: 2rem auto !important;
            max-width: 650px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05) !important;
        }
        .ejq-v3-container *, 
        .ejq-v3-container *::before, 
        .ejq-v3-container *::after {
            box-sizing: border-box !important;
        }
        .ejq-v3-container .ejq-v3-screen {
            display: none; 
            animation: fadeInEjqV3 0.3s ease-in-out !important;
        }
        .ejq-v3-container .ejq-v3-screen.active {
            display: block !important;
        }
         @keyframes fadeInEjqV3 {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
         }
        .ejq-v3-container h2 {
            color: #0284c7 !important; /* Blue Title */
            text-align: center !important;
            font-size: 2rem !important;
            font-weight: 700 !important;
            margin-top: 0 !important;
            margin-bottom: 0.5rem !important;
        }
        .ejq-v3-container h3 {
            text-align: center !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
            margin-top: 0 !important;
            margin-bottom: 1.5rem !important;
            color: #1f2937 !important;
        }
        .ejq-v3-container .ejq-v3-subtitle {
            text-align: center !important;
            font-size: 1.1rem !important;
            color: #4b5563 !important;
            margin: 0 auto 2rem auto !important;
        }
        .ejq-v3-container .ejq-v3-main-btn {
            display: block !important;
            width: 100% !important;
            max-width: 300px !important;
            margin: 2rem auto 0 auto !important;
            padding: 1rem !important;
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: #ffffff !important;
            background-color: #0284c7 !important; /* Blue */
            border: none !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            transition: background-color 0.2s, transform 0.1s !important;
        }
        .ejq-v3-container .ejq-v3-main-btn:hover { background-color: #0369a1 !important; }
        .ejq-v3-container .ejq-v3-main-btn:active { transform: scale(0.98) !important; }
        
        /* [V3] 難易度選擇畫面 */
        .ejq-v3-container .ejq-v3-level-grid {
            display: grid !important;
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }
        .ejq-v3-container .ejq-v3-level-btn {
            width: 100% !important;
            padding: 1rem !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            text-align: center;
        }
        .ejq-v3-container .ejq-v3-level-btn:hover {
            border-color: #0284c7 !important;
            color: #0284c7 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
        }
        .ejq-v3-container .ejq-v3-level-btn small {
            font-size: 0.85rem;
            color: #6b7280;
            display: block;
            font-weight: 400;
        }

        /* 測驗畫面 */
        .ejq-v3-container .ejq-v3-header {
             display: flex; 
             justify-content: space-between; 
             align-items: center; 
             margin-bottom: 1rem; 
             color: #4a5568; 
             font-weight: 600;
        }
         .ejq-v3-container .ejq-v3-header-btn {
             font-size: 0.9rem;
             color: #0284c7;
             cursor: pointer;
             background: none;
             border: none;
             padding: 0.25rem;
         }
         .ejq-v3-container .ejq-v3-header-btn:hover {
             text-decoration: underline;
         }
        
        .ejq-v3-container .ejq-v3-question-counter {
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
        }
        .ejq-v3-container .ejq-v3-score-counter {
             font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
        }
        
        .ejq-v3-container .ejq-v3-question-text {
            font-size: 2.25rem !important; 
            font-weight: 700 !important;
            color: #111827 !important;
            text-align: center;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 2.5rem 1.5rem;
            margin-bottom: 2rem;
            min-height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ejq-v3-container .ejq-v3-options-container {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 1rem !important;
        }
        .ejq-v3-container .ejq-v3-option-btn {
            width: 100% !important;
            padding: 1rem !important;
            font-size: 1.25rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            text-align: center;
            min-height: 80px; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ejq-v3-container .ejq-v3-option-btn:not(:disabled):hover {
            border-color: #0284c7 !important;
            color: #0284c7 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
        }
        .ejq-v3-container .ejq-v3-option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .ejq-v3-container .ejq-v3-option-btn.correct {
            background-color: #dcfce7 !important;
            border-color: #16a34a !important;
            color: #15803d !important;
            font-weight: 700 !important;
        }
        .ejq-v3-container .ejq-v3-option-btn.wrong {
            background-color: #fee2e2 !important;
            border-color: #dc2626 !important;
            color: #b91c1c !important;
            opacity: 1 !important;
        }
        
        .ejq-v3-container .ejq-v3-feedback-container {
            display: none;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1.5rem; 
            text-align: center;
            animation: fadeInEjqV3 0.3s ease-in-out !important;
        }
        .ejq-v3-container .ejq-v3-feedback-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
        }
        .ejq-v3-container .ejq-v3-feedback-text.correct { color: #16a34a; }
        .ejq-v3-container .ejq-v3-feedback-text.wrong { color: #dc2626; }
        
        .ejq-v3-container .ejq-v3-answer-details {
            text-align: left;
        }
        .ejq-v3-container .ejq-v3-answer-pair {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .ejq-v3-container .ejq-v3-answer-example {
            font-size: 1rem;
            font-weight: 500;
            color: #4b5563;
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        .ejq-v3-container .ejq-v3-next-btn {
            display: none; 
            width: 100%;
            background-color: #0284c7;
            margin: 1.5rem auto 0 auto; /* [V3] 修正 margin */
            max-width: 300px;
        }
        .ejq-v3-container .ejq-v3-next-btn:hover {
            background-color: #0369a1;
        }
        
        /* 結果畫面 */
        .ejq-v3-container .ejq-v3-score-display {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        }
         .ejq-v3-container .ejq-v3-score-display .score {
             font-size: 3rem;
             font-weight: 700;
             color: #0284c7; /* Blue score */
             display: block;
             margin: 0.5rem 0;
         }
         .ejq-v3-container .ejq-v3-score-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 300px;
            margin: 2rem auto 0 auto;
         }
         .ejq-v3-container .ejq-v3-score-controls .ejq-v3-main-btn {
             margin-top: 0 !important;
         }
         .ejq-v3-container .ejq-v3-secondary-btn {
             background-color: #ffffff !important;
             color: #374151 !important;
             border: 1px solid #d1d5db !important;
         }
         .ejq-v3-container .ejq-v3-secondary-btn:hover {
             background-color: #f9fafb !important;
         }
         
         @media (max-width: 600px) {
            .ejq-v3-container {
                padding: 1.5rem !important;
                margin: 1rem auto !important;
            }
             .ejq-v3-container h2 {
                 font-size: 1.75rem !important;
             }
             .ejq-v3-container .ejq-v3-question-text {
                 font-size: 2rem !important;
             }
         }
         @media (max-width: 480px) {
             .ejq-v3-container .ejq-v3-options-container {
                 grid-template-columns: 1fr !important; /* Stack options */
             }
         }
    </style>
</head>
<body>

    <div id="eng-jp-flashcard-quiz-v3" class="ejq-v3-container">
        <div class="ejq-v3-card">
            
            <div id="ejq-v3-screen-level-select" class="ejq-v3-screen active">
                <h2>英単語クイズ</h2>
                <p class="ejq-v3-subtitle">挑戦するレベルを選んでください。</p>
                <div class="ejq-v3-level-grid">
                    <button class="ejq-v3-level-btn" data-level="level_1">入門 <small>(N5相当・基礎名詞)</small></button>
                    <button class="ejq-v3-level-btn" data-level="level_2">初級 <small>(N4相当・日常生活)</small></button>
                    <button class="ejq-v3-level-btn" data-level="level_3">中級 <small>(N3相当・抽象/社会)</small></button>
                    <button class="ejq-v3-level-btn" data-level="level_4">上級 <small>(N2相当・商務/学術)</small></button>
                    <button class="ejq-v3-level-btn" data-level="level_5">最上級 <small>(N1/Expert相当)</small></button>
                </div>
            </div>

            <div id="ejq-v3-screen-quiz" class="ejq-v3-screen">
                <div class="ejq-v3-header">
                     <span id="ejq-v3-question-counter" class="ejq-v3-question-counter"></span>
                     <span id="ejq-v3-score-counter" class="ejq-v3-score-counter"></span>
                </div>
                <div id="ejq-v3-question-text" class="ejq-v3-question-text"></div>
                <div id="ejq-v3-options-container" class="ejq-v3-options-container"></div>
                
                <button id="ejq-v3-next-btn" class="ejq-v3-main-btn ejq-v3-next-btn">次の問題へ</button>
                <div id="ejq-v3-feedback-container" class="ejq-v3-feedback-container">
                    <h3 id="ejq-v3-feedback-text" class="ejq-v3-feedback-text"></h3>
                    <div class="ejq-v3-answer-details">
                        <div id="ejq-v3-answer-pair" class="ejq-v3-answer-pair"></div>
                        <p id="ejq-v3-answer-example" class="ejq-v3-answer-example"></p>
                    </div>
                </div>
                <button id="ejq-v3-back-to-menu-quiz" class="ejq-v3-main-btn ejq-v3-secondary-btn" style="max-width: 300px; margin-top: 1rem;">レベル選択に戻る</button>
            </div>

            <div id="ejq-v3-screen-score" class="ejq-v3-screen">
                <h3>お疲れ様でした！</h3>
                <div class="ejq-v3-score-display">
                    あなたのスコア:
                    <span id="ejq-v3-final-score" class="score">10問中 8問</span>
                    正解
                </div>
                <div class="ejq-v3-score-controls">
                    <button id="ejq-v3-restart-btn" class="ejq-v3-main-btn">もう一度挑戦する</button>
                    <button id="ejq-v3-back-to-menu-score" class="ejq-v3-main-btn ejq-v3-secondary-btn">レベル選択に戻る</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 規範 1.6 (IIFE)
    (function() {
        
        // --- [V2 擴展] 核心資料庫 (100 詞) ---
        const ejq_v3_quizData = {
            'level_1': [
                { q: '犬 (いぬ)', a: 'Dog', ex: 'I have a dog. (彼は犬を飼っています)' },
                { q: '猫 (ねこ)', a: 'Cat', ex: 'The cat is sleeping. (猫が寝ています)' },
                { q: '食べる (たべる)', a: 'Eat', ex: 'I eat breakfast at 7. (7時に朝ご飯を食べます)' },
                { q: '飲む (のむ)', a: 'Drink', ex: 'Please drink water. (水を飲んでください)' },
                { q: '大きい (おおきい)', a: 'Big', ex: 'That is a big house. (あれは大きい家です)' },
                { q: '小さい (ちいさい)', a: 'Small', ex: 'This box is small. (この箱は小さいです)' },
                { q: '見る (みる)', a: 'See', ex: 'I see a bird. (鳥が見えます)' },
                { q: '行く (いく)', a: 'Go', ex: 'I go to school. (学校に行きます)' },
                { q: '来る (くる)', a: 'Come', ex: 'Please come here. (ここに来てください)' },
                { q: '学校 (がっこう)', a: 'School', ex: 'He is a student at this school. (彼はこの学校の生徒です)' },
                { q: '駅 (えき)', a: 'Station', ex: 'Where is the station? (駅はどこですか)' },
                { q: '本 (ほん)', a: 'Book', ex: 'I am reading a book. (本を読んでいます)' },
                { q: '水 (みず)', a: 'Water', ex: 'Glass of water, please. (お水を一杯ください)' },
                { q: '赤い (あかい)', a: 'Red', ex: 'She likes red flowers. (彼女は赤い花が好きです)' },
                { q: '青い (あおい)', a: 'Blue', ex: 'The sky is blue. (空は青いです)' },
                { q: '一 (いち)', a: 'One', ex: 'I have one apple. (リンゴを一つ持っています)' },
                { q: '二 (に)', a: 'Two', ex: 'Two tickets, please. (チケットを二枚ください)' },
                { q: '三 (さん)', a: 'Three', ex: 'There are three cats. (猫が三匹います)' },
                { q: '私 (わたし)', a: 'I', ex: 'I am a student. (私は学生です)' },
                { q: 'あなた', a: 'You', ex: 'Are you hungry? (お腹が空いていますか)' }
                // ... 擴展 80 N5 詞 ...
            ],
            'level_2': [ 
                { q: '買う (かう)', a: 'Buy', ex: 'I will buy milk. (牛乳を買います)' },
                { q: '読む (よむ)', a: 'Read', ex: 'She likes to read books. (彼女は本を読むのが好きです)' },
                { q: '書く (かく)', a: 'Write', ex: 'He wrote a letter. (彼は手紙を書きました)' },
                { q: '話す (はなす)', a: 'Speak', ex: 'Can you speak English? (英語を話せますか)' },
                { q: '聞く (きく)', a: 'Listen', ex: 'I listen to music. (音楽を聞きます)' },
                { q: '勉強する (べんきょうする)', a: 'Study', ex: 'I study Japanese every day. (毎日日本語を勉強します)' },
                { q: '昨日 (きのう)', a: 'Yesterday', ex: 'I was busy yesterday. (昨日は忙しかった)' },
                { q: '明日 (あした)', a: 'Tomorrow', ex: 'See you tomorrow. (また明日)' },
                { q: '時間 (じかん)', a: 'Time', ex: 'What time is it now? (今、何時ですか)' },
                { q: 'お金 (おかね)', a: 'Money', ex: 'I don\'t have money. (お金がありません)' },
                { q: '病院 (びょういん)', a: 'Hospital', ex: 'I need to go to the hospital. (病院に行かなければなりません)' },
                { q: '映画 (えいが)', a: 'Movie', ex: 'Let\'s watch a movie. (映画を見ましょう)' },
                { q: '忙しい (いそがしい)', a: 'Busy', ex: 'Are you busy now? (今、忙しいですか)' },
                { q: '難しい (むずかしい)', a: 'Difficult', ex: 'Kanji is difficult. (漢字は難しいです)' },
                { q: '易しい (やさしい)', a: 'Easy', ex: 'This book is easy. (この本は易しいです)' },
                { q: '電車 (でんしゃ)', a: 'Train', ex: 'I take the train to work. (電車で通勤します)' },
                { q: '天気 (てんき)', a: 'Weather', ex: 'The weather is nice today. (今日はいい天気です)' },
                { q: '果物 (くだもの)', a: 'Fruit', ex: 'I like to eat fruit. (果物を食べるのが好きです)' },
                { q: '服 (ふく)', a: 'Clothes', ex: 'I bought new clothes. (新しい服を買いました)' },
                { q: '家族 (かぞく)', a: 'Family', ex: 'My family lives in Tokyo. (私の家族は東京に住んでいます)' }
                // ... 擴展 80 N4 詞 ...
            ],
            'level_3': [
                { q: '情報 (じょうほう)', a: 'Information', ex: 'I need more information. (もっと情報が必要です)' },
                { q: '社会 (しゃかい)', a: 'Society', ex: 'We live in a global society. (私たちはグローバル社会に生きています)' },
                { q: '決める (きめる)', a: 'Decide', ex: 'I can\'t decide. (決められません)' },
                { q: '続ける (つづける)', a: 'Continue', ex: 'Please continue your speech. (スピーチを続けてください)' },
                { q: '経験 (けいけん)', a: 'Experience', ex: 'I have experience in sales. (私には営業の経験があります)' },
                { q: '重要 (じゅうよう)', a: 'Important', ex: 'This is very important. (これは非常に重要です)' },
                { q: '面白い (おもしろい)', a: 'Interesting', ex: 'That book was interesting. (あの本は面白かった)' },
                { q: '違う (ちがう)', a: 'Different', ex: 'My opinion is different from yours. (私の意見はあなたと違います)' },
                { q: '問題 (もんだい)', a: 'Problem', ex: 'I have a problem. (問題があります)' },
                { q: '理由 (りゆう)', a: 'Reason', ex: 'What is the reason? (理由は何ですか)' },
                { q: '結果 (けっか)', a: 'Result', ex: 'The result was successful. (結果は成功でした)' },
                { q: '計画 (けいかく)', a: 'Plan', ex: 'Do you have a plan? (計画はありますか)' },
                { q: '発展する (はってんする)', a: 'Develop', ex: 'The city will develop quickly. (その都市は急速に発展するだろう)' },
                { q: '研究 (けんきゅう)', a: 'Research', ex: 'He is doing research. (彼は研究をしています)' },
                { q: '文化 (ぶんか)', a: 'Culture', ex: 'I am interested in Japanese culture. (日本文化に興味があります)' },
                { q: '未来 (みらい)', a: 'Future', ex: 'This is a car of the future. (これは未来の車です)' },
                { q: '安全 (あんぜん)', a: 'Safety', ex: 'Safety is our top priority. (安全第一です)' },
                { q: '約束 (やくそく)', a: 'Promise', ex: 'I made a promise. (約束をしました)' },
                { q: '送る (おくる)', a: 'Send', ex: 'Please send me an email. (私にメールを送ってください)' },
                { q: '旅行 (りょこう)', a: 'Travel', ex: 'I like to travel. (旅行が好きです)' }
                // ... 擴展 80 N3 詞 ...
            ],
            'level_4': [
                { q: '環境 (かんきょう)', a: 'Environment', ex: 'We must protect the environment. (環境を守らなければならない)' },
                { q: '経済 (けいざい)', a: 'Economy', ex: 'The economy is growing. (経済は成長しています)' },
                { q: '増加する (ぞうかする)', a: 'Increase', ex: 'The population is increasing. (人口が増加している)' },
                { q: '減少する (げんしょうする)', a: 'Decrease', ex: 'The number of students decreased. (生徒数が減少した)' },
                { q: '提案する (ていあんする)', a: 'Suggest', ex: 'I suggest a new plan. (新しい計画を提案します)' },
                { q: '要求する (ようきゅうする)', a: 'Require', ex: 'This job requires special skills. (この仕事は特別なスキルを要求する)' },
                { q: '達成する (たっせいする)', a: 'Achieve', ex: 'She achieved her goal. (彼女は目標を達成した)' },
                { q: '責任 (せきにん)', a: 'Responsibility', ex: 'He has a strong sense of responsibility. (彼は責任感が強い)' },
                { q: '機会 (きかい)', a: 'Opportunity', ex: 'This is a great opportunity. (これは絶好の機会だ)' },
                { q: '政策 (せいさく)', a: 'Policy', ex: 'The government announced a new policy. (政府は新政策を発表した)' },
                { q: '分析 (ぶんせき)', a: 'Analysis', ex: 'We need a detailed analysis. (詳細な分析が必要です)' },
                { q: '証拠 (しょうこ)', a: 'Evidence', ex: 'There is no evidence. (証拠がありません)' },
                { q: '重大 (じゅうだい)', a: 'Significant', ex: 'This is a significant discovery. (これは重大な発見だ)' },
                { q: '効果的 (こうかてき)', a: 'Effective', ex: 'This method is very effective. (この方法は非常に効果的です)' },
                { q: '利用可能 (りようかのう)', a: 'Available', ex: 'Tickets are still available. (チケットはまだ利用可能です)' },
                { q: '地域社会 (ちいきしゃかい)', a: 'Community', ex: 'I am active in my local community. (私は地域社会で活動しています)' },
                { q: '資源 (しげん)', a: 'Resource', ex: 'Water is a precious resource. (水は貴重な資源です)' },
                { q: '戦略 (せんりゃく)', a: 'Strategy', ex: 'We need a new business strategy. (新しいビジネス戦略が必要だ)' },
                { q: '影響 (えいきょう)', a: 'Impact', ex: 'It had a big impact on society. (それは社会に大きな影響を与えた)' },
                { q: '金融 (きんゆう)', a: 'Financial', ex: 'He works in the financial industry. (彼は金融業界で働いている)' }
                // ... 擴展 80 N2 詞 ...
            ],
            'level_5': [
                { q: '緩和する (かんわする)', a: 'Alleviate', ex: 'This medicine will alleviate the pain. (この薬は痛みを緩和します)' },
                { q: '精査する (せいさする)', a: 'Scrutinize', ex: 'We must scrutinize the document. (我々はその文書を精査しなければならない)' },
                { q: '遍在する (へんざいする)', a: 'Ubiquitous', ex: 'Smartphones are ubiquitous today. (今日、スマートフォンは遍在している)' },
                { q: '細心の (さいしんの)', a: 'Meticulous', ex: 'She is meticulous in her work. (彼女は仕事に細心の注意を払う)' },
                { q: '難問 (なんもん)', a: 'Conundrum', ex: 'This is a difficult conundrum. (これは難問だ)' },
                { q: '格差 (かくさ)', a: 'Disparity', ex: 'There is a disparity in wealth. (富の格差が存在する)' },
                { q: '軽減する (けいげんする)', a: 'Mitigate', ex: 'We need to mitigate the risks. (リスクを軽減する必要がある)' },
                { q: '曖昧な (あいまいな)', a: 'Ambiguous', ex: 'His reply was ambiguous. (彼の返事は曖昧だった)' },
                { q: '雄弁な (ゆうべんな)', a: 'Eloquent', ex: 'She gave an eloquent speech. (彼女は雄弁なスピーチを行った)' },
                { q: '儚い (はかない)', a: 'Ephemeral', ex: 'Life is ephemeral. (命は儚いものだ)' },
                { q: '模範 (もはん)', a: 'Paradigm', ex: 'This is a new paradigm of computing. (これはコンピューティングの新しい模範だ)' },
                { q: '総意 (そうい)', a: 'Consensus', ex: 'We reached a consensus. (我々は総意に達した)' },
                { q: '持続可能 (じぞくかのう)', a: 'Sustainable', ex: 'We need sustainable energy. (持続可能なエネルギーが必要だ)' },
                { q: '相互の (そうごの)', a: 'Reciprocal', ex: 'It was a reciprocal agreement. (それは相互の合意だった)' },
                { q: '急増する (きゅうぞうする)', a: 'Proliferate', ex: 'Digital devices have proliferated. (デジタル機器が急増した)' },
                { q: '悪化する (あっかする)', a: 'Deteriorate', ex: 'His health began to deteriorate. (彼の健康は悪化し始めた)' },
                { q: '包括的な (ほうかつてきな)', a: 'Comprehensive', ex: 'We need a comprehensive review. (包括的な見直しが必要だ)' },
                { q: '革新的な (かくしんてきな)', a: 'Innovative', ex: 'That is an innovative idea. (それは革新的なアイデアだ)' },
                { q: '利益の上がる (りえきのあがる)', a: 'Lucrative', ex: 'It is a lucrative business. (それは利益の上がるビジネスだ)' },
                { q: '実用的な (じつようてきな)', a: 'Pragmatic', ex: 'We need a pragmatic approach. (実用的なアプローチが必要だ)' }
                // ... 擴展 80 N1/Expert 詞 ...
            ]
        };
        // --- 資料庫結束 (共 100 詞) ---

        // [V2.1 修正] 採用您範例中的穩定載入邏輯
        function ejq_v3_initializeQuiz() {
            // [V3 修正] 使用 ID 啟動
            const app = document.getElementById('eng-jp-flashcard-quiz-v3'); 
            if (!app) {
                console.error("EJQ V3: Container #eng-jp-flashcard-quiz-v3 not found.");
                return;
            }

            // --- 元素獲取 (使用 ID) ---
            const screens = {
                levelSelect: app.querySelector('#ejq-v3-screen-level-select'),
                quiz: app.querySelector('#ejq-v3-screen-quiz'),
                score: app.querySelector('#ejq-v3-screen-score')
            };
            
            const elements = {
                levelBtnContainer: app.querySelector('.ejq-v3-level-grid'),
                restartBtn: app.querySelector('#ejq-v3-restart-btn'),
                backToMenuBtnScore: app.querySelector('#ejq-v3-back-to-menu-score'),
                backToMenuBtnQuiz: app.querySelector('#ejq-v3-back-to-menu-quiz'),
                nextBtn: app.querySelector('#ejq-v3-next-btn'),
                questionCounter: app.querySelector('#ejq-v3-question-counter'),
                scoreCounter: app.querySelector('#ejq-v3-score-counter'),
                questionText: app.querySelector('#ejq-v3-question-text'),
                optionsContainer: app.querySelector('#ejq-v3-options-container'),
                feedbackContainer: app.querySelector('#ejq-v3-feedback-container'),
                feedbackText: app.querySelector('#ejq-v3-feedback-text'),
                answerPair: app.querySelector('.ejq-v3-answer-pair'),
                answerExample: app.querySelector('.ejq-v3-answer-example')
            };
            
            const scoreDisplay = app.querySelector('#ejq-v3-final-score'); 
            
            // --- 遊戲狀態 ---
            let currentQuizData = []; 
            let currentQuestions = [];
            let score = 0;
            let currentQuestionIndex = 0;
            const QUESTIONS_PER_GAME = 10; 
            let currentLevel = 'level_1'; 

            // --- 函數定義 ---
            
            function ejq_v3_shuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function ejq_v3_showScreen(screenId) {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                if (screens[screenId]) {
                    screens[screenId].classList.add('active');
                } else {
                    // [V3 修正] 確保 ID 匹配
                    const screenEl = app.querySelector(`#${screenId}`);
                    if (screenEl) screenEl.classList.add('active');
                }
            }

            function ejq_v3_startGame(level) {
                if (!ejq_v3_quizData[level]) {
                     console.error(`EJQ V3: Level "${level}" not found in database.`);
                     return;
                }
                currentLevel = level;
                currentQuizData = ejq_v3_quizData[level];
                score = 0;
                currentQuestionIndex = 0;
                
                currentQuestions = ejq_v3_shuffle([...currentQuizData]).slice(0, QUESTIONS_PER_GAME); 
                
                ejq_v3_showScreen('ejq-v3-screen-quiz');
                ejq_v3_showQuestion();
            }

            function ejq_v3_showQuestion() {
                elements.feedbackContainer.style.display = 'none';
                elements.nextBtn.style.display = 'none';
                elements.optionsContainer.innerHTML = '';
                
                const q = currentQuestions[currentQuestionIndex];
                
                elements.questionCounter.textContent = `問題 ${currentQuestionIndex + 1} / ${QUESTIONS_PER_GAME}`;
                elements.scoreCounter.textContent = `スコア: ${score}`;
                elements.questionText.textContent = q.q;
                
                const correctAnswer = q.a;
                const fakes = [];
                const pool = currentQuizData.filter(word => word.a !== correctAnswer);
                ejq_v3_shuffle(pool); 
                
                for (let i = 0; i < 3; i++) {
                    if (pool[i] && pool[i].a) {
                         fakes.push(pool[i].a);
                    } else {
                         const randomFake = ejq_v3_quizData.level_1[Math.floor(Math.random() * ejq_v3_quizData.level_1.length)].a;
                         if(randomFake !== correctAnswer) fakes.push(randomFake);
                    }
                }
                
                const options = ejq_v3_shuffle([correctAnswer, ...fakes]);
                
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'ejq-v3-option-btn';
                    btn.textContent = option;
                    btn.dataset.answer = option;
                    elements.optionsContainer.appendChild(btn);
                });
            }

            function ejq_v3_checkAnswer(selectedBtn, selectedAnswer) {
                elements.optionsContainer.querySelectorAll('.ejq-v3-option-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                const q = currentQuestions[currentQuestionIndex];
                const correctAnswer = q.a; 

                elements.answerPair.textContent = `正解： ${q.q} = ${q.a}`;
                elements.answerExample.textContent = `例文： ${q.ex}`;
                elements.feedbackContainer.style.display = 'block';

                if (selectedAnswer === correctAnswer) {
                    score++;
                    selectedBtn.classList.add('correct');
                    elements.feedbackText.textContent = '正解！';
                    elements.feedbackText.className = 'ejq-v3-feedback-text correct';
                } else {
                    selectedBtn.classList.add('wrong');
                    const correctBtn = elements.optionsContainer.querySelector(`[data-answer="${correctAnswer}"]`);
                    if (correctBtn) {
                        correctBtn.classList.add('correct');
                    }
                    elements.feedbackText.textContent = '不正解...';
                    elements.feedbackText.className = 'ejq-v3-feedback-text wrong';
                }

                // 更新分數顯示
                elements.scoreCounter.textContent = `スコア: ${score}`;

                if (currentQuestionIndex < QUESTIONS_PER_GAME - 1) {
                    elements.nextBtn.textContent = '次の問題へ';
                } else {
                    elements.nextBtn.textContent = '結果を見る';
                }
                elements.nextBtn.style.display = 'block';
            }
            
            function ejq_v3_nextQuestion() {
                currentQuestionIndex++;
                if (currentQuestionIndex < QUESTIONS_PER_GAME) {
                    ejq_v3_showQuestion();
                } else {
                    ejq_v3_showScore();
                }
            }

            function ejq_v3_showScore() {
                ejq_v3_showScreen('ejq-v3-screen-score');
                scoreDisplay.textContent = `${QUESTIONS_PER_GAME}問中 ${score}問`;
            }

            // --- 事件綁定 ---
            if (elements.levelBtnContainer) {
                 elements.levelBtnContainer.addEventListener('click', function(e) {
                     const targetBtn = e.target.closest('.ejq-v3-level-btn');
                     if (targetBtn && targetBtn.dataset.level) {
                         ejq_v3_startGame(targetBtn.dataset.level);
                     }
                 });
            }

            if (elements.restartBtn) {
                 elements.restartBtn.addEventListener('click', function() {
                      ejq_v3_startGame(currentLevel); // 使用儲存的 currentLevel
                 });
            }
            
            // [V3 修正] 綁定兩個返回按鈕
            if (elements.backToMenuBtnScore) {
                 elements.backToMenuBtnScore.addEventListener('click', function() {
                     ejq_v3_showScreen('ejq-v3-screen-level-select');
                 });
            }
             if (elements.backToMenuBtnQuiz) {
                 elements.backToMenuBtnQuiz.addEventListener('click', function() {
                     ejq_v3_showScreen('ejq-v3-screen-level-select');
                 });
            }
            
            if (elements.nextBtn) {
                 elements.nextBtn.addEventListener('click', ejq_v3_nextQuestion);
            }
            
            if (elements.optionsContainer) {
                elements.optionsContainer.addEventListener('click', function(e) {
                    const targetBtn = e.target.closest('.ejq-v3-option-btn');
                    if (targetBtn && !targetBtn.disabled) {
                        ejq_v3_checkAnswer(targetBtn, targetBtn.dataset.answer);
                    }
                });
            }
        } // --- End of ejq_v3_initializeQuiz ---

        // [V2.1 修正] 檢查頁面載入狀態
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', ejq_v3_initializeQuiz);
        } else {
            // DOM 已載入，立即執行
            ejq_v3_initializeQuiz();
        }

    })();
    </script>
</body>
</html>
