<div id="html-entity-tool-app">
    <script>
        // [這是您上一段提供的數據庫腳本]
        (function() {
            // ... (省略龐大的 charToEntityMap 和 entityToCharMap 定義) ...
             const charToEntityMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;', ' ': '&nbsp;', /* ... 數百個其他實體 ... */ '✓': '&check;', '✗': '&cross;' };
             const entityToCharMap = {};
             for (const char in charToEntityMap) { if (Object.prototype.hasOwnProperty.call(charToEntityMap, char)) { entityToCharMap[charToEntityMap[char]] = char; } }
             window.htmlEntityMaps = { encodeMap: charToEntityMap, decodeMap: entityToCharMap };
            console.log('[HTMLEntityApp V2 Data] Entity maps ready.'); 
        })(); 
    </script>

    <style>
        /* --- 核心重置與隔離 (使用 .het- 前綴) --- */
        #html-entity-tool-app {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
            line-height: 1.6 !important;
            background-color: #ffffff !important; 
            border: 1px solid #e5e7eb !important;
            border-radius: 0.75rem !important;
            padding: 2rem !important;
            margin: 2rem auto !important;
            max-width: 800px !important; /* 寬一點以容納兩個文本區 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05) !important;
        }
        #html-entity-tool-app *, 
        #html-entity-tool-app *::before, 
        #html-entity-tool-app *::after {
            box-sizing: border-box !important;
            margin: 0;
            padding: 0;
        }

        /* --- 標題 --- */
        #html-entity-tool-app h2 {
            color: #B45309 !important; 
            text-align: center !important;
            font-size: 1.75rem !important;
            font-weight: 700 !important;
            margin-bottom: 1.5rem !important; /* 增加底部間距 */
        }
       
        /* --- 文本區域 --- */
        #html-entity-tool-app .het-textarea-group {
            margin-bottom: 1rem !important;
        }
        #html-entity-tool-app .het-textarea-group label {
            display: block !important;
            font-weight: 600 !important;
            color: #374151 !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.9rem !important;
        }
        #html-entity-tool-app .het-textarea {
            width: 100% !important;
            min-height: 150px !important; /* 設定最小高度 */
            padding: 0.75rem 1rem !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            font-size: 0.95rem !important; /* 稍微減小字體以容納更多內容 */
            line-height: 1.6 !important;
            background-color: #fff !important;
            color: #1f2937 !important;
            resize: vertical !important; /* 允許垂直調整大小 */
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace !important; /* 等寬字體 */
        }
        #html-entity-tool-app #het-output {
             background-color: #f9fafb !important; /* 輸出區域用淺灰色背景 */
        }

        /* --- 按鈕區域 --- */
        #html-entity-tool-app .het-controls {
             display: flex !important;
             flex-wrap: wrap !important; /* 換行 */
             justify-content: center !important;
             gap: 0.75rem !important;
             margin-bottom: 1rem !important;
        }
        #html-entity-tool-app .het-button {
            padding: 0.6rem 1.2rem !important;
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 0.375rem !important;
            cursor: pointer !important;
            transition: background-color 0.2s, transform 0.1s !important;
        }
        #html-entity-tool-app .het-button:active { transform: scale(0.97) !important; }

        #html-entity-tool-app .het-button-primary { /* Encode/Decode */
            background-color: #B45309 !important; 
            color: #ffffff !important;
        }
        #html-entity-tool-app .het-button-primary:hover { background-color: #92400e !important; }

        #html-entity-tool-app .het-button-secondary { /* Clear/Copy */
             background-color: #e5e7eb !important;
             color: #374151 !important;
             border: 1px solid #d1d5db !important;
        }
         #html-entity-tool-app .het-button-secondary:hover { background-color: #d1d5db !important; }
         
         /* --- 按鈕組（用於清除/複製） --- */
         #html-entity-tool-app .het-sub-controls {
              display: flex !important;
              justify-content: flex-end !important; /* 靠右對齊 */
              gap: 0.5rem !important;
              margin-top: 0.5rem !important; /* 與文本區有點間距 */
         }
          #html-entity-tool-app .het-sub-controls .het-button-secondary {
              padding: 0.4rem 0.8rem !important; /* 小按鈕 */
              font-size: 0.85rem !important;
          }

        /* --- 錯誤訊息 --- */
         #html-entity-tool-app .het-error-message {
             color: #b91c1c !important; 
             background-color: #fee2e2 !important; 
             border: 1px solid #f87171 !important; 
             padding: 0.8rem 1rem !important; 
             border-radius: 0.375rem !important; 
             text-align: center !important; 
             margin-top: 1rem !important;
             font-size: 0.9rem !important;
             display: none; /* 預設隱藏 */
              animation: fadeInWarikanFxV1 0.3s ease-out !important; /* Reuse animation */
         }
         
         /* --- 響應式 --- */
         @media (max-width: 600px) {
              #html-entity-tool-app { padding: 1.5rem !important; }
              #html-entity-tool-app h2 { font-size: 1.5rem !important; }
              #html-entity-tool-app .het-textarea { min-height: 120px !important; font-size: 0.9rem !important;}
              #html-entity-tool-app .het-controls { justify-content: space-around !important; } /* 分散按鈕 */
         }

    </style>

    <h2>HTMLエンティティ 変換</h2>

    <div class="het-textarea-group">
        <label for="het-input">入力テキスト:</label>
        <textarea id="het-input" class="het-textarea" placeholder="ここにテキストを入力... 例: <p class='test'>© & €</p>" spellcheck="false"></textarea>
         <div class="het-sub-controls">
             <button id="het-clear-input-btn" class="het-button het-button-secondary">クリア</button>
         </div>
    </div>

    <div class="het-controls">
        <button id="het-encode-btn" class="het-button het-button-primary">エンコード &raquo;</button>
        <button id="het-decode-btn" class="het-button het-button-primary">&laquo; デコード</button>
    </div>

    <div class="het-textarea-group">
        <label for="het-output">出力結果:</label>
        <textarea id="het-output" class="het-textarea" readonly placeholder="変換結果がここに表示されます..."></textarea>
         <div class="het-sub-controls">
             <button id="het-copy-output-btn" class="het-button het-button-secondary">コピー</button>
             <button id="het-clear-output-btn" class="het-button het-button-secondary">クリア</button>
         </div>
    </div>
    
    <div id="het-error-message" class="het-error-message"></div>

</div>

<script>
// 規範 1.3 & 1.6：使用 DOMContentLoaded 和 IIFE
document.addEventListener('DOMContentLoaded', function() {
    console.log('[HTMLEntityApp V1] DOMContentLoaded fired.');

    (function() {
        console.log('[HTMLEntityApp V1] IIFE executed.');

        const appId = 'html-entity-tool-app'; 
        const app = document.getElementById(appId); 
        if (!app) { 
            console.error(`[HTMLEntityApp V1] Fatal: Container #${appId} not found.`); 
            return; 
        }

        // --- 元素查找 ---
        // 將元素查找放在 IIFE 頂部，因為這些元素結構固定且必須存在
        const inputTextArea = app.querySelector('#het-input');
        const outputTextArea = app.querySelector('#het-output');
        const encodeBtn = app.querySelector('#het-encode-btn');
        const decodeBtn = app.querySelector('#het-decode-btn');
        const clearInputBtn = app.querySelector('#het-clear-input-btn');
        const clearOutputBtn = app.querySelector('#het-clear-output-btn');
        const copyOutputBtn = app.querySelector('#het-copy-output-btn');
        const errorMessage = app.querySelector('#het-error-message');

        // --- 健壯性檢查：確保所有按鈕和文本區存在 ---
        if (!inputTextArea || !outputTextArea || !encodeBtn || !decodeBtn || !clearInputBtn || !clearOutputBtn || !copyOutputBtn || !errorMessage) {
            console.error("[HTMLEntityApp V1] Fatal: One or more essential UI elements not found during init.");
            app.innerHTML = '<p style="color: red; text-align: center;">エラー: UI要素の読み込みに失敗しました。</p>';
            return;
        }
        console.log('[HTMLEntityApp V1] All essential elements found.');

        // --- 數據庫檢查 ---
        if (typeof window.htmlEntityMaps === 'undefined' || !window.htmlEntityMaps.encodeMap || !window.htmlEntityMaps.decodeMap) {
             console.error("[HTMLEntityApp V1] Fatal: HTML Entity Maps (window.htmlEntityMaps) not found or incomplete. Make sure the data script is loaded first.");
            showError("エラー：エンティティデータの読み込みに失敗しました。");
             return;
        }
        console.log('[HTMLEntityApp V1] Entity maps found.');
        const encodeMap = window.htmlEntityMaps.encodeMap;
        const decodeMap = window.htmlEntityMaps.decodeMap;

        // --- 輔助函數 ---
        const showError = (message) => {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            console.warn('[HTMLEntityApp V1] Error displayed:', message);
        };
        const clearError = () => {
            errorMessage.style.display = 'none';
        };

        // --- 核心功能函數 ---
        const encodeEntities = () => {
            clearError();
            const inputText = inputTextArea.value;
            let outputText = '';
            try {
                for (let i = 0; i < inputText.length; i++) {
                    const char = inputText[i];
                    // 優先使用命名實體
                    if (encodeMap.hasOwnProperty(char)) {
                        outputText += encodeMap[char];
                    } else {
                        // V1 版本：不在 map 中的字符保持原樣
                        outputText += char;
                        // --- [未來擴展點] ---
                        // 如果需要將非 ASCII 字符強制轉為數字實體:
                        // const code = char.codePointAt(0); // 使用 codePointAt 支持 > 0xFFFF 的字符
                        // if (code > 127) { // 僅轉換非 ASCII
                        //     outputText += `&#${code};`;
                        // } else {
                        //     outputText += char; // ASCII 範圍內且不在 map 中的保持原樣
                        // }
                        // --- [擴展點結束] ---
                    }
                }
                outputTextArea.value = outputText;
                console.log('[HTMLEntityApp V1] Encoding complete.');
            } catch (error) {
                 console.error("[HTMLEntityApp V1] Error during encoding:", error);
                 showError("エンコード中にエラーが発生しました。");
            }
        };

        const decodeEntities = () => {
            clearError();
            const inputText = inputTextArea.value;
            try {
                const decodedText = inputText.replace(/&(#?[\w\d]+);/g, (match, entityBody) => {
                    if (entityBody.startsWith('#')) {
                        // 數字實體
                        const isHex = entityBody.startsWith('#x') || entityBody.startsWith('#X');
                        const codeStr = isHex ? entityBody.substring(2) : entityBody.substring(1);
                        const radix = isHex ? 16 : 10;
                        const code = parseInt(codeStr, radix);
                        
                        if (!isNaN(code)) {
                             // 使用 fromCodePoint 支持更廣泛的 Unicode
                            try {
                                return String.fromCodePoint(code);
                            } catch (e) {
                                // 如果 codePoint 無效 (例如超出範圍)
                                console.warn(`[HTMLEntityApp V1] Invalid code point in numeric entity: ${match}`);
                                return match; // 返回原始實體
                            }
                        } else {
                            console.warn(`[HTMLEntityApp V1] Failed to parse numeric entity: ${match}`);
                            return match; // 解析失敗，返回原始實體
                        }
                    } else {
                        // 命名實體
                        if (decodeMap.hasOwnProperty(match)) { // 直接用 match (&...;) 作為 key
                            return decodeMap[match];
                        } else {
                            console.warn(`[HTMLEntityApp V1] Unknown named entity: ${match}`);
                            return match; // 未知實體，返回原始字符串
                        }
                    }
                });
                outputTextArea.value = decodedText;
                console.log('[HTMLEntityApp V1] Decoding complete.');
            } catch (error) {
                console.error("[HTMLEntityApp V1] Error during decoding:", error);
                showError("デコード中にエラーが発生しました。");
            }
        };

        const clearInput = () => {
             inputTextArea.value = '';
             clearError();
             console.log('[HTMLEntityApp V1] Input cleared.');
        };
        
        const clearOutput = () => {
             outputTextArea.value = '';
             clearError();
             console.log('[HTMLEntityApp V1] Output cleared.');
        };

        const copyOutput = () => {
            if (!navigator.clipboard) {
                 showError("お使いのブラウザはクリップボード機能に対応していません。");
                 return;
            }
             if (outputTextArea.value === '') {
                 // 如果沒有內容，可以給個提示，或者不做任何事
                 // showError("コピーする内容がありません。"); 
                 return; 
             }
            navigator.clipboard.writeText(outputTextArea.value)
                .then(() => {
                    // 可選：顯示一個短暫的成功提示
                    const originalText = copyOutputBtn.textContent;
                    copyOutputBtn.textContent = 'コピーしました！';
                    setTimeout(() => {
                        copyOutputBtn.textContent = originalText;
                    }, 1500);
                    console.log('[HTMLEntityApp V1] Output copied to clipboard.');
                })
                .catch(err => {
                    console.error('[HTMLEntityApp V1] Failed to copy text: ', err);
                    showError("クリップボードへのコピーに失敗しました。");
                });
        };

        // --- 事件綁定 ---
        encodeBtn.addEventListener('click', encodeEntities);
        decodeBtn.addEventListener('click', decodeEntities);
        clearInputBtn.addEventListener('click', clearInput);
        clearOutputBtn.addEventListener('click', clearOutput);
        copyOutputBtn.addEventListener('click', copyOutput);

        console.log('[HTMLEntityApp V1] Event listeners attached.'); // 診斷

        // --- 輸入時清除錯誤 ---
        inputTextArea.addEventListener('input', clearError);


    })(); // 結束 IIFE
}); // 結束 DOMContentLoaded
</script>
