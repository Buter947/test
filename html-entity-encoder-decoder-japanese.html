<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLエンティティ エンコーダー/デコーダー</title> <style>
        /* --- Core Styles (Japanese Version: het-jp-) --- */
        /* Basic body styling for standalone page */
        body {
             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
             line-height: 1.6 !important;
             color: #333 !important;
             background-color: #f8fafc !important; /* Light gray background for the page */
             margin: 0;
             padding: 1rem;
         }
        
        #html-entity-tool-jp-v1 { /* New ID */
            font-family: inherit !important;
            line-height: inherit !important;
            color: inherit !important;
         }
         #html-entity-tool-jp-v1 .het-jp-card {
             background-color: #ffffff !important;
             padding: 1.5rem 2rem !important;
             border-radius: 0.75rem !important;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
             border: 1px solid #e5e7eb !important;
             max-width: 700px; 
             margin: 2rem auto !important;
         }
         #html-entity-tool-jp-v1 h2 {
             color: #B45309 !important;
             font-size: 1.75rem !important;
             font-weight: 700 !important;
             margin-top: 0 !important;
             margin-bottom: 0.5rem !important;
             text-align: center !important;
         }
         #html-entity-tool-jp-v1 .het-jp-subtitle {
             text-align: center !important;
             color: #4b5563 !important;
             margin-bottom: 2rem !important;
             font-size: 1rem; /* Added font size */
         }
         #html-entity-tool-jp-v1 .het-jp-converter-body {
             display: grid;
             grid-template-columns: 1fr;
             gap: 1rem;
             align-items: center;
         }
          @media (min-width: 640px) {
              #html-entity-tool-jp-v1 .het-jp-converter-body {
                  grid-template-columns: 1fr auto 1fr; 
                  gap: 0.5rem;
              }
         }
         
         #html-entity-tool-jp-v1 .het-jp-textarea-group label {
             display: block !important;
             margin-bottom: 0.5rem !important;
             font-weight: 600 !important;
             color: #374151 !important;
             font-size: 0.9rem !important;
         }
         #html-entity-tool-jp-v1 textarea {
             width: 100% !important;
             min-height: 180px !important;
             border: 1px solid #d1d5db !important;
             border-radius: 0.5rem !important;
             padding: 0.75rem 1rem !important;
             font-family: "Courier New", Courier, monospace !important;
             font-size: 0.9rem !important;
             line-height: 1.5 !important;
             resize: vertical !important;
             box-sizing: border-box !important;
             color: #1f2937 !important; /* Added text color */
             background-color: #fff !important; /* Added background color */
         }
         #html-entity-tool-jp-v1 textarea:focus {
             outline: none !important;
             border-color: #0284c7 !important;
             box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.2) !important;
         }

         #html-entity-tool-jp-v1 .het-jp-button-group {
             display: flex;
             flex-direction: row;
             gap: 0.75rem !important;
             justify-content: center;
             align-items: center;
             margin: 0.5rem 0;
         }
          @media (min-width: 640px) {
              #html-entity-tool-jp-v1 .het-jp-button-group {
                  flex-direction: column; 
              }
         }
         
         #html-entity-tool-jp-v1 .het-jp-button-group button {
             padding: 0.6rem 1rem !important;
             border-radius: 0.5rem !important;
             font-size: 0.9rem !important;
             font-weight: 600 !important;
             border: none !important;
             cursor: pointer !important;
             transition: background-color 0.2s, transform 0.1s !important;
             background-color: #0284c7 !important; /* Blue */
             color: #ffffff !important;
             min-width: 110px;
             text-align: center; /* Ensure text is centered */
         }
         #html-entity-tool-jp-v1 .het-jp-button-group button:hover { background-color: #0369a1 !important; }
         #html-entity-tool-jp-v1 .het-jp-button-group button:active { transform: scale(0.98) !important; }

         #html-entity-tool-jp-v1 .het-jp-utility-buttons {
              display: flex;
              gap: 0.75rem;
              margin-top: 1rem;
              justify-content: space-between;
         }
         #html-entity-tool-jp-v1 .het-jp-utility-buttons button {
              padding: 0.5rem 1rem !important;
              font-size: 0.85rem !important;
              background-color: #6b7280 !important; /* Gray */
              color: #ffffff !important;
              border: none;
              border-radius: 0.5rem;
              cursor: pointer;
              transition: background-color 0.2s, transform 0.1s !important; /* Added transition */
         }
          #html-entity-tool-jp-v1 .het-jp-utility-buttons button:hover { background-color: #4b5563 !important; }
          #html-entity-tool-jp-v1 .het-jp-utility-buttons button:active { transform: scale(0.98) !important; } /* Added active state */


         #html-entity-tool-jp-v1 #het-jp-message-area { /* New ID */
             font-size: 0.9rem;
             font-weight: 500;
             text-align: center;
             min-height: 1.5em; /* Reserve space */
             margin-top: 0.5rem;
             color: #16a34a; /* Default success color */
         }
         #html-entity-tool-jp-v1 #het-jp-message-area.error { color: #ef4444 !important; }
         
         /* Reference Section */
         #html-entity-tool-jp-v1 .het-jp-reference-section {
              margin-top: 2rem;
              padding-top: 1.5rem;
              border-top: 1px solid #eee;
         }
         #html-entity-tool-jp-v1 .het-jp-reference-section h3 {
              font-size: 1.2rem; color: #1e293b; margin-top: 0; margin-bottom: 1rem; text-align: center;
         }
         #html-entity-tool-jp-v1 #het-jp-search-bar { /* New ID */
              width: 100%;
              padding: 0.75rem 1rem !important;
              border: 1px solid #d1d5db !important;
              border-radius: 0.5rem !important;
              font-size: 1rem !important;
              margin-bottom: 1rem;
              box-sizing: border-box;
         }
         #html-entity-tool-jp-v1 .het-jp-table-container {
              max-height: 400px;
              overflow-y: auto;
              border: 1px solid #e5e7eb;
              border-radius: 0.5rem;
         }
         #html-entity-tool-jp-v1 table {
              width: 100% !important;
              border-collapse: collapse !important;
              font-size: 0.9rem;
         }
         #html-entity-tool-jp-v1 th, 
         #html-entity-tool-jp-v1 td {
              border-bottom: 1px solid #e5e7eb !important;
              padding: 0.75rem !important;
              text-align: left !important;
              line-height: 1.4 !important;
         }
         #html-entity-tool-jp-v1 th {
              background-color: #f9fafb !important;
              font-weight: 600 !important;
              color: #374151 !important;
              position: sticky; 
              top: 0;
              z-index: 1;
         }
         #html-entity-tool-jp-v1 td:nth-child(1) { text-align: center !important; font-size: 1.2rem; }
         #html-entity-tool-jp-v1 td:nth-child(2),
         #html-entity-tool-jp-v1 td:nth-child(3) {
              font-family: "Courier New", Courier, monospace !important;
              color: #B45309; 
              font-weight: 600;
              word-break: break-all;
         }
    </style>
</head>
<body>

<div id="html-entity-tool-jp-v1"> <div class="het-jp-card"> <h2>HTMLエンティティ 変換</h2> <p class="het-jp-subtitle">テキストをHTMLエンティティに、またはエンティティをテキストに簡単に変換します。</p> <div class="het-jp-converter-body">
            <div class="het-jp-textarea-group">
                <label for="het-jp-input-text">テキスト (デコード済み)</label> <textarea id="het-jp-input-text" placeholder="ここにテキストやコードを入力... 例: <p>こんにちは</p>"></textarea> </div>
            
            <div class="het-jp-button-group">
                <button id="het-jp-encode-btn" title="テキストをエンティティにエンコード">エンコード &gt;</button> <button id="het-jp-decode-btn" title="エンティティをテキストにデコード">&lt; デコード</button> </div>

            <div class="het-jp-textarea-group">
                 <label for="het-jp-output-entities">HTMLエンティティ (エンコード済み)</label> <textarea id="het-jp-output-entities" placeholder="エンコード結果... 例: &lt;p&gt;こんにちは&lt;/p&gt;" readonly></textarea> </div>
        </div>

        <div class="het-jp-utility-buttons">
              <button id="het-jp-clear-btn" title="両方のテキストボックスをクリア">すべてクリア</button> <button id="het-jp-copy-btn" title="エンコード結果をクリップボードにコピー" style="margin-left: auto;">結果をコピー</button> </div>

        <div id="het-jp-message-area"></div> <div class="het-jp-reference-section">
              <h3>クイックリファレンス</h3> <input type="text" id="het-jp-search-bar" placeholder="文字、名前、コードで検索 (例: 'copy' or '&lt;')"> <div class="het-jp-table-container">
                  <table id="het-jp-reference-table"> <thead>
                           <tr>
                               <th>文字</th> <th>名前付きエンティティ</th> <th>数字コード</th> </tr>
                       </thead>
                       <tbody id="het-jp-table-body"> </tbody>
                  </table>
              </div>
        </div>

    </div>
</div>

<script>
console.log("HET JP V1: Script starting."); // Log in English for easier debugging if needed
document.addEventListener('DOMContentLoaded', function() {
    console.log("HET JP V1: DOMContentLoaded.");
    
    // Slight delay remains for potential stability, can be removed if not needed on GitHub
    setTimeout(initializeConverterJapanese, 150); 

    function initializeConverterJapanese() {
        console.log("HET JP V1: Initializing app...");
        const container = document.getElementById('html-entity-tool-jp-v1'); // New ID
        if (!container) { console.error("HET JP V1: Container not found."); return; }

        // --- Elements (Using new IDs) ---
        const inputArea = container.querySelector('#het-jp-input-text');
        const outputArea = container.querySelector('#het-jp-output-entities');
        const encodeBtn = container.querySelector('#het-jp-encode-btn');
        const decodeBtn = container.querySelector('#het-jp-decode-btn');
        const copyBtn = container.querySelector('#het-jp-copy-btn');
        const clearBtn = container.querySelector('#het-jp-clear-btn');
        const searchBar = container.querySelector('#het-jp-search-bar');
        const tableBody = container.querySelector('#het-jp-table-body');
        const messageArea = container.querySelector('#het-jp-message-area');

        if (!inputArea || !outputArea || !encodeBtn || !decodeBtn || !copyBtn || !clearBtn || !searchBar || !tableBody || !messageArea) {
             console.error("HET JP V1: One or more UI elements are missing!");
             container.innerHTML = "<p style='color:red; text-align:center;'>エラー: UIコンポーネントの読み込みに失敗しました。</p>"; // Japanese Error
             return;
        }
        console.log("HET JP V1: All UI elements found.");

        // --- The Database (Same as English version) ---
        const entityDatabase = [
             { char: '<', name: '&lt;', num: '&#60;' }, { char: '>', name: '&gt;', num: '&#62;' },
             { char: '&', name: '&amp;', num: '&#38;' }, { char: '"', name: '&quot;', num: '&#34;' },
             { char: "'", name: '&apos;', num: '&#39;' }, { char: ' ', name: '&nbsp;', num: '&#160;' },
             { char: '¡', name: '&iexcl;', num: '&#161;' }, { char: '¿', name: '&iquest;', num: '&#191;' },
             { char: '–', name: '&ndash;', num: '&#8211;' }, { char: '—', name: '&mdash;', num: '&#8212;' },
             { char: '‘', name: '&lsquo;', num: '&#8216;' }, { char: '’', name: '&rsquo;', num: '&#8217;' },
             { char: '‚', name: '&sbquo;', num: '&#8218;' }, { char: '“', name: '&ldquo;', num: '&#8220;' },
             { char: '”', name: '&rdquo;', num: '&#8221;' }, { char: '„', name: '&bdquo;', num: '&#8222;' },
             { char: '«', name: '&laquo;', num: '&#171;' }, { char: '»', name: '&raquo;', num: '&#187;' },
             { char: '‹', name: '&lsaquo;', num: '&#8249;' }, { char: '›', name: '&rsaquo;', num: '&#8250;' },
             { char: '…', name: '&hellip;', num: '&#8230;' }, { char: '•', name: '&bull;', num: '&#8226;' },
             { char: '§', name: '&sect;', num: '&#167;' }, { char: '¶', name: '&para;', num: '&#182;' },
             { char: '©', name: '&copy;', num: '&#169;' }, { char: '®', name: '&reg;', num: '&#174;' },
             { char: '™', name: '&trade;', num: '&#8482;' }, { char: '€', name: '&euro;', num: '&#8364;' },
             { char: '£', name: '&pound;', num: '&#163;' }, { char: '¥', name: '&yen;', num: '&#165;' },
             { char: '¢', name: '&cent;', num: '&#162;' }, { char: '¤', name: '&curren;', num: '&#164;' },
             { char: '¦', name: '&brvbar;', num: '&#166;' }, { char: '°', name: '&deg;', num: '&#176;' },
             { char: '±', name: '&plusmn;', num: '&#177;' }, { char: '×', name: '&times;', num: '&#215;' },
             { char: '÷', name: '&divide;', num: '&#247;' }, { char: 'µ', name: '&micro;', num: '&#181;' },
             { char: '¹', name: '&sup1;', num: '&#185;' }, { char: '²', name: '&sup2;', num: '&#178;' },
             { char: '³', name: '&sup3;', num: '&#179;' }, { char: '¼', name: '&frac14;', num: '&#188;' },
             { char: '½', name: '&frac12;', num: '&#189;' }, { char: '¾', name: '&frac34;', num: '&#190;' },
             { char: 'ƒ', name: '&fnof;', num: '&#402;' }, { char: '≈', name: '&asymp;', num: '&#8776;' },
             { char: '≠', name: '&ne;', num: '&#8800;' }, { char: '≤', name: '&le;', num: '&#8804;' },
             { char: '≥', name: '&ge;', num: '&#8805;' }, { char: '√', name: '&radic;', num: '&#8730;' },
             { char: '∞', name: '&infin;', num: '&#8734;' }, { char: '∫', name: '&int;', num: '&#8747;' },
             { char: '∑', name: '&sum;', num: '&#8721;' }, { char: '∏', name: '&prod;', num: '&#8719;' },
             { char: '∂', name: '&part;', num: '&#8706;' }, { char: '∀', name: '&forall;', num: '&#8704;' },
             { char: '∃', name: '&exist;', num: '&#8707;' }, { char: '∅', name: '&empty;', num: '&#8709;' },
             { char: '∇', name: '&nabla;', num: '&#8711;' }, { char: '∈', name: '&isin;', num: '&#8712;' },
             { char: '∉', name: '&notin;', num: '&#8713;' }, { char: '∋', name: '&ni;', num: '&#8715;' },
             { char: '∠', name: '&ang;', num: '&#8736;' }, { char: '←', name: '&larr;', num: '&#8592;' },
             { char: '↑', name: '&uarr;', num: '&#8593;' }, { char: '→', name: '&rarr;', num: '&#8594;' },
             { char: '↓', name: '&darr;', num: '&#8595;' }, { char: '↔', name: '&harr;', num: '&#8596;' },
             { char: '⇐', name: '&lArr;', num: '&#8656;' }, { char: '⇑', name: '&uArr;', num: '&#8657;' },
             { char: '⇒', name: '&rArr;', num: '&#8658;' }, { char: '⇓', name: '&dArr;', num: '&#8659;' },
             { char: '⇔', name: '&hArr;', num: '&#8660;' }, { char: '♠', name: '&spades;', num: '&#9824;' },
             { char: '♣', name: '&clubs;', num: '&#9827;' }, { char: '♥', name: '&hearts;', num: '&#9829;' },
             { char: '♦', name: '&diams;', num: '&#9830;' }, { char: '\u2002', name: '&ensp;', num: '&#8194;' },
             { char: '\u2003', name: '&emsp;', num: '&#8195;' }, { char: '\u2009', name: '&thinsp;', num: '&#8201;' },
             { char: '\u200C', name: '&zwnj;', num: '&#8204;' }, { char: '\u200D', name: '&zwj;', num: '&#8205;' },
             { char: '\u200E', name: '&lrm;', num: '&#8206;' }, { char: '\u200F', name: '&rlm;', num: '&#8207;' },
             { char: 'Α', name: '&Alpha;', num: '&#913;' }, { char: 'Β', name: '&Beta;', num: '&#914;' },
             { char: 'Γ', name: '&Gamma;', num: '&#915;' }, { char: 'Δ', name: '&Delta;', num: '&#916;' },
             { char: 'Ε', name: '&Epsilon;', num: '&#917;' }, { char: 'Ζ', name: '&Zeta;', num: '&#918;' },
             { char: 'Η', name: '&Eta;', num: '&#919;' }, { char: 'Θ', name: '&Theta;', num: '&#920;' },
             { char: 'Ι', name: '&Iota;', num: '&#921;' }, { char: 'Κ', name: '&Kappa;', num: '&#922;' },
             { char: 'Λ', name: '&Lambda;', num: '&#923;' }, { char: 'Μ', name: '&Mu;', num: '&#924;' },
             { char: 'Ν', name: '&Nu;', num: '&#925;' }, { char: 'Ξ', name: '&Xi;', num: '&#926;' },
             { char: 'Ο', name: '&Omicron;', num: '&#927;' }, { char: 'Π', name: '&Pi;', num: '&#928;' },
             { char: 'Ρ', name: '&Rho;', num: '&#929;' }, { char: 'Σ', name: '&Sigma;', num: '&#931;' },
             { char: 'Τ', name: '&Tau;', num: '&#932;' }, { char: 'Υ', name: '&Upsilon;', num: '&#933;' },
             { char: 'Φ', name: '&Phi;', num: '&#934;' }, { char: 'Χ', name: '&Chi;', num: '&#935;' },
             { char: 'Ψ', name: '&Psi;', num: '&#936;' }, { char: 'Ω', name: '&Omega;', num: '&#937;' },
             { char: 'α', name: '&alpha;', num: '&#945;' }, { char: 'β', name: '&beta;', num: '&#946;' },
             { char: 'γ', name: '&gamma;', num: '&#947;' }, { char: 'δ', name: '&delta;', num: '&#948;' },
             { char: 'ε', name: '&epsilon;', num: '&#949;' }, { char: 'ζ', name: '&zeta;', num: '&#950;' },
             { char: 'η', name: '&eta;', num: '&#951;' }, { char: 'θ', name: '&theta;', num: '&#952;' },
             { char: 'ι', name: '&iota;', num: '&#953;' }, { char: 'κ', name: '&kappa;', num: '&#954;' },
             { char: 'λ', name: '&lambda;', num: '&#955;' }, { char: 'μ', name: '&mu;', num: '&#956;' },
             { char: 'ν', name: '&nu;', num: '&#957;' }, { char: 'ξ', name: '&xi;', num: '&#958;' },
             { char: 'ο', name: '&omicron;', num: '&#959;' }, { char: 'π', name: '&pi;', num: '&#960;' },
             { char: 'ρ', name: '&rho;', num: '&#961;' }, { char: 'ς', name: '&sigmaf;', num: '&#962;' },
             { char: 'σ', name: '&sigma;', num: '&#963;' }, { char: 'τ', name: '&tau;', num: '&#964;' },
             { char: 'υ', name: '&upsilon;', num: '&#965;' }, { char: 'φ', name: '&phi;', num: '&#966;' },
             { char: 'χ', name: '&chi;', num: '&#967;' }, { char: 'ψ', name: '&psi;', num: '&#968;' },
             { char: 'ω', name: '&omega;', num: '&#969;' }, { char: '¨', name: '&uml;', num: '&#168;' },
             { char: 'ª', name: '&ordf;', num: '&#170;' }, { char: '¬', name: '&not;', num: '&#172;' },
             { char: '­', name: '&shy;', num: '&#173;' }, { char: '¯', name: '&macr;', num: '&#175;' },
             { char: '´', name: '&acute;', num: '&#180;' }, { char: '·', name: '&middot;', num: '&#183;' },
             { char: '¸', name: '&cedil;', num: '&#184;' }, { char: 'º', name: '&ordm;', num: '&#186;' },
             { char: 'À', name: '&Agrave;', num: '&#192;' }, { char: 'Á', name: '&Aacute;', num: '&#193;' },
             { char: 'Â', name: '&Acirc;', num: '&#194;' }, { char: 'Ã', name: '&Atilde;', num: '&#195;' },
             { char: 'Ä', name: '&Auml;', num: '&#196;' }, { char: 'Å', name: '&Aring;', num: '&#197;' },
             { char: 'Æ', name: '&AElig;', num: '&#198;' }, { char: 'Ç', name: '&Ccedil;', num: '&#199;' },
             { char: 'È', name: '&Egrave;', num: '&#200;' }, { char: 'É', name: '&Eacute;', num: '&#201;' },
             { char: 'Ê', name: '&Ecirc;', num: '&#202;' }, { char: 'Ë', name: '&Euml;', num: '&#203;' },
             { char: 'Ì', name: '&Igrave;', num: '&#204;' }, { char: 'Í', name: '&Iacute;', num: '&#205;' },
             { char: 'Î', name: '&Icirc;', num: '&#206;' }, { char: 'Ï', name: '&Iuml;', num: '&#207;' },
             { char: 'Ð', name: '&ETH;', num: '&#208;' }, { char: 'Ñ', name: '&Ntilde;', num: '&#209;' },
             { char: 'Ò', name: '&Ograve;', num: '&#210;' }, { char: 'Ó', name: '&Oacute;', num: '&#211;' },
             { char: 'Ô', name: '&Ocirc;', num: '&#212;' }, { char: 'Õ', name: '&Otilde;', num: '&#213;' },
             { char: 'Ö', name: '&Ouml;', num: '&#214;' }, { char: 'Ø', name: '&Oslash;', num: '&#216;' },
             { char: 'Ù', name: '&Ugrave;', num: '&#217;' }, { char: 'Ú', name: '&Uacute;', num: '&#218;' },
             { char: 'Û', name: '&Ucirc;', num: '&#219;' }, { char: 'Ü', name: '&Uuml;', num: '&#220;' },
             { char: 'Ý', name: '&Yacute;', num: '&#221;' }, { char: 'Þ', name: '&THORN;', num: '&#222;' },
             { char: 'ß', name: '&szlig;', num: '&#223;' }, { char: 'à', name: '&agrave;', num: '&#224;' },
             { char: 'á', name: '&aacute;', num: '&#225;' }, { char: 'â', name: '&acirc;', num: '&#226;' },
             { char: 'ã', name: '&atilde;', num: '&#227;' }, { char: 'ä', name: '&auml;', num: '&#228;' },
             { char: 'å', name: '&aring;', num: '&#229;' }, { char: 'æ', name: '&aelig;', num: '&#230;' },
             { char: 'ç', name: '&ccedil;', num: '&#231;' }, { char: 'è', name: '&egrave;', num: '&#232;' },
             { char: 'é', name: '&eacute;', num: '&#233;' }, { char: 'ê', name: '&ecirc;', num: '&#234;' },
             { char: 'ë', name: '&euml;', num: '&#235;' }, { char: 'ì', name: '&igrave;', num: '&#236;' },
             { char: 'í', name: '&iacute;', num: '&#237;' }, { char: 'î', name: '&icirc;', num: '&#238;' },
             { char: 'ï', name: '&iuml;', num: '&#239;' }, { char: 'ð', name: '&eth;', num: '&#240;' },
             { char: 'ñ', name: '&ntilde;', num: '&#241;' }, { char: 'ò', name: '&ograve;', num: '&#242;' },
             { char: 'ó', name: '&oacute;', num: '&#243;' }, { char: 'ô', name: '&ocirc;', num: '&#244;' },
             { char: 'õ', name: '&otilde;', num: '&#245;' }, { char: 'ö', name: '&ouml;', num: '&#246;' },
             { char: 'ø', name: '&oslash;', num: '&#248;' }, { char: 'ù', name: '&ugrave;', num: '&#249;' },
             { char: 'ú', name: '&uacute;', num: '&#250;' }, { char: 'û', name: '&ucirc;', num: '&#251;' },
             { char: 'ü', name: '&uuml;', num: '&#252;' }, { char: 'ý', name: '&yacute;', num: '&#253;' },
             { char: 'þ', name: '&thorn;', num: '&#254;' }, { char: 'ÿ', name: '&yuml;', num: '&#255;' }
         ];

        // --- Create Lookup Maps ---
        let encodeMap = {}; // char -> name
        let decodeMap = {}; // name -> char
        try {
            entityDatabase.forEach(entity => {
                if (entity.char && entity.name) { // Ensure both char and name exist
                    if (!encodeMap[entity.char] || ['&lt;', '&gt;', '&amp;', '&quot;', '&apos;'].includes(entity.name)) {
                         encodeMap[entity.char] = entity.name;
                    }
                    if (!decodeMap[entity.name]) {
                         decodeMap[entity.name] = entity.char;
                    }
                }
            });
            console.log("HET JP V1: Encode/Decode maps built from database.");
        } catch (e) {
             console.error("HET JP V1: Failed to build lookup maps:", e);
             showMessage("エンティティマップの構築中にエラーが発生しました。", true); // Japanese Error
             return;
        }

        // Build encode regex dynamically
        const encodeRegex = new RegExp(
             Object.keys(encodeMap).map(c => c.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 
             'g'
        );
        console.log("HET JP V1: Encode regex created.");

        // --- Functions ---
        
        // Show message function (Japanese translation)
        function showMessage(message, isError = false, duration = 2500) {
            messageArea.textContent = message;
            messageArea.className = isError ? 'het-jp-message error' : 'het-jp-message'; // New Class
            if (messageArea.timeoutId) { clearTimeout(messageArea.timeoutId); }
            if (message) { // Only set timeout if there is a message
                 messageArea.timeoutId = setTimeout(() => {
                     messageArea.textContent = '';
                     messageArea.className = 'het-jp-message'; // New Class
                 }, duration);
            }
        }

        // Populate reference table (Japanese translation)
        function populateReferenceTable(filter = '') {
            console.log("HET JP V1: Populating table. Filter:", filter);
            try {
                tableBody.innerHTML = ''; 
                const lowerFilter = filter.toLowerCase();
                let rowsAdded = 0;
                
                const filteredData = entityDatabase.filter(entity => 
                    filter === '' ||
                    entity.char.toLowerCase().includes(lowerFilter) ||
                    entity.name.toLowerCase().includes(lowerFilter) ||
                    entity.num.toLowerCase().includes(lowerFilter) ||
                     (entity.name === '&copy;' && 'copyright コピーライト'.includes(lowerFilter)) || // Add Japanese keywords
                     (entity.name === '&reg;' && 'registered 登録商標'.includes(lowerFilter)) ||
                     (entity.name === '&trade;' && 'trademark 商標'.includes(lowerFilter)) ||
                     (entity.name === '&lt;' && 'less than 小なり'.includes(lowerFilter)) ||
                     (entity.name === '&gt;' && 'greater than 大なり'.includes(lowerFilter)) ||
                     (entity.name === '&amp;' && 'ampersand アンパサンド'.includes(lowerFilter)) ||
                     (entity.name.includes('arr') && 'arrow 矢印'.includes(lowerFilter))
                );

                if (filteredData.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 3;
                    cell.textContent = "検索条件に一致するエンティティが見つかりません。"; // Japanese Message
                    cell.style.textAlign = 'center';
                    cell.style.color = '#6b7280';
                } else {
                    filteredData.forEach(entity => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).textContent = entity.char;
                        row.insertCell(1).textContent = entity.name;
                        row.insertCell(2).textContent = entity.num;
                    });
                    rowsAdded = filteredData.length;
                }
                console.log(`HET JP V1: Table populated with ${rowsAdded} rows.`);
            } catch (e) {
                 console.error("HET JP V1: Error populating table:", e);
                 showMessage("リファレンスリストの表示中にエラーが発生しました。", true); // Japanese Error
            }
        }

        // Encode function (Japanese messages)
        function encodeText() {
            console.log("HET JP V1: Encode clicked.");
            try {
                const text = inputArea.value;
                if (text === "") {
                    outputArea.value = "";
                    showMessage("エンコード完了（空）。"); // Japanese Message
                    return;
                }
                
                // Encode using regex and map
                const encoded = text.replace(encodeRegex, (match) => encodeMap[match] || match); // Fallback to match if somehow not in map
                
                outputArea.value = encoded;
                showMessage("テキストが正常にエンコードされました！"); // Japanese Message
            } catch (e) {
                 console.error("HET JP V1: Error during encode:", e);
                 showMessage("エンコード中にエラーが発生しました。", true); // Japanese Error
            }
        }

        // Decode function (Japanese messages)
        function decodeText() {
            console.log("HET JP V1: Decode clicked.");
            try {
                 // Use outputArea value for decoding back to inputArea
                const text = outputArea.value; 
                if (text === "") {
                    inputArea.value = "";
                    showMessage("デコード完了（空）。"); // Japanese Message
                    return;
                }
                
                // Use the robust browser decoding method
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                const decoded = tempDiv.textContent || tempDiv.innerText || "";

                inputArea.value = decoded;
                showMessage("エンティティが正常にデコードされました！"); // Japanese Message
            } catch (e) {
                 console.error("HET JP V1: Error during decode:", e);
                 showMessage("デコード中にエラーが発生しました。", true); // Japanese Error
            }
        }

        // Copy function (Japanese messages)
        function copyOutput() {
            console.log("HET JP V1: Copy clicked.");
            if (outputArea.value === "") {
                showMessage("コピーする内容がありません。", true); // Japanese Message
                return;
            }
            if (!navigator.clipboard) {
                 // Fallback using execCommand (might not work in all contexts, especially secure ones)
                 try {
                      outputArea.select();
                      document.execCommand('copy');
                      showMessage("クリップボードにコピーしました！"); // Japanese Message
                      window.getSelection().removeAllRanges(); // Deselect
                 } catch (e) {
                      console.error("HET JP V1: execCommand copy failed:", e);
                      showMessage("コピーに失敗しました。手動でコピーしてください。", true); // Japanese Error
                 }
                 return;
            }
            // Modern clipboard API
            navigator.clipboard.writeText(outputArea.value)
                .then(() => {
                    showMessage("クリップボードにコピーしました！"); // Japanese Message
                })
                .catch(err => {
                    console.error("HET JP V1: Clipboard API copy failed:", err);
                    showMessage("コピーに失敗しました。ブラウザの設定を確認してください。", true); // Japanese Error
                });
        }

        // Clear function (Japanese messages)
        function clearAll() {
            console.log("HET JP V1: Clear clicked.");
            inputArea.value = "";
            outputArea.value = "";
            showMessage(""); // Clear message
        }

        // --- Initialization ---
        try {
            populateReferenceTable(); // Initial population

            // Attach listeners
            encodeBtn.addEventListener('click', encodeText);
            decodeBtn.addEventListener('click', decodeText);
            copyBtn.addEventListener('click', copyOutput);
            clearBtn.addEventListener('click', clearAll);
            searchBar.addEventListener('input', (e) => {
                populateReferenceTable(e.target.value);
            });
            // Clear message on input
            inputArea.addEventListener('input', () => showMessage('')); 
            outputArea.addEventListener('input', () => showMessage('')); 


            console.log("HET JP V1: Listeners attached.");
        } catch (e) {
             console.error("HET JP V1: Error during init listeners:", e);
             showMessage("コントロールの初期化に失敗しました。", true); // Japanese Error
        }
        
        console.log("HET JP V1: Initialization complete.");
    }
}); // End DOMContentLoaded
</script>

</body>
</html>
