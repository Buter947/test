<div id="jhs-kanji-quiz-v1">
    <style>
        /* --- CSS 樣式 (與 V3.6 完全相同) --- */
        #jhs-kanji-quiz-v1 {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
            line-height: 1.6 !important;
            background-color: #f9fafb !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.75rem !important;
            padding: 2rem !important;
            margin: 2rem auto !important;
            max-width: 700px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05) !important;
            overflow: hidden;
        }
        #jhs-kanji-quiz-v1 *, 
        #jhs-kanji-quiz-v1 *::before, 
        #jhs-kanji-quiz-v1 *::after {
            box-sizing: border-box !important;
        }
        #jhs-kanji-quiz-v1 .jhs-kq-screen { display: none; animation: fadeInJhsKqV1 0.3s ease-in-out !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-screen.active { display: block !important; }
         @keyframes fadeInJhsKqV1 { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #jhs-kanji-quiz-v1 h2 { color: #059669 !important; text-align: center !important; font-size: 2rem !important; font-weight: 700 !important; margin-top: 0 !important; margin-bottom: 0.5rem !important; }
        #jhs-kanji-quiz-v1 h3 { text-align: center !important; font-size: 1.5rem !important; font-weight: 700 !important; margin-top: 0 !important; margin-bottom: 1.5rem !important; color: #1f2937 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-subtitle { text-align: center !important; font-size: 1.1rem !important; color: #4b5563 !important; margin: 0 auto 2rem auto !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-main-btn { display: block !important; width: 100% !important; max-width: 300px !important; margin: 2rem auto 0 auto !important; padding: 1rem !important; font-size: 1.25rem !important; font-weight: 700 !important; color: #ffffff !important; background-color: #059669 !important; border: none !important; border-radius: 0.5rem !important; cursor: pointer !important; transition: background-color 0.2s, transform 0.1s !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-main-btn:hover { background-color: #047857 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-main-btn:active { transform: scale(0.98) !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-level-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 1rem !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-level-btn { width: 100% !important; padding: 1.5rem 0.5rem !important; font-size: 1.1rem !important; font-weight: 600 !important; color: #374151 !important; background-color: #ffffff !important; border: 1px solid #d1d5db !important; border-radius: 0.5rem !important; cursor: pointer !important; transition: all 0.2s ease !important; text-align: center; display: flex !important; flex-direction: column !important; justify-content: center !important; align-items: center !important; min-height: 100px !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-level-btn:hover { border-color: #059669 !important; color: #059669 !important; transform: translateY(-2px) !important; box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-level-btn small { font-size: 0.8rem; color: #6b7280; display: block; font-weight: 400; margin-top: 0.25rem; }
        #jhs-kanji-quiz-v1 .jhs-kq-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: #4a5568; font-weight: 600; }
        #jhs-kanji-quiz-v1 .jhs-kq-counter { font-size: 1rem; font-weight: 600; color: #6b7280; }
        #jhs-kanji-quiz-v1 .jhs-kq-question-display { font-size: 4.5rem !important; font-weight: 700 !important; color: #111827 !important; text-align: center; background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 2.5rem 1.5rem; margin-bottom: 2rem; min-height: 200px; display: flex; justify-content: center; align-items: center; font-family: 'Kyokasho', 'Yu Mincho', 'Hiragino Mincho ProN', serif !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-options-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 1rem !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-option-btn { width: 100% !important; padding: 1rem !important; font-size: 1.25rem !important; font-weight: 600 !important; color: #374151 !important; background-color: #ffffff !important; border: 1px solid #d1d5db !important; border-radius: 0.5rem !important; cursor: pointer !important; transition: all 0.2s ease !important; text-align: center; min-height: 80px; display: flex; justify-content: center; align-items: center; }
        #jhs-kanji-quiz-v1 .jhs-kq-option-btn:not(:disabled):hover { border-color: #059669 !important; color: #059669 !important; transform: translateY(-2px) !important; box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        #jhs-kanji-quiz-v1 .jhs-kq-option-btn.correct { background-color: #dcfce7 !important; border-color: #16a34a !important; color: #15803d !important; font-weight: 700 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-option-btn.wrong { background-color: #fee2e2 !important; border-color: #dc2626 !important; color: #b91c1c !important; opacity: 1 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-feedback-box { display: none; background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-top: 1.5rem; text-align: center; animation: fadeInJhsKqV1 0.3s ease-in-out !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-feedback-text { font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; }
        #jhs-kanji-quiz-v1 .jhs-kq-feedback-text.correct { color: #16a34a; }
        #jhs-kanji-quiz-v1 .jhs-kq-feedback-text.wrong { color: #dc2626; }
        #jhs-kanji-quiz-v1 .jhs-kq-answer-reveal { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        #jhs-kanji-quiz-v1 .jhs-kq-next-btn { display: none; width: 100%; background-color: #0284c7 !important; margin: 1.5rem auto 0 auto; max-width: 300px; }
        #jhs-kanji-quiz-v1 .jhs-kq-next-btn:hover { background-color: #0369a1 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-score-display { font-size: 1.5rem; font-weight: 600; color: #1f2937; text-align: center; }
        #jhs-kanji-quiz-v1 .jhs-kq-score-display .score { font-size: 3rem; font-weight: 700; color: #059669; display: block; margin: 0.5rem 0; }
        #jhs-kanji-quiz-v1 .jhs-kq-controls-box { display: flex; flex-direction: column; gap: 1rem; max-width: 300px; margin: 2rem auto 0 auto; }
        #jhs-kanji-quiz-v1 .jhs-kq-controls-box .jhs-kq-main-btn { margin-top: 0 !important; background-color: #059669 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-controls-box .jhs-kq-main-btn:hover { background-color: #047857 !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-controls-box .jhs-kq-secondary-btn { background-color: #ffffff !important; color: #374151 !important; border: 1px solid #d1d5db !important; }
        #jhs-kanji-quiz-v1 .jhs-kq-controls-box .jhs-kq-secondary-btn:hover { background-color: #f9fafb !important; }
        @media (max-width: 600px) { #jhs-kanji-quiz-v1 { padding: 1.5rem !important; margin: 1rem auto !important; } #jhs-kanji-quiz-v1 h2 { font-size: 1.75rem !important; } #jhs-kanji-quiz-v1 .jhs-kq-question-display { font-size: 3.5rem !important; } }
        @media (max-width: 480px) { #jhs-kanji-quiz-v1 .jhs-kq-options-grid { grid-template-columns: 1fr !important; } #jhs-kanji-quiz-v1 .jhs-kq-level-grid { grid-template-columns: 1fr 1fr !important; } }
    </style>

    <div class="jhs-kq-card">
        <div id="jhs-kq-screen-start" class="jhs-kq-screen active"> /* ... */ </div>
        <div id="jhs-kq-screen-quiz" class="jhs-kq-screen"> /* ... */ </div>
        <div id="jhs-kq-screen-end" class="jhs-kq-screen"> /* ... */ </div>
         <div class="jhs-kq-card">
            
            <div id="jhs-kq-screen-start" class="jhs-kq-screen active">
                <h2>中学生漢字クイズ</h2>
                <p class="jhs-kq-subtitle">挑戦する学年を選んでください。</p>
                <div id="jhs-kq-level-grid" class="jhs-kq-level-grid">
                    </div>
            </div>

            <div id="jhs-kq-screen-quiz" class="jhs-kq-screen">
                <div class="jhs-kq-header">
                     <span id="jhs-kq-question-counter" class="jhs-kq-counter"></span>
                     <span id="jhs-kq-score-counter" class="jhs-kq-counter"></span>
                </div>
                <div id="jhs-kq-question-display" class="jhs-kq-question-display"></div>
                <div id="jhs-kq-options-grid" class="jhs-kq-options-grid"></div>
                
                <button id="jhs-kq-next-btn" class="jhs-kq-main-btn jhs-kq-next-btn">次の問題へ</button>
                <div id="jhs-kq-feedback-box" class="jhs-kq-feedback-box">
                     <h3 id="jhs-kq-feedback-text" class="jhs-kq-feedback-text"></h3>
                     <div id="jhs-kq-answer-reveal" class="jhs-kq-answer-reveal"></div>
                </div>
            </div>

            <div id="jhs-kq-screen-end" class="jhs-kq-screen">
                <h3>お疲れ様でした！</h3>
                <div class="jhs-kq-score-display">
                    あなたのスコア:
                    <span id="jhs-kq-final-score" class="score">10問中 0問</span>
                    正解
                </div>
                <div id="jhs-kq-controls-box" class="jhs-kq-controls-box">
                    <button id="jhs-kq-restart-btn" class="jhs-kq-main-btn">もう一度挑戦する</button>
                    <button id="jhs-kq-menu-btn" class="jhs-kq-main-btn jhs-kq-secondary-btn">学年選択に戻る</button>
                </div>
            </div>
        </div>

    </div>

<script>
// 規範 1.3 & 1.6：使用 DOMContentLoaded 和 IIFE
document.addEventListener('DOMContentLoaded', function() {
    (function() {

        /**
         * JhsKanjiQuiz (中学生漢字クイズ) V1.3 (Expanded common_errors)
         */
        const JhsKanjiQuiz = {
            // --- 1. 數據庫 ---
            // ==========================================================
            //   極重要警告 / VERY IMPORTANT WARNING:
            //   g7, g8, g9 的數據仍為 AI 生成填充，*必須* 由用戶核對修正！
            //   common_errors 數據基於用戶提供的圖片，但仍建議最終校對。
            // ==========================================================
            quizData: {
                'g7': { // 中學1年生 (317 字)
                    name: '中学1年生<small>(全 317 字)</small>', 
                    data: [ /* ... (省略 V3.6 的 AI 填充數據，假設用戶會替換) ... */ 
                        {q:'瞬',a:'しゅん'}, {q:'雰',a:'ふん'}, {q:'扱',a:'あつかう'}, {q:'諮',a:'はかる'}, {q:'択',a:'えらぶ'}, {q:'屈',a:'くつ'}, {q:'郊',a:'こう'}, {q:'析',a:'せき'}, {q:'徴',a:'ちょう'}, {q:'聴',a:'きく'}, {q:'脅',a:'おびやかす'}, {q:'肝',a:'きも'}, {q:'謙',a:'けん'}, {q:'召',a:'めす'}, {q:'伺',a:'うかがう'}, {q:'暫',a:'ざん'}, {q:'宜',a:'ぎ'}, {q:'徹',a:'てつ'}, {q:'頻',a:'ひん'}, {q:'衷',a:'ちゅう'}
                        // ... 請在此處填入完整的 317 個 G7 漢字 ...
                    ]
                },
                'g8': { // 中學2年生 (399 字)
                    name: '中学2年生<small>(全 399 字)</small>', 
                    data: [ /* ... (省略 V3.6 的 AI 填充數據，假設用戶會替換) ... */ 
                        {q:'劾',a:'がい'}, {q:'斎',a:'さい'}, {q:'粛',a:'しゅく'}, {q:'彰',a:'しょう'}, {q:'庸',a:'よう'}, {q:'罷',a:'ひ'}, {q:'摯',a:'し'}, {q:'隙',a:'すき'}, {q:'稚',a:'ち'}, {q:'辱',a:'はずかしめる'}, {q:'蜜',a:'みつ'}, {q:'嚇',a:'かく'}, {q:'寡',a:'か'}, {q:'矯',a:'ためる'}, {q:'堪',a:'たえる'}, {q:'煎',a:'せんじる'}, {q:'諾',a:'だく'}, {q:'轄',a:'かつ'}, {q:'且',a:'かつ'}, {q:'悼',a:'いたむ'}
                         // ... 請在此處填入完整的 399 個 G8 漢字 ...
                    ]
                },
                'g9': { // 中學3年生 (394 字)
                    name: '中学3年生<small>(全 394 字)</small>', 
                    data: [ /* ... (省略 V3.6 的 AI 填充數據，假設用戶會替換) ... */ 
                        {q:'藍',a:'あい'}, {q:'鬱',a:'うつ'}, {q:'彙',a:'い'}, {q:'岐',a:'き'}, {q:'睦',a:'むつ'}, {q:'宛',a:'あてる'}, {q:'籠',a:'かご'}, {q:'麓',a:'ふもと'}, {q:'襲',a:'おそう'}, {q:'猶',a:'なお'}, {q:'諧',a:'かい'}, {q:'璽',a:'じ'}, {q:'箋',a:'せん'}, {q:'挫',a:'ざ'}, {q:'僅',a:'わずか'}, {q:'謄',a:'とう'}, {q:'楷',a:'かい'}, {q:'遡',a:'さかのぼる'}, {q:'遜',a:'へりくだる'}, {q:'謎',a:'なぞ'}
                         // ... 請在此處填入完整的 394 個 G9 漢字 ...
                    ]
                },
                // [V3.7 更新] 擴充常見錯誤數據 (基於用戶圖片)
                'common_errors': {
                    name: 'よくある間違い<small>(読み方中心)</small>',
                    data: [
                        // --- 從圖片 "読み練習問題" 提取 (請校對！) ---
                        {q:'柔軟', a:'じゅうなん'}, 
                        {q:'建立', a:'こんりゅう'}, // 注意: けんりつ も一般的だが資料に合わせる
                        {q:'克服', a:'こくふく'}, 
                        {q:'背丈', a:'せたけ'}, 
                        {q:'戸惑い', a:'とまどい'}, 
                        {q:'幾重', a:'いくえ'}, 
                        {q:'見据え', a:'みすえ'}, 
                        {q:'扱う', a:'あつかう'}, 
                        {q:'柄', a:'がら'}, // 文脈依存あり
                        {q:'乏しい', a:'とぼしい'}, 
                        {q:'柔和', a:'にゅうわ'}, 
                        // {q:'建立', a:'こんりゅう'}, // 重複例
                        {q:'営む', a:'いとなむ'}, // 資料は「営ん」-> いとなん
                        {q:'膨らむ', a:'ふくらむ'}, 
                        {q:'鋭敏', a:'えいびん'}, 
                        {q:'導く', a:'みちびく'}, 
                        {q:'詳細', a:'しょうさい'}, 
                        {q:'頻繁', a:'ひんぱん'}, 
                        {q:'無駄', a:'むだ'}, 
                        {q:'上昇', a:'じょうしょう'}, 
                        {q:'敵陣', a:'てきじん'}, 
                        {q:'吟味', a:'ぎんみ'}, 
                        {q:'退屈', a:'たいくつ'}, 
                        {q:'些細', a:'ささい'}, 
                        {q:'随所', a:'ずいしょ'}, 
                        {q:'優れる', a:'すぐれる'}, // 資料は「優れ」-> すぐれ
                        {q:'到達', a:'とうたつ'}, 
                        {q:'羽化', a:'うか'}, 
                        {q:'薄める', a:'うすめる'}, 
                        {q:'漂う', a:'ただよう'}, 
                        {q:'擬態語', a:'ぎたいご'}, // 資料は「擬態語」だが読みは不明瞭
                        {q:'精神', a:'せいしん'}, 
                        {q:'縁起', a:'えんぎ'}, 
                        {q:'戸惑う', a:'とまどう'}, // 資料は「戸惑って」-> とまどって
                        {q:'秩序', a:'ちつじょ'}, 
                        {q:'排斥', a:'はいせき'}, 
                        {q:'隆盛', a:'りゅうせい'}, 
                        // {q:'退屈', a:'たいくつ'}, // 重複例
                        {q:'企てる', a:'くわだてる'}, 
                        {q:'海苔', a:'のり'}, 
                        {q:'難攻不落', a:'なんこうふらく'}, 
                        {q:'包囲', a:'ほうい'}, 
                        {q:'象徴', a:'しょうちょう'}, 
                        {q:'依頼', a:'いらい'}, 
                        {q:'河川', a:'かせん'}, 
                        {q:'営み', a:'いとなみ'}, 
                        {q:'戸外', a:'こがい'}, 
                        {q:'鮮やか', a:'あざやか'}, 
                        {q:'著しい', a:'いちじるしい'}, // 資料は「著しく」-> いちじるしく
                        {q:'維持', a:'いじ'},
                        // --- 補充 V3.4/3.5 的常見錯誤 ---
                        {q:'雰囲気',a:'ふんいき'}, {q:'挨拶',a:'あいさつ'}, {q:'続柄',a:'つづきがら'}, 
                        {q:'辛辣',a:'しんらつ'}, {q:'脆弱',a:'ぜいじゃく'}, {q:'貼付',a:'ちょうふ'}, 
                        {q:'消耗',a:'しょうもう'}, {q:'重複',a:'ちょうふく'}, 
                        {q:'凡例',a:'はんれい'}, {q:'代替',a:'だいたい'}, {q:'発足',a:'ほっそく'}, 
                        {q:'有無',a:'うむ'}, {q:'一段落',a:'いちだんらく'}, 
                        {q:'依存',a:'いぞん'}, {q:'月極',a:'つきぎめ'},
                        {q:'他人事', a:'ひとごと'}, {q:'相殺', a:'そうさい'}, {q:'出生', a:'しゅっしょう'}, 
                        {q:'早急', a:'さっきゅう'}, {q:'白熱',a:'はくねつ'}
                        // --- 可以根據需要繼續添加 ---
                    ] 
                }
            },

            // --- 2. 遊戲狀態 --- (不變)
            state: { /* ... */ },

            // --- 3. DOM 元素 --- (不變)
            elements: {},

            // --- 4. 初始化 --- (不變)
            init: function() { /* ... */ },

            // --- 5. 事件綁定 --- (不變)
            bindEvents: function() { /* ... */ },

            // --- 6. 核心功能 --- (不變)
            showScreen: function(screenName) { /* ... */ },
            populateGradeButtons: function() { /* ... */ },
            shuffleArray: function(array) { /* ... */ },
            startGame: function(gradeId) { /* ... */ },
            displayQuestion: function() { /* ... */ },
            checkAnswer: function(selectedBtn) { /* ... */ },
            nextQuestion: function() { /* ... */ },
            showEndScreen: function() { /* ... */ }

            // [為簡潔起見，此處省略與 V3.6 版本完全相同的函數實現細節]
            // 您可以從 V3.6 的程式碼中複製 showScreen 到 showEndScreen 的完整函數體
             , state: {
                currentGradeData: [],
                currentQuestions: [],
                score: 0,
                currentQuestionIndex: 0,
                currentGradeId: 'g7', 
                QUESTIONS_PER_GAME: 10 // 每次遊戲的問題數量
            },
             elements: {},
             init: function() {
                const app = document.getElementById('jhs-kanji-quiz-v1');
                if (!app) {
                    console.error("JHS-KQ V1: 頂層容器 #jhs-kanji-quiz-v1 未找到。");
                    return;
                }
                this.elements = {
                    app: app,
                    screens: {
                        start: app.querySelector('#jhs-kq-screen-start'),
                        quiz: app.querySelector('#jhs-kq-screen-quiz'),
                        end: app.querySelector('#jhs-kq-screen-end')
                    },
                    levelGrid: app.querySelector('#jhs-kq-level-grid'), 
                    questionCounter: app.querySelector('#jhs-kq-question-counter'),
                    scoreCounter: app.querySelector('#jhs-kq-score-counter'),
                    questionDisplay: app.querySelector('#jhs-kq-question-display'),
                    optionsGrid: app.querySelector('#jhs-kq-options-grid'),
                    nextBtn: app.querySelector('#jhs-kq-next-btn'),
                    feedbackBox: app.querySelector('#jhs-kq-feedback-box'),
                    feedbackText: app.querySelector('#jhs-kq-feedback-text'),
                    answerReveal: app.querySelector('#jhs-kq-answer-reveal'),
                    finalScore: app.querySelector('#jhs-kq-final-score'),
                    restartBtn: app.querySelector('#jhs-kq-restart-btn'),
                    menuBtn: app.querySelector('#jhs-kq-menu-btn')
                };

                if (!this.elements.levelGrid) {
                     console.error("JHS-KQ V1: 學年按鈕容器 #jhs-kq-level-grid 未找到，無法啟動。");
                     if (app) {
                         app.innerHTML = '<p style="color: red; text-align: center;">エラー: UIコンポーネントの読み込みに失敗しました (level grid missing)。</p>';
                     }
                     return;
                }
                
                this.bindEvents();
                this.populateGradeButtons(); 
            },
             bindEvents: function() {
                 if (this.elements.levelGrid) {
                    this.elements.levelGrid.addEventListener('click', (e) => {
                        const levelBtn = e.target.closest('.jhs-kq-level-btn');
                        if (levelBtn && levelBtn.dataset.grade) { 
                            this.startGame(levelBtn.dataset.grade);
                        }
                    });
                }
                if (this.elements.optionsGrid) {
                    this.elements.optionsGrid.addEventListener('click', (e) => {
                        const optionBtn = e.target.closest('.jhs-kq-option-btn');
                        if (optionBtn && !optionBtn.disabled) {
                            this.checkAnswer(optionBtn);
                        }
                    });
                }
                if (this.elements.nextBtn) {
                    this.elements.nextBtn.addEventListener('click', () => this.nextQuestion());
                }
                if (this.elements.restartBtn) {
                    this.elements.restartBtn.addEventListener('click', () => this.startGame(this.state.currentGradeId)); 
                }
                if (this.elements.menuBtn) {
                    this.elements.menuBtn.addEventListener('click', () => this.showScreen('start'));
                }
            },
             showScreen: function(screenName) {
                if (!this.elements.screens || !this.elements.screens[screenName]) {
                    console.error(`JHS-KQ V1: 嘗試顯示不存在的畫面: ${screenName}`);
                    return;
                }
                for (let key in this.elements.screens) {
                    if (this.elements.screens[key]) { 
                        this.elements.screens[key].classList.remove('active');
                    }
                }
                this.elements.screens[screenName].classList.add('active');
            },
            populateGradeButtons: function() {
                if (!this.elements.levelGrid) {
                    console.error("JHS-KQ V1: populateGradeButtons - levelGrid 元素不存在。");
                    return;
                }
                this.elements.levelGrid.innerHTML = '';
                for (const [gradeId, gradeInfo] of Object.entries(this.quizData)) {
                    const btn = document.createElement('button');
                    btn.className = 'jhs-kq-level-btn';
                    btn.dataset.grade = gradeId; 
                    btn.innerHTML = gradeInfo.name; 
                    this.elements.levelGrid.appendChild(btn);
                }
            },
             shuffleArray: function(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex > 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            },
            startGame: function(gradeId) {
                if (!this.quizData[gradeId] || !this.quizData[gradeId].data || this.quizData[gradeId].data.length === 0) {
                    console.error(`JHS-KQ V1: 找不到 ${gradeId} 的數據或數據為空。`);
                     this.showScreen('start'); 
                    return;
                }
                 if (!this.elements.screens.quiz || !this.elements.questionDisplay || !this.elements.optionsGrid) {
                     console.error("JHS-KQ V1: 測驗畫面元素不完整，無法開始遊戲。");
                     this.showScreen('start'); 
                     return;
                 }

                this.state.currentGradeId = gradeId; 
                this.state.currentGradeData = this.quizData[gradeId].data; 
                this.state.score = 0;
                this.state.currentQuestionIndex = 0;
                
                // 重置/獲取每次遊戲的問題數量
                const originalQuestionsPerGame = 10; // 預設值
                let currentDataLength = this.state.currentGradeData.length;
                this.state.QUESTIONS_PER_GAME = Math.min(originalQuestionsPerGame, currentDataLength); // 如果數據不足10, 則只測現有的數量


                // 準備問題 
                 let questionsPool = [...this.state.currentGradeData];
                 // 如果數據少於所需問題數，允許重複 
                 while (questionsPool.length < this.state.QUESTIONS_PER_GAME && questionsPool.length > 0 && currentDataLength > 0) {
                     // 為了避免無限循環，只重複一次原始數據
                     if (questionsPool.length <= currentDataLength * 2) {
                          questionsPool.push(...this.state.currentGradeData);
                     } else {
                         break; 
                     }
                 }
                 
                 // 如果 questionsPool 仍然為空 (理論上不會發生，因為前面有檢查)
                 if (questionsPool.length === 0) {
                      console.error(`JHS-KQ V1: ${gradeId} 數據庫為空，無法開始遊戲。`);
                      this.showScreen('start');
                      return;
                 }


                this.state.currentQuestions = this.shuffleArray(questionsPool).slice(0, this.state.QUESTIONS_PER_GAME); // 使用更新後的數量
                
                // 再次檢查是否有題目生成
                if(this.state.currentQuestions.length === 0){
                     console.error(`JHS-KQ V1: 未能為 ${gradeId} 生成任何題目。`);
                     this.showScreen('start');
                     return;
                }

                this.showScreen('quiz');
                this.displayQuestion();
            },
             displayQuestion: function() {
                 if (!this.elements.feedbackBox || !this.elements.nextBtn || !this.elements.questionCounter || !this.elements.scoreCounter || !this.elements.questionDisplay || !this.elements.optionsGrid) {
                     console.error("JHS-KQ V1: displayQuestion - 缺少必要的 UI 元素。");
                     return;
                 }
                this.elements.feedbackBox.style.display = 'none';
                this.elements.nextBtn.style.display = 'none';
                
                // 確保索引有效
                if(this.state.currentQuestionIndex >= this.state.currentQuestions.length){
                    console.error("JHS-KQ V1: displayQuestion - 無效的問題索引。");
                    this.showEndScreen(); 
                    return;
                }

                const q = this.state.currentQuestions[this.state.currentQuestionIndex];
                
                 if(!q || !q.q || typeof q.a === 'undefined'){ // 檢查 q.a 是否存在 (允許空字串但不允許 undefined)
                      console.error("JHS-KQ V1: displayQuestion - 當前問題數據無效。", q);
                      this.nextQuestion(); 
                      return;
                 }


                this.elements.questionCounter.textContent = `問題 ${this.state.currentQuestionIndex + 1} / ${this.state.QUESTIONS_PER_GAME}`;
                this.elements.scoreCounter.textContent = `スコア: ${this.state.score}`;
                this.elements.questionDisplay.textContent = q.q;
                
                const correctAnswer = q.a;
                let fakes = [];
                
                let allJhsKanji = [];
                 Object.values(this.quizData).forEach(grade => {
                     if (grade && grade.data && Array.isArray(grade.data)) {
                         allJhsKanji.push(...grade.data);
                     }
                 });
                 
                if(allJhsKanji.length === 0){
                    console.error("JHS-KQ V1: displayQuestion - 無法獲取任何漢字數據來生成 fake 選項。");
                    fakes = ['ダミー1', 'ダミー2', 'ダミー3']; 
                } else {
                     // 確保 item 和 item.a 存在
                    const fakePool = allJhsKanji.filter(item => item && typeof item.a !== 'undefined' && item.a !== correctAnswer); 
                    this.shuffleArray(fakePool);
                    fakes = fakePool.slice(0, 3).map(item => item.a); // item.a 已經在 filter 確保存在

                     // 確保 fake 選項有 3 個
                     const defaultFakeSource = (this.quizData['g7']?.data || []).filter(item => item && typeof item.a !== 'undefined' && item.a !== correctAnswer); 
                     this.shuffleArray(defaultFakeSource);
                     let fakeIndex = 0;
                     while(fakes.length < 3 && fakeIndex < defaultFakeSource.length){
                         const fakeReading = defaultFakeSource[fakeIndex]?.a;
                          // 確保 fakeReading 存在且不重複
                         if(typeof fakeReading !== 'undefined' && !fakes.includes(fakeReading)){ 
                             fakes.push(fakeReading);
                         }
                         fakeIndex++;
                     }
                     while(fakes.length < 3){
                           // 提供一個更可靠的備用假答案
                          const backupFake = defaultFakeSource[0]?.a ?? ('ダミー' + (fakes.length + 1)); 
                          // 避免將 correctAnswer 加入 fakes
                          if (backupFake !== correctAnswer && !fakes.includes(backupFake)) {
                               fakes.push(backupFake);
                          } else {
                               // 如果連備用都重複或等於答案，生成一個真正隨機的假名串（雖然不太理想）
                               fakes.push('ダミー' + Math.random().toString(36).substring(7));
                          }
                     }
                }
                
                // 再次確保 fakes 陣列長度為 3
                 fakes = fakes.slice(0, 3);
                 while(fakes.length < 3) {
                     fakes.push('予備' + (fakes.length + 1)); // 添加備用假選項
                 }


                const options = this.shuffleArray([correctAnswer, ...fakes]);

                this.elements.optionsGrid.innerHTML = '';
                options.forEach(optionText => {
                    const btn = document.createElement('button');
                    btn.className = 'jhs-kq-option-btn';
                     // 確保 optionText 不是 undefined 或 null
                    btn.textContent = (typeof optionText !== 'undefined' && optionText !== null) ? optionText : '---'; 
                    btn.dataset.answer = (typeof optionText !== 'undefined' && optionText !== null) ? optionText : 'invalid';
                    this.elements.optionsGrid.appendChild(btn);
                });
            },
            checkAnswer: function(selectedBtn) {
                 if (!this.elements.optionsGrid || !this.elements.answerReveal || !this.elements.feedbackBox || !this.elements.feedbackText || !this.elements.scoreCounter || !this.elements.nextBtn) {
                     console.error("JHS-KQ V1: checkAnswer - 缺少必要的 UI 元素。");
                     return;
                 }
                 if(this.state.currentQuestionIndex >= this.state.currentQuestions.length){
                     console.error("JHS-KQ V1: checkAnswer - 無效的問題索引。");
                     return;
                 }

                this.elements.optionsGrid.querySelectorAll('.jhs-kq-option-btn').forEach(btn => {
                    btn.disabled = true;
                });
                const selectedAnswer = selectedBtn.dataset.answer;
                const q = this.state.currentQuestions[this.state.currentQuestionIndex];
                
                 if(!q || !q.q || typeof q.a === 'undefined'){
                      console.error("JHS-KQ V1: checkAnswer - 當前問題數據無效。", q);
                      this.elements.nextBtn.style.display = 'block'; 
                      this.elements.nextBtn.textContent = (this.state.currentQuestionIndex < this.state.QUESTIONS_PER_GAME - 1) ? '次の問題へ' : '結果を見る';
                      return;
                 }

                const correctAnswer = q.a;
                this.elements.answerReveal.textContent = `正解： ${q.q} ( ${q.a} )`;
                this.elements.feedbackBox.style.display = 'block';
                if (selectedAnswer === correctAnswer) {
                    this.state.score++;
                    selectedBtn.classList.add('correct');
                    this.elements.feedbackText.textContent = '正解！';
                    this.elements.feedbackText.className = 'jhs-kq-feedback-text correct';
                } else {
                    selectedBtn.classList.add('wrong');
                    const correctBtn = this.elements.optionsGrid.querySelector(`[data-answer="${correctAnswer}"]`);
                    if (correctBtn) {
                        correctBtn.classList.add('correct');
                    }
                    this.elements.feedbackText.textContent = '不正解...';
                    this.elements.feedbackText.className = 'jhs-kq-feedback-text wrong';
                }
                this.elements.scoreCounter.textContent = `スコア: ${this.state.score}`;
                if (this.state.currentQuestionIndex < this.state.QUESTIONS_PER_GAME - 1) {
                    this.elements.nextBtn.textContent = '次の問題へ';
                } else {
                    this.elements.nextBtn.textContent = '結果を見る';
                }
                this.elements.nextBtn.style.display = 'block';
            },
            nextQuestion: function() {
                this.state.currentQuestionIndex++;
                if (this.state.currentQuestionIndex < this.state.QUESTIONS_PER_GAME) { 
                    this.displayQuestion();
                } else {
                    this.showEndScreen();
                }
            },
            showEndScreen: function() {
                 if (!this.elements.finalScore || !this.elements.screens.end) {
                     console.error("JHS-KQ V1: showEndScreen - 缺少必要的 UI 元素。");
                     return;
                 }
                this.elements.finalScore.textContent = `${this.state.QUESTIONS_PER_GAME}問中 ${this.state.score}問`; 
                this.showScreen('end');
            }


        };

        // 初始化
        JhsKanjiQuiz.init();

    })(); // 結束 IIFE
}); // 結束 DOMContentLoaded
</script>
