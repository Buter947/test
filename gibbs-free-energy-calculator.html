<div id="gibbs-free-energy-calculator-app">
  
  <h3>Gibbs Free Energy Calculator (ΔG)</h3>
  
  <div class="gfe-input-group">
    <label for="gfe-delta-h">Enthalpy Change (ΔH)</label>
    <div class="gfe-input-wrapper">
      <input type="text" class="gfe-input" id="gfe-delta-h" placeholder="Enter ΔH value...">
      <select class="gfe-unit-select" id="gfe-unit-h">
        <option value="kJ/mol" selected>kJ/mol</option>
        <option value="J/mol">J/mol</option>
        <option value="kcal/mol">kcal/mol</option> 
      </select>
    </div>
  </div>
  
  <div class="gfe-input-group">
    <label for="gfe-temperature">Temperature (T)</label>
     <div class="gfe-input-wrapper">
      <input type="text" class="gfe-input" id="gfe-temperature" placeholder="Enter Temperature...">
       <select class="gfe-unit-select" id="gfe-unit-t">
        <option value="K">K</option> 
        <option value="C" selected>°C</option> 
        <option value="F">°F</option>
      </select>
    </div>
     <small class="gfe-unit-note">Temperature must be in Kelvin for calculation (auto-converted).</small>
  </div>
  
  <div class="gfe-input-group">
    <label for="gfe-delta-s">Entropy Change (ΔS)</label>
    <div class="gfe-input-wrapper">
      <input type="text" class="gfe-input" id="gfe-delta-s" placeholder="Enter ΔS value...">
      <select class="gfe-unit-select" id="gfe-unit-s">
        <option value="J/mol·K" selected>J/mol·K</option>
        <option value="kJ/mol·K">kJ/mol·K</option>
         <option value="kcal/mol·K">kcal/mol·K</option>
      </select>
    </div>
     <small class="gfe-unit-note">Ensure energy units of ΔH and ΔS are compatible (e.g., kJ and J).</small>
  </div>
 
   <div id="gfe-message-area" class="gfe-message"></div>

  <div class="gfe-result-group">
    <label for="gfe-result-dg">Gibbs Free Energy Change (ΔG)</label>
     <div class="gfe-input-wrapper gfe-output-wrapper">
      <input type="text" id="gfe-result-dg" placeholder="---" readonly>
      <select class="gfe-unit-select" id="gfe-unit-g-out">
         <option value="kJ/mol" selected>kJ/mol</option>
         <option value="J/mol">J/mol</option>
          <option value="kcal/mol">kcal/mol</option> 
      </select>
    </div>
     <div id="gfe-spontaneity-result" class="gfe-spontaneity">---</div>
  </div>

</div>

<style>
/* --- 
   Gibbs Free Energy Calculator 樣式表 (全新 App ID)
   核心規範: 所有規則均以 #gibbs-free-energy-calculator-app 為前缀
   核心規範: 大量使用 !important 確保覆蓋主題樣式
--- */

#gibbs-free-energy-calculator-app {
  background: #ffffff !important;
  border: 1px solid #e2e8f0 !important;
  border-radius: 10px !important;
  padding: 24px !important;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
  max-width: 500px !important; 
  margin: 25px auto !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif !important;
  box-sizing: border-box !important;
}

#gibbs-free-energy-calculator-app *,
#gibbs-free-energy-calculator-app *::before,
#gibbs-free-energy-calculator-app *::after {
  box-sizing: inherit !important;
}

/* 標題樣式 */
#gibbs-free-energy-calculator-app h3 {
  color: #B45309 !important;
  font-size: 24px !important;
  font-weight: 700 !important;
  margin-top: 0 !important;
  margin-bottom: 24px !important;
  text-align: center !important;
  line-height: 1.3 !important;
}

/* 輸入群組 */
#gibbs-free-energy-calculator-app .gfe-input-group {
  margin-bottom: 18px !important;
}

#gibbs-free-energy-calculator-app label {
  display: block !important;
  font-size: 15px !important;
  font-weight: 600 !important;
  color: #334155 !important;
  margin-bottom: 8px !important;
}

/* 輸入框容器 (輸入框 + 單位) */
#gibbs-free-energy-calculator-app .gfe-input-wrapper {
  display: flex !important;
  align-items: center !important;
  border: 1px solid #cbd5e1 !important;
  border-radius: 8px !important;
  background-color: #f8fafc !important;
  transition: border-color 0.2s, box-shadow 0.2s !important;
}
#gibbs-free-energy-calculator-app .gfe-input-wrapper:focus-within {
  border-color: #0284c7 !important;
  box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15) !important;
}

/* 文字輸入框 (用於接受科學記號) */
#gibbs-free-energy-calculator-app input.gfe-input {
  flex-grow: 1 !important;
  width: 100% !important; 
  padding: 10px 12px !important;
  font-size: 16px !important;
  font-family: 'Courier New', Courier, monospace !important; /* Monospace */
  font-weight: 600 !important;
  color: #0f172a !important;
  border: none !important;
  background: transparent !important;
  box-shadow: none !important;
  outline: none !important;
  margin: 0 !important;
  border-radius: 8px 0 0 8px !important; /* Round left */
}

/* 單位選擇框 */
#gibbs-free-energy-calculator-app select.gfe-unit-select {
  padding: 10px 12px !important;
  font-size: 13px !important; /* Slightly smaller unit font */
  font-family: inherit !important;
  font-weight: 500 !important;
  color: #475569 !important;
  background-color: #eef2f6 !important; /* Slightly different bg */
  border: none !important;
  border-left: 1px solid #cbd5e1 !important;
  border-radius: 0 7px 7px 0 !important; /* Round right */
  margin: 0 !important;
  box-shadow: none !important;
  outline: none !important;
  cursor: pointer !important;
  appearance: none !important; 
  -webkit-appearance: none !important;
  padding-right: 30px !important; /* Space for arrow */
  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20fill%3D%22none%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20stroke%3D%22%2364748b%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221.5%22%20d%3D%22m6%208%204%204%204-4%22%2F%3E%3C%2Fsvg%3E') !important;
  background-repeat: no-repeat !important;
  background-position: right 8px center !important;
  background-size: 14px 14px !important;
  height: 100% !important; 
  align-self: stretch !important;
  min-width: 90px; /* Wider unit box */
}

/* 單位提示 */
#gibbs-free-energy-calculator-app .gfe-unit-note {
  display: block !important;
  font-size: 12px !important;
  color: #64748b !important;
  margin-top: 6px !important;
  padding-left: 2px !important;
}

/* 訊息區域 */
#gibbs-free-energy-calculator-app .gfe-message {
  font-size: 14px !important;
  font-weight: 500 !important;
  padding: 6px 4px 0 4px !important;
  min-height: 1.4em !important; /* Placeholder */
  color: #dc2626 !important; /* Error red */
  text-align: center !important;
}

/* 結果區域 */
#gibbs-free-energy-calculator-app .gfe-result-group {
  margin-top: 20px !important;
  border-top: 2px dashed #e2e8f0 !important;
  padding-top: 20px !important;
}

/* 唯讀的結果輸出框容器 */
#gibbs-free-energy-calculator-app .gfe-output-wrapper {
   background-color: #f1f5f9 !important;
   border-color: #d1d5db !important;
}
#gibbs-free-energy-calculator-app .gfe-output-wrapper:focus-within {
  border-color: #d1d5db !important; /* Prevent focus ring on output */
  box-shadow: none !important;
}

#gibbs-free-energy-calculator-app #gfe-result-dg[readonly] {
  font-size: 20px !important; /* Larger result */
  font-weight: 700 !important;
  color: #16a34a !important; /* Green result */
  background: transparent !important;
  cursor: default !important;
}

/* 自發性結果顯示 */
#gibbs-free-energy-calculator-app #gfe-spontaneity-result {
  font-size: 16px !important;
  font-weight: 600 !important;
  text-align: center !important;
  margin-top: 12px !important;
  padding: 10px !important;
  border-radius: 6px !important;
}
/* Style based on spontaneity */
#gibbs-free-energy-calculator-app #gfe-spontaneity-result.spontaneous {
  color: #15803d !important; /* Dark Green */
  background-color: #dcfce7 !important; /* Light Green */
}
#gibbs-free-energy-calculator-app #gfe-spontaneity-result.non-spontaneous {
  color: #b91c1c !important; /* Dark Red */
  background-color: #fee2e2 !important; /* Light Red */
}
#gibbs-free-energy-calculator-app #gfe-spontaneity-result.equilibrium {
  color: #475569 !important; /* Gray */
  background-color: #f1f5f9 !important; /* Light Gray */
}

</style>

<script>
// Core Spec: IIFE
(function() {

  /**
   * App Main Execution
   */
  function initializeGibbsCalc() {
  
    // --- Constants ---
    const J_PER_KJ = 1000;
    const J_PER_KCAL = 4184; 
    
    // --- Get DOM Elements ---
    const appContainer = document.getElementById('gibbs-free-energy-calculator-app');
    if (!appContainer) return;
    
    const deltaHInput = appContainer.querySelector('#gfe-delta-h');
    const unitH = appContainer.querySelector('#gfe-unit-h');
    const tempInput = appContainer.querySelector('#gfe-temperature');
    const unitT = appContainer.querySelector('#gfe-unit-t');
    const deltaSInput = appContainer.querySelector('#gfe-delta-s');
    const unitS = appContainer.querySelector('#gfe-unit-s');
    const resultDG = appContainer.querySelector('#gfe-result-dg');
    const unitGOut = appContainer.querySelector('#gfe-unit-g-out');
    const spontaneityResult = appContainer.querySelector('#gfe-spontaneity-result');
    const messageArea = appContainer.querySelector('#gfe-message-area');
    
    // Failsafe check
    if (!deltaHInput || !unitH || !tempInput || !unitT || !deltaSInput || !unitS || !resultDG || !unitGOut || !spontaneityResult || !messageArea) {
        console.error('Gibbs Calc: Missing UI elements.');
        return;
    }

    // All elements that trigger calculation
    const triggerElements = [deltaHInput, unitH, tempInput, unitT, deltaSInput, unitS, unitGOut];

    /**
     * Helper: Parse input string (allows scientific notation)
     */
    function parseValue(inputStr) {
        const cleanedStr = inputStr.trim().toLowerCase();
        if (cleanedStr === '') return NaN;
        const value = parseFloat(cleanedStr);
        return (isNaN(value) || !isFinite(value)) ? NaN : value;
    }
    
     /**
     * Helper: Format output value (use scientific notation if needed)
     */
    function formatValue(value) {
        if (isNaN(value)) return '---';
        if (value === 0) return '0';
        // Use scientific notation if magnitude is very large or small, else precision
        if (Math.abs(value) >= 1e6 || (Math.abs(value) < 1e-3 && Math.abs(value) > 0) ) {
            return value.toExponential(3); 
        } else {
            return value.toPrecision(5); 
        }
    }

    /**
     * Helper: Convert energy value to Joules/mol
     */
    function toJoulesPerMol(value, unit) {
        if (isNaN(value)) return NaN;
        switch(unit) {
            case 'kJ/mol': case 'kJ/mol·K': return value * J_PER_KJ;
            case 'kcal/mol': case 'kcal/mol·K': return value * J_PER_KCAL;
            case 'J/mol': case 'J/mol·K': return value;
            default: return NaN; // Should not happen
        }
    }
     /**
     * Helper: Convert Joules/mol to target energy unit
     */
    function fromJoulesPerMol(value, targetUnit) {
        if (isNaN(value)) return NaN;
        switch(targetUnit) {
            case 'kJ/mol': return value / J_PER_KJ;
            case 'kcal/mol': return value / J_PER_KCAL;
            case 'J/mol': return value;
            default: return NaN;
        }
    }

    /**
     * Helper: Convert temperature to Kelvin
     */
    function toKelvin(temp, unit) {
        if (isNaN(temp)) return NaN;
        if (unit === 'C') return temp + 273.15;
        if (unit === 'F') return (temp - 32) * 5/9 + 273.15;
        return temp; // Already Kelvin
    }
    
    /**
     * Core Function: Calculate ΔG and spontaneity
     */
    function calculate() {
        messageArea.textContent = ''; // Clear previous errors
        resultDG.value = '---'; // Clear previous result
        spontaneityResult.textContent = '---';
        spontaneityResult.className = 'gfe-spontaneity'; // Reset class

        try {
            const deltaHValue = parseValue(deltaHInput.value);
            const tempValue = parseValue(tempInput.value);
            const deltaSValue = parseValue(deltaSInput.value);
            
            const unitHVal = unitH.value;
            const unitTVal = unitT.value;
            const unitSVal = unitS.value;
            const unitGOutVal = unitGOut.value;

            // --- Input Validation ---
            if (isNaN(deltaHValue)) {
                if(deltaHInput.value.trim() !== '') messageArea.textContent = 'Invalid ΔH format.'; return;
            }
            if (isNaN(tempValue)) {
                 if(tempInput.value.trim() !== '') messageArea.textContent = 'Invalid Temperature format.'; return;
            }
            if (isNaN(deltaSValue)) {
                if(deltaSInput.value.trim() !== '') messageArea.textContent = 'Invalid ΔS format.'; return;
            }
            
            // Check if all needed inputs are present (even if zero)
            if (deltaHInput.value.trim() === '' || tempInput.value.trim() === '' || deltaSInput.value.trim() === '') {
                 resultDG.value = '---'; 
                 spontaneityResult.textContent = '---';
                 return; // Need all three inputs
            }

            // --- Convert Units to Base for Calculation (J/mol, K, J/mol·K) ---
            const deltaH_J = toJoulesPerMol(deltaHValue, unitHVal);
            const tempK = toKelvin(tempValue, unitTVal);
            const deltaS_J = toJoulesPerMol(deltaSValue, unitSVal);

            // Validate conversions
            if (isNaN(deltaH_J)) { messageArea.textContent = 'Invalid ΔH unit.'; return; }
            if (isNaN(tempK)) { messageArea.textContent = 'Invalid Temperature unit.'; return; }
            if (tempK < 0) { messageArea.textContent = 'Temperature cannot be below absolute zero (0 K).'; return; }
            if (isNaN(deltaS_J)) { messageArea.textContent = 'Invalid ΔS unit.'; return; }


            // --- Calculate ΔG in Joules/mol ---
            // ΔG = ΔH - TΔS
            const deltaG_J = deltaH_J - (tempK * deltaS_J);
            
             if (isNaN(deltaG_J) || !isFinite(deltaG_J)) {
                 messageArea.textContent = 'Calculation resulted in an invalid number.'; return;
             }

            // --- Convert ΔG to Output Unit ---
            const deltaG_out = fromJoulesPerMol(deltaG_J, unitGOutVal);

            // --- Display Result ---
            resultDG.value = formatValue(deltaG_out);

            // --- Determine and Display Spontaneity ---
            const tolerance = 1e-9; // Small tolerance for zero comparison
            if (deltaG_J < -tolerance) {
                spontaneityResult.textContent = 'Reaction is Spontaneous (ΔG < 0)';
                spontaneityResult.className = 'gfe-spontaneity spontaneous';
            } else if (deltaG_J > tolerance) {
                spontaneityResult.textContent = 'Reaction is Non-spontaneous (ΔG > 0)';
                spontaneityResult.className = 'gfe-spontaneity non-spontaneous';
            } else {
                spontaneityResult.textContent = 'Reaction is at Equilibrium (ΔG ≈ 0)';
                spontaneityResult.className = 'gfe-spontaneity equilibrium';
            }

        } catch (e) {
            console.error("Gibbs Calc Error:", e);
            messageArea.textContent = "Calculation error. Check inputs.";
        }
    }

    // --- Attach Event Listeners ---
    triggerElements.forEach(el => {
        el.addEventListener('input', calculate); 
        el.addEventListener('change', calculate); // For selects
    });
    
  } // End initializeGibbsCalc

  
  // --- Robust Startup Logic ---
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGibbsCalc);
  } else {
    initializeGibbsCalc();
  }

})(); // End IIFE
</script>
